<?xml version="1.0"?>
<!DOCTYPE imprimatur PUBLIC 
    "-//Imprimatur DTD 009//EN"
    "http://imprimatur.sourceforge.net/imprimatur-009.dtd">
<imprimatur port="8080" hostname="localhost">
	<!-- Users -->
	<test-group>
		<test name="Manipulating users">
			<request path="/chellow/users/" method="post">
				<credentials username="watkins@example.com" password="alan" />
				<control name="email-address" value="watkins@example.com" />
				<control name="user-role-id" value="1" />
				<control name="password" value="alan" />
				<response-code value="303" />
				<regex pattern="/users/1/" />
			</request>
			<request path="/chellow/users/" method="post">
				<control name="email-address" value="lydgate@localhost" />
				<control name="user-role-id" value="1" />
				<control name="password" value="science" />
				<response-code value="303" />
				<regex pattern="/users/2/" />
			</request>
			<request path="/chellow/users/2/">
				<response-code value="200" />
			</request>
			<!-- Check that a duplicate email gives a proper error message -->
			<request path="/chellow/users/" method="post">
				<control name="email-address" value="lydgate@localhost" />
				<control name="user-role-id" value="1" />
				<control name="password" value="science" />
				<regex pattern="already a user with this email address" />
				<response-code value="418" />
			</request>
			<!-- Test that we're able to change the password -->
			<request path="/chellow/users/2/" method="post">
				<control name="current-password" value="science" />
				<control name="new-password" value="rosamund" />
				<control name="confirm-new-password" value="rosamund" />
				<response-code value="200" />
			</request>
			<!-- Test that we can change the role -->
			<request path="/chellow/users/2/" method="post">
				<control name="email-address" value="mary-ann-evans@example.com" />
				<control name="user-role-id" value="1" />
				<response-code value="200" />
			</request>
			<!-- ...and change it back -->
			<request path="/chellow/users/2/" method="post">
				<control name="email-address" value="lydgate@localhost" />
				<control name="user-role-id" value="1" />
				<response-code value="200" />
			</request>
		</test>
	</test-group>
	<test-group>
		<test name="Check that invalid email address gives unauthorized.">
			<request path="/chellow/supplier-contracts/">
				<credentials username="godel" password="dancer" />
				<response-code value="401" />
			</request>
		</test>
		<test name="Check duplicate report name gives good error message">
			<request path="/chellow/reports/" method="post">
				<credentials username="watkins@example.com" password="alan" />
				<control name="name" value="Home" />
				<response-code value="418" />
				<regex pattern="There's already a report with that name\." />
			</request>
		</test>


		<test name="site">
			<!-- Valid -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="sites.zip" />
				<response-code value="303" />
				<regex pattern="/general-imports/0/" />
			</request>
			<request path="/chellow/general-imports/0/">
				<refresh />
				<response-code value="200" />
				<regex pattern="The file has been imported successfully\." />
			</request>

			<!-- duplicates -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="sites.zip" />
				<response-code value="303" />
				<regex pattern="/general-imports/1/" />
			</request>
			<request path="/chellow/general-imports/1/">
				<refresh />
				<regex
					pattern="Problem saving site, perhaps there's a duplicate code or name\." />
				<response-code value="200" />
			</request>

			<!-- Do a search on sites -->
			<request path="/chellow/sites/2/" method="post">
				<control name="delete" value="Delete" />
				<response-code value="200" />
			</request>
			<request path="/chellow/sites/?search-pattern=y">
				<response-code value="200" />
			</request>

			<!-- Show and and add a site -->
			<request path="/chellow/sites/">

				<regex pattern="Add site" />
				<response-code value="200" />
			</request>
			<request path="/chellow/sites/" method="post">
				<control name="code" value="CH017" />
				<control name="name" value="Parbola" />
				<response-code value="303" />
			</request>
		</test>

		<test name="HHDC contracts">
			<request path="/chellow/hhdc-contracts/" method="post">
				<control name="participant-id" value="56" /> <!-- DASL -->
				<control name="name" value="HH contract" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="has-finished" value="false" />
				<response-code value="303" />
				<regex pattern="/hhdc-contracts/0/" />
			</request>




			<!-- Update Contract -->
			<request path="/chellow/hhdc-contracts/0/" method="post">
				<control name="participant-id" value="56" /> <!-- DASL -->
				<control name="name" value="HH contract" />
				<control name="charge-script"><![CDATA[
def virtual_bill_titles():
    return ['net-gbp']

def virtual_bill(supply_source):
    return {'net-gbp': 0}]]></control>
				<control name="properties" value="" />
				<response-code value="303" />
			</request>
			<request path="/chellow/hhdc-contracts/0/">
				<regex pattern="HH contract" />
				<response-code value="200" />
			</request>

			<!-- Check that we can see the edit view of an HHDC rate script okay -->
			<request path="/chellow/reports/249/output/?rate_script_id=0">
				<!-- Check that 'has_finished' field is there -->
				<regex pattern="has_finished" />
				<response-code value="200" />
			</request>

			<!-- Check that we can update an HHDC rate script okay -->
			<request path="/chellow/reports/249/output/" method="post">
				<control name="rate_script_id" value="0" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="script" value="" />
				<response-code value="303" />
			</request>



			<!-- Add another HHDC contract -->
			<request path="/chellow/hhdc-contracts/" method="post">
				<control name="participant-id" value="56" />
				<control name="name" value="Dynamat data" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<response-code value="303" />
				<regex pattern="/hhdc-contracts/2/" />
			</request>





			<request path="/chellow/hhdc-contracts/2/" method="post">
				<control name="participant-id" value="56" />
				<control name="name" value="Dynamat data" />
				<control name="charge-script"><![CDATA[
def virtual_bill_titles():
    return ['net-gbp']

def virtual_bill(supply_source):
    return {'net-gbp': 0}]]></control>
				<control name="properties" value="properties" />
				<response-code value="303" />
			</request>

			<request path="/chellow/hhdc-contracts/2/" method="post">
				<control name="update-state" value="" />
				<control name="state" value="state" />
				<response-code value="303" />
			</request>
			<!-- after here -->


			<request path="/chellow/hhdc-contracts/2/">
				<response-code value="200" />
				<regex
					pattern='&lt;textarea name="charge-script" rows="40" cols="80"&gt;[\r\n]def virtual_bill_title' />
				<regex
					pattern='&lt;textarea name="properties" rows="40" cols="80"&gt;properties&lt;/textarea&gt;' />
				<regex
					pattern='&lt;textarea name="state" rows="40" cols="80"&gt;state&lt;/textarea&gt;' />
			</request>

			<!-- before here -->

		</test>


		<test name="Check one can update the participant for an HHDC contract.">
			<request path="/chellow/hhdc-contracts/2/" method="post">
				<control name="participant-id" value="301" /> <!-- UKDC -->
				<control name="name" value="Dynamat data" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="has-finished" value="false" />
				<control name="charge-script"><![CDATA[
def virtual_bill_titles():
    return ['net-gbp']

def virtual_bill(supply_source):
    return {'net-gbp': 0}]]></control>
				<control name="properties"></control>
				<response-code value="303" />
			</request>


			<!-- Check it's still there -->
			<request path="/chellow/hhdc-contracts/2/">
				<response-code value="200" />
				<regex pattern='option value="301" selected' />
			</request>
		</test>
		<test name="Manipulate supplier contracts">
			<!-- Check correct fields present for adding a supplier service -->
			<request path="/chellow/supplier-contracts/">
				<regex pattern='name="start-year"' />
				<response-code value="200" />
			</request>

			<!-- Create a new supplier contract -->
			<request path="/chellow/supplier-contracts/" method="post">
				<control name="participant-id" value="40" /> <!-- CGEN -->
				<control name="name" value="Half-hourlies 2007" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />

				<regex pattern="/chellow/supplier-contracts/4/" />
				<response-code value="303" />
			</request>

			<!-- Update the supplier contract -->
			<request path="/chellow/supplier-contracts/4/" method="post">
				<control name="participant-id" value="23" /> <!-- BIZZ -->
				<control name="name" value="Half-hourlies 2007" />
				<control name="charge-script">
				<![CDATA[
def virtual_bill(supply, startDate, finishDate, pw):
    return {'net-gbp': 0.0, 'vat-gbp':0.0, 'gross-gbp': 0.0, 'problem': ''}]]>
				</control>
				<regex pattern='&lt;option value="23" selected&gt;' />
				<response-code value="200" />
			</request>

			<!-- Check that it's displayed properly -->
			<request path="/chellow/supplier-contracts/4/">
				<regex pattern='&lt;option value="23" selected&gt;' />
				<response-code value="200" />
			</request>

			<!-- Update the associated rate script -->
			<request path="/chellow/supplier-contracts/4/rate-scripts/4/"
				method="post">
				<control name="start-year">2000</control>
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="has-finished" value="false" />
				<control name="script"><![CDATA[def gsp_gbp_per_kwh():
    return {
        'winter-pk': 0.0193918,
        'winter-low-pk': 0.0501474,
        'winter-off-pk': 0.0062656,
        'summer-pk': 0.0062656,
        'night': 0.0062656,
        'other': 0.0062656}]]>
				</control>
				<response-code value="200" />
			</request>

		</test>




		<test name="Manipulate non-core contracts">
			<!-- Create a new non-core contract -->
			<request path="/chellow/non-core-contracts/" method="post">
				<control name="participant-id" value="31" /> <!-- CALB -->
				<control name="name" value="VAT" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<regex pattern="/chellow/non-core-contracts/6/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/non-core-contracts/6/" method="post">
				<control name="participant-id" value="286" /> <!-- STCL -->
				<control name="name" value="VAT 2" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="charge-script"><![CDATA[import sys]]>&#13;<![CDATA[
import net.sf.chellow.billing
import net.sf.chellow.monad.ui
import net.sf.chellow.physical

def totalElement(account, startDate, finishDate):
    totalElement = net.sf.chellow.billing.BillElement("total", 22.3, "VAT cost")
    return totalElement]]>
				</control>
				<response-code value="200" />
			</request>
			<request path="/chellow/non-core-contracts/6/">
				<regex pattern="import sys\nimport" />
				<response-code value="200" />
			</request>

			<!-- Delete it -->
			<request path="/chellow/non-core-contracts/6/" method="post">
				<control name="delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Insert MOP contract">
			<request path="/chellow/mop-contracts/" method="post">
				<control name="participant-id" value="198" /> <!-- LENG -->
				<control name="name" value="MOP Contract" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="has-finished" value="false" />
				<response-code value="303" />
				<regex pattern="/mop-contracts/8/" />
			</request>

			<!-- Check we can see the rate scripts -->
			<request path="/chellow/mop-contracts/8/rate-scripts/">
				<response-code value="200" />
			</request>




		</test>



		<test name="supplies">
			<!-- Give proper error if there are too few fields -->

			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="supplies-too-few-fields.csv" />
				<regex pattern="/chellow/general-imports/2/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/general-imports/2/">
				<refresh />
				<regex
					pattern="Another field called Supply Name needs to be added on the end" />
				<response-code value="200" />
			</request>

			<!-- non-existent source code -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="supplies_source.csv" />
				<regex pattern="/chellow/general-imports/3/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/general-imports/3/">
				<refresh />
				<!-- check that it knows that the first line has a source code that is 
					too long -->
				<regex pattern="There's no source with the code 'netlong'" />
				<response-code value="200" />
			</request>

			<!-- Line 2 has a DNO that doesn't exist -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="supplies_dno.csv" />
				<regex pattern="/chellow/general-imports/4/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/general-imports/4/">
				<refresh />
				<!-- check that it knows that line 2 has a DNO that doesn't exist -->
				<regex pattern="There is no DNO with the code '79'" />
				<response-code value="200" />
			</request>

			<!-- Check that it gives a sensible error message if a data is malformed -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="supplies_date.csv" />
				<regex pattern="/chellow/general-imports/5/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/general-imports/5/">
				<refresh />
				<!-- check that it knows that line 1 has a malformed date -->
				<regex pattern="date '2003-08/03' must be of the form" />
				<response-code value="200" />
			</request>

			<!-- Check for a sensible error message if the site doesn't exist -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="supplies_no_site.csv" />
				<regex pattern="/chellow/general-imports/6/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/general-imports/6/">
				<refresh />
				<!-- check that it knows that line 1 has a malformed date -->
				<regex pattern="The site 'zzznozzz' cannot be found\." />
				<response-code value="200" />
			</request>
			<!-- Valid import of supplies -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="supplies.csv" />
				<response-code value="303" />
				<regex pattern="/general-imports/7/" />
			</request>
			<request path="/chellow/general-imports/7/">
				<refresh max="21" />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
			<!-- Check that a supply with only an import MPAN is there -->
			<request path="/chellow/sites/4/">
				<regex pattern="22 6354 2983 570" />
				<response-code value="200" />
			</request>

			<!-- Can we see a site ok? -->

			<request path="/chellow/sites/1/">
				<!-- Is the supply link displayed? -->
				<regex pattern='&lt;a href="/chellow/supplies/3/"&gt;3&lt;/a&gt;' />

				<!-- Does it show the import MPAN? -->
				<regex pattern='22 9813 2107 763' />

				<response-code value="200" />
			</request>

			<!-- Can we search for supplies using MPAN? -->

			<request path="/chellow/supplies/?search-pattern=">
				<response-code value="200" />
			</request>
		</test>
		<!-- Can we see a supply ok? -->
		<test name="view a supply">
			<request path="/chellow/supplies/2/">
				<!-- Check link to generations -->
				<regex pattern='&lt;a href="generations/"&gt;.*Generations.*&lt;/a&gt;' />
				<response-code value="200" />
			</request>
			<request path="/chellow/supplies/2/generations/">
				<!-- Check link to ongoing generation -->
				<regex
					pattern='2&lt;/td&gt;&lt;td&gt;2003-08-03 00:00&lt;/td&gt;&lt;td&gt;.*Ongoing' />
				<response-code value="200" />
			</request>
			<request method="post" path="/chellow/supplies/2/">
				<!-- Can we update a supply name? -->
				<!-- Can we update a supply source? -->
				<control name="name">Hello</control>
				<control name="source-id">4</control>
				<control name="generator-type-id" value="1" />
				<control name="gsp-group-id" value="11" />
				<regex pattern='value="Hello"&gt;' />
				<regex pattern='option value="1" selected&gt;chp&lt;/option&gt;' />
				<response-code value="200" />
			</request>
			<request method="post" path="/chellow/supplies/2/">
				<!-- Change it back. -->
				<control name="name" value="1" />
				<control name="source-id" value="1" />
				<control name="generator-type-id" value="1" />
				<control name="gsp-group-id" value="11" />
				<response-code value="200" />
			</request>
		</test>

		<!-- Can we see a supply generation ok? -->
		<test name="view supply generation">
			<request path="/chellow/supplies/2/generations/2/">
				<!-- Check start date year is there -->
				<regex pattern="start-year" />
				<regex pattern='&lt;option value="0" selected&gt;HH contract&lt;/option&gt;' />
				<regex
					pattern='"import-supplier-contract-id"&gt;&lt;option value="4" selected&gt;Half-hourlies 2007' />

				<!-- Can we see the MOP account? -->
				<regex pattern='"mc-22 9205 6799 106"' />

				<response-code value="200" />
			</request>
			<request path="/chellow/supplies/3/generations/3/">
				<!-- Check site code is correct -->
				<regex pattern='&lt;td&gt;CI004&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Manipulating supply generations">

			<!-- Can we add a new supply generation ok? -->
			<request path="/chellow/supplies/3/generations/" method="post">
				<control name="start-year" value="2006" />
				<control name="start-month" value="07" />
				<control name="start-day" value="20" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />

				<regex pattern="/chellow/supplies/3/generations/9/" />
				<response-code value="303" />
			</request>

			<!-- Let's check it's carried forward the import mpan -->
			<request path="/chellow/supplies/3/generations/9/">
				<regex pattern="22 9813 2107 763" />
				<regex pattern='name="mtc-code" size="3" maxlength="3" value="845"' />
				<response-code value="200" />
			</request>

			<!-- Can we delete the generation ok? -->
			<request path="/chellow/supplies/3/generations/9/?view=confirm-delete">
				<regex pattern="Are you sure you want to delete this" />
				<response-code value="200" />
			</request>

			<!-- When a supply generation is ended, check that the snags are updated -->
			<request path="/chellow/supplies/6/generations/6/" method="post">
				<control name="start-year" value="2003" />
				<control name="start-month" value="08" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="true" />
				<control name="finish-year" value="2003" />
				<control name="finish-month" value="08" />
				<control name="finish-day" value="13" />
				<control name="finish-hour" value="23" />
				<control name="finish-minute" value="30" />
				<control name="gsp-group-id" value="11" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="22 0883 6932 301" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="22 0883 6932 301" />
				<control name="meter-serial-number" value="" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="has-import-mpan" value="true" />
				<control name="import-llfc-code" value="570" />
				<control name="import-mpan-core" value="22 0883 6932 301" />
				<control name="import-agreed-supply-capacity" value="350" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="01" />
				<control name="has-export-mpan" value="false" />
				<response-code value="200" />

				<!-- Check start day is correct -->
				<regex pattern='option value="03" selected&gt;03&lt;/option&gt;' />
				<!-- Check the end date is right -->
				<regex
					pattern='&lt;input type="checkbox" name="is-ended" value="true" checked' />
				<regex pattern='option value="13" selected&gt;13&lt;/option&gt;' />
				<regex pattern='option value="23" selected&gt;23&lt;/option&gt;' />
			</request>
			<!-- Check it's correct in supply view -->
			<request path="/chellow/reports/7/output/?supply-id=6">
				<response-code value="200" />
				<!-- Check the end date is right -->
				<regex pattern='&lt;a title="2003-08-13 23:30"&gt;2003-08-13&lt;/a&gt;' />
			</request>
			<request path="/chellow/supplies/6/generations/6/channels/18/snags/">
				<response-code value="200" />
				<!-- Check the end date is right -->
				<regex pattern='&lt;td&gt;export&lt;/td&gt;&lt;td&gt;kVArh&lt;/td&gt;' />
				<regex
					pattern='&lt;td&gt;Missing&lt;/td&gt;&lt;td&gt;2003-08-03T00:00Z&lt;/td&gt;&lt;td&gt;2003-08-13T23:30Z&lt;/td&gt;' />
			</request>

			<!-- Check that if the hhdc contract is changed, the hhdc contract of 
				the snags change -->
			<!-- Check the export supply capacity can be updated as well -->
			<request path="/chellow/supplies/6/generations/6/" method="post">
				<control name="meter-serial-number" value="" />
				<control name="start-year" value="2003" />
				<control name="start-month" value="08" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="true" />
				<control name="finish-year" value="2003" />
				<control name="finish-month" value="08" />
				<control name="finish-day" value="13" />
				<control name="finish-hour" value="23" />
				<control name="finish-minute" value="30" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="22 0883 6932 301" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="22 0883 6932 301" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="has-import-mpan" value="true" />
				<control name="import-llfc-code" value="570" />
				<control name="import-mpan-core" value="22 0883 6932 301" />
				<control name="import-gsp-group-id" value="11" />
				<control name="import-agreed-supply-capacity" value="430" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="01" />
				<control name="has-export-mpan" value="false" />
				<response-code value="200" />
				<regex
					pattern='&lt;input name="import-agreed-supply-capacity" size="9" maxlength="9" value="430"&gt;' />
			</request>

			<request path="/chellow/supplies/6/generations/6/channels/18/snags/">
				<response-code value="200" />
				<regex pattern='&lt;td&gt;export&lt;/td&gt;&lt;td&gt;kVArh&lt;/td&gt;' />

				<!-- Check the snag is there -->
				<regex
					pattern='&lt;td&gt;Missing&lt;/td&gt;&lt;td&gt;2003-08-03T00:00Z&lt;/td&gt;&lt;td&gt;2003-08-13T23:30Z&lt;/td&gt;' />
			</request>
			<!-- Put it back to how it was -->
			<request path="/chellow/supplies/6/generations/6/" method="post">
				<control name="meter-serial-number" value="" />
				<control name="start-year" value="2003" />
				<control name="start-month" value="08" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="false" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="22 0883 6932 301" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="22 0883 6932 301" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="has-import-mpan" value="true" />
				<control name="import-llfc-code" value="570" />
				<control name="import-mpan-core" value="22 0883 6932 301" />
				<control name="import-agreed-supply-capacity" value="350" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="01" />
				<control name="has-export-mpan" value="false" />
				<response-code value="200" />
			</request>

			<!-- Valid bulk update of supply generations -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="supply-generation-update.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/general-imports/8/" />
			</request>
			<request path="/chellow/general-imports/8/">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="supplies-bad-mpan.csv" />
				<response-code value="303" />
				<regex pattern="/general-imports/9/" />
			</request>
			<request path="/chellow/general-imports/9/">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="This MPAN core is already attached to another supply" />
				<response-code value="200" />
			</request>

			<!-- Attach another site to a supply generation -->
			<request path="/chellow/supplies/3/generations/3/" method="post">
				<control name="site-code" value="CI005" />
				<control name="attach" value="Attach" />
				<response-code value="200" />
			</request>

			<!-- Check that we prevent mpan cores from changing without an overlapping 
				period -->
			<request path="/chellow/supplies/3/generations/9/" method="post">
				<control name="meter-serial-number" value="" />
				<control name="start-year" value="2006" />
				<control name="start-month" value="07" />
				<control name="start-day" value="20" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="false" />
				<control name="mop-contract-id" value="null" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="01" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="has-import-mpan" value="true" />
				<control name="import-llfc-code" value="580" />
				<control name="import-mpan-core" value="2276930477695" />
				<control name="import-agreed-supply-capacity" value="430" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="01" />
				<control name="has-export-mpan" value="false" />
				<response-code value="418" />
				<regex pattern="MPAN cores can't change without an overlapping period" />
			</request>
		</test>

		<test name="Import hh data">
			<!-- Check it gives a sensible error message if the files doesn't start 
				with #F2 -->


			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="no_hash.df2" />
				<regex pattern="The first line must be '#F2'" />
				<response-code value="418" />
			</request>

			<!-- Import some hh Stark DF2 data -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data.df2" />
				<response-code value="303" />
				<regex pattern="/reports/65/output/\?hhdc-contract-id=0&amp;process-id=0" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=0">
				<refresh />
				<!-- Check it's loaded ok and has ignored the blank line and the #F2 
					line -->
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
			<request path="/chellow/supplies/2/generations/2/channels/4/snags/">
				<regex pattern='&lt;td&gt;export&lt;/td&gt;&lt;td&gt;kVArh&lt;/td&gt;' />
				<regex
					pattern='&lt;tr&gt;[\r\n]&lt;td&gt;&lt;a href="4/"&gt;4&lt;/a&gt;&lt;/td&gt;&lt;td&gt;Missing&lt;/td&gt;&lt;td&gt;2003-08-03T00:00Z&lt;/td&gt;' />
				<response-code value="200" />
			</request>
			<!-- Check if zipped hh data imports ok -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data.zip" />
				<response-code value="303" />
			</request>
			<!-- Do same thing, testing if ok with upper case file extension -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data_ucase.ZIP" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Detect if hh import still works if first hh datum is missing.">
			<!-- This relies on the datum 15/11/2005,00:30,1.0,A being already loaded, 
				with a gap before it. -->

			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="missing.df2" />
				<regex pattern="/reports/65/output/\?hhdc-contract-id=0&amp;process-id=3" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=3">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
		</test>
		<test name="Do we handle BST ok?">
			<!-- This relies on the default timezone being BST -->

			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data_timezone.df2" />
				<regex
					pattern="/chellow/reports/65/output/\?hhdc-contract-id=0&amp;process-id=4" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=4">
				<!-- Check it's loaded ok -->
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
		</test>

		<test name="Actual reads snags combined properly">
			<!-- Test that 3 non-actual reads in a row generate a single snag -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data_not_actual.df2" />
				<regex
					pattern="/chellow/reports/65/output/\?hhdc-contract-id=0&amp;process-id=5" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=5">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
			<request path="/chellow/supplies/2/generations/2/channels/3/snags/">
				<regex pattern='&lt;td&gt;export&lt;/td&gt;&lt;td&gt;kWh&lt;/td&gt;' />
				<regex
					pattern="&lt;td&gt;Estimated&lt;/td&gt;&lt;td&gt;2005-12-15T07:00Z&lt;/td&gt;&lt;td&gt;2005-12-15T08:00Z&lt;/td&gt;" />
				<regex
					pattern='&lt;td&gt;Missing&lt;/td&gt;&lt;td&gt;2003-08-03T00:00Z&lt;/td&gt;&lt;td&gt;2005-12-15T06:30Z&lt;/td&gt;' />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data_not_actual2.df2" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=6">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
			<request path="/chellow/supplies/2/generations/2/channels/3/snags/">
				<regex pattern="&lt;td&gt;export&lt;/td&gt;&lt;td&gt;kWh&lt;/td&gt;" />
				<regex
					pattern="&lt;td&gt;Estimated&lt;/td&gt;&lt;td&gt;2005-12-15T07:00Z&lt;/td&gt;&lt;td&gt;2005-12-15T09:30Z&lt;/td&gt;" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Importing Stark CSV data">
			<!-- Test if a simple Stark CSV HH file can be imported -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data.stark.csv" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=7">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
			<!-- Check that the imported HH datum is correct -->
			<request
				path="/chellow/supplies/2/generations/2/channels/3/hh-data/?year=2005&amp;month=09">
				<regex
					pattern='&lt;td&gt;2005-09-15T00:00&lt;/td&gt;&lt;td&gt;1.0&lt;/td&gt;&lt;td&gt;A&lt;/td&gt;' />
			</request>
		</test>
		<test name="Various DF2 tests.">
			<!-- Check it gives a sensible error message if the comma after the value 
				is missing -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data_malformed.df2" />
				<regex pattern="/reports/65/output/\?hhdc-contract-id=0&amp;process-id=8" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=8">
				<regex pattern="Problem at line number: 4" />
				<response-code value="200" />
			</request>

			<!-- Check it gives a sensible error message if the first mpan is malformed -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data_bad_beginning.df2" />
				<regex pattern="/reports/65/output/\?hhdc-contract-id=0&amp;process-id=9" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=9">
				<refresh />
				<regex
					pattern="The MPAN core \(2204707514535,,,\) must contain exactly 13 digits" />
				<response-code value="200" />
			</request>

			<!-- Check sensible error message if header but no data -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data_header_but_no_data.df2" />
				<regex pattern="/reports/65/output/\?hhdc-contract-id=0&amp;process-id=10" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=10">
				<refresh />
				<regex pattern="The import has completed.*successfully\." />
				<response-code value="200" />
			</request>
		</test>
		<test name="Manipulate channels">
			<!-- Make sure 'show HH data' button works -->
			<request path="/chellow/supplies/7/generations/7/channels/19/">
				<regex pattern='Import' />
				<regex pattern='kWh' />
				<response-code value="200" />
			</request>
		</test>
		<!-- Manipulate Hh data" -->
		<test name="Make sure 'show HH data' button works">
			<request path="/chellow/supplies/7/generations/7/channels/21/hh-data/">
				<regex pattern='kVArh' />
				<regex pattern='Export' />
				<regex pattern='action="\."&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Give good error for invalid date.">
			<request
				path="/chellow/supplies/7/generations/7/channels/21/hh-data/?year=2006&amp;month=13">
				<regex pattern='Invalid date' />
				<response-code value="418" />
			</request>
		</test>
		<test name="Check site level snag">
			<request path="/chellow/reports/39/output/">
				<regex pattern='CI004' />
				<!-- There's an hh where export to net is *less* than imported from generator, 
					check this doesn't show up. -->
				<regex
					pattern='2005-10-30 01:00&lt;/td&gt;[\r\n]*&lt;/tr&gt;[\r\n]*&lt;/tbody&gt;' />
			</request>
			<request path="/chellow/site-snags/">
				<!-- Check that there's an 'ignore-year' parameter. -->
				<regex pattern='name="ignore-year"' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check view of channel level snag">
			<request path="/chellow/supplies/2/generations/2/channels/1/snags/4/">
				<response-code value="200" />
			</request>
		</test>

		<test name="Channel without data unchecked">
			<!-- Check that for a supply with multiple generations, if a channel without 
				any data is unchecked, it goes ahead without a user exception. This test 
				needs some hh data loaded somewhere -->
			<request path="/chellow/supplies/3/generations/9/channels/27/"
				method="post">
				<control name="delete">Delete</control>
				<response-code value="303" />
			</request>

			<!-- Put it back to how it was before -->
			<request path="/chellow/supplies/3/generations/9/channels/"
				method="post">
				<control name="is-import" value="false" />
				<control name="is-kwh" value="true" />
				<response-code value="303" />
			</request>

			<!-- Check it gives an error if the hhdc contract is removed from a supply 
				generation that has data -->
			<request path="/chellow/supplies/2/generations/2/" method="post">
				<control name="start-year" value="2003" />
				<control name="start-month" value="08" />
				<control name="start-day" value="03" />
				<control name="is-ended" value="false" />
				<control name="meter-serial-number" value="" />
				<control name="gsp-group-id" value="11" />
				<control name="pc-id" value="9" />
				<control name="hhdc-contract-id" value="null" />
				<control name="hhdc-account" value="01" />
				<control name="has-import-mpan" value="true" />
				<control name="import-mtc-code" value="845" />
				<control name="import-llfc-code" value="550" />
				<control name="import-mpan-core" value="22 9205 6799 106" />
				<control name="import-ssc-code" value="" />
				<control name="import-agreed-supply-capacity" value="450" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="11640077" />
				<control name="has-export-mpan" value="true" />
				<control name="export-mtc-code" value="845" />
				<control name="export-llfc-code" value="581" />
				<control name="export-mpan-core" value="22 0470 7514 535" />
				<control name="export-ssc-code" value="" />
				<control name="export-agreed-supply-capacity" value="150" />
				<control name="export-supplier-contract-id" value="4" />
				<control name="export-supplier-account" value="01" />
				<response-code value="418" />
			</request>
		</test>

		<test name="View a snag">
			<request path="/chellow/site-snags/41/">
				<response-code value="200" />
				<regex
					pattern="&lt;th&gt;Finish Date&lt;/th&gt;&lt;td&gt;2005-10-30 01:00&lt;/td&gt;" />
			</request>
		</test>
		<test name="site snags stay ignored">
			<!-- Assumes various site snags are present at this stage -->
			<request path="/chellow/site-snags/" method="post">
				<control name="ignore-year" value="2006" />
				<control name="ignore-month" value="12" />
				<control name="ignore-day" value="26" />
				<control name="ignore" value="Ignore" />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data.df2" />
				<regex pattern="/reports/65/output/\?hhdc-contract-id=0&amp;process-id=11" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=11">
				<refresh />
				<regex pattern="The import has completed.*successfully" />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/39/output/">
				<regex pattern='&lt;tbody/&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Batches">
			<!-- Create a new batch -->
			<request path="/chellow/supplier-contracts/4/batches/"
				method="post">
				<control name="reference" value="04-003" />
				<control name="description" value="Contract 4, batch number 3" />
				<response-code value="303" />
			</request>

			<!-- Check it gives a good error message for a duplicate name -->
			<request path="/chellow/supplier-contracts/4/batches/"
				method="post">
				<control name="reference" value="04-003" />
				<control name="description" value="dup batch" />
				<regex pattern="There's already a batch with that reference\." />
				<response-code value="418" />
			</request>
		</test>
		<test name="Bill imports">
			<!-- Create a new import -->
			<request path="/chellow/supplier-contracts/4/batches/1/bill-imports/"
				method="post">
				<control type="file" name="file" value="bills.mm" />
				<response-code value="303" />
				<regex pattern="/chellow/supplier-contracts/4/batches/1/bill-imports/0/" />
			</request>
			<request path="/chellow/supplier-contracts/4/batches/1/bill-imports/0/">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="&lt;td&gt;2007-02-28&lt;/td&gt;&lt;td&gt;0&lt;/td&gt;&lt;td&gt;4463.08&lt;/td&gt;" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>

		<test name="Set up NHH">
			<!-- Create a new supplier contract -->
			<request path="/chellow/supplier-contracts/" method="post">
				<control name="participant-id" value="180" /> <!-- HYDE -->
				<control name="name" value="Non half-hourlies 2007" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="has-finished" value="false" />
				<regex pattern="/chellow/supplier-contracts/10/" />
				<response-code value="303" />
			</request>


			<request path="/chellow/supplier-contracts/10/" method="post">
				<control name="name" value="Non half-hourlies 2007" />
				<control name="charge-script">
				<![CDATA[
def import_virtual_bill_titles():
    return ['net-gbp', 'vat-gbp', 'gross-gbp', 'problem']


def virtual_bill(supply_source):
    return {'net-gbp': 0.0, 'vat-gbp':0.0, 'gross-gbp': 0.0, 'problem': ''}]]>
				</control>
			</request>


			<!-- Valid import of supplies -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="nhh-supplies.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/general-imports/10/" />
			</request>
			<request path="/chellow/general-imports/10/">
				<refresh max="21" />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
			<!-- Check values have been imported correctly -->
			<request path="/chellow/supplies/12/generations/13/">
				<regex pattern="K87D74429" />
				<response-code value="200" />
			</request>

			<!-- Create a new batch -->
			<request path="/chellow/supplier-contracts/10/batches/"
				method="post">
				<control name="reference" value="06-002" />
				<control name="description" value="Bgb batch" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplier-contracts/10/batches/3/bill-imports/"
				method="post">
				<control type="file" name="file" value="bills.bgb.edi" />
				<response-code value="303" />
				<regex pattern="/supplier-contracts/10/batches/3/bill-imports/1/" />
			</request>
			<request path="/chellow/supplier-contracts/10/batches/3/bill-imports/1/">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>
		<test name="Check that resolved HH estimates have their snags cleared.">
			<!-- Set a previously estimated HH to actual -->
			<request path="/chellow/supplies/2/generations/2/channels/3/hh-data/11/"
				method="post">
				<control name="value" value="0.5" />
				<control name="status" value="A" />
				<response-code value="200" />
			</request>

			<!-- Check that the snag has been cleared -->
			<request path="/chellow/supplies/2/generations/2/channels/3/snags/">
				<regex pattern='&lt;td&gt;export&lt;/td&gt;&lt;td&gt;kWh&lt;/td&gt;' />
				<regex
					pattern='&lt;td&gt;Estimated&lt;/td&gt;&lt;td&gt;2005-12-15T07:30Z&lt;/td&gt;&lt;td&gt;2005-12-15T09:30Z&lt;/td&gt;' />
			</request>
			<!-- Change it back -->
			<request path="/chellow/supplies/2/generations/2/channels/3/hh-data/11/"
				method="post">
				<control name="value" value="0.5" />
				<control name="status" value="E" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Test of BGlobal HH data import">
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh_data.bg.csv" />
				<response-code value="303" />
				<regex
					pattern="/chellow/reports/65/output/\?hhdc-contract-id=0&amp;process-id=12" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=12">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Check the BGlobal data is imported to the right number of sig figs">
			<request
				path="/chellow/supplies/2/generations/2/channels/1/hh-data/?year=2008&amp;month=07">
				<regex pattern="0\.262" />
			</request>
		</test>
		<test
			name="Check okay if supply generation update is interupted by an error.">
			<request path="/chellow/supplies/10/generations/11/" method="post">
				<control name="meter-serial-number" value="P96C93722" />
				<control name="start-year" value="2005" />
				<control name="start-month" value="08" />
				<control name="start-day" value="06" />
				<control name="is-ended" value="false" />
				<control name="has-import-mpan" value="true" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="535" />
				<control name="llfc-code" value="510" />
				<control name="import-mpan-core" value="22 0195 4836 192" />
				<control name="ssc-code" value="0127" />
				<control name="gsp-group-id" value="11" />
				<control name="import-agreed-supply-capacity" value="30" />
				<control name="hhdc-contract-name" value="HH contract" />
				<control name="hhdc-account"></control>
				<control name="import-supplier-contract-name" value="Non half-hourlies 2007" />
				<control name="import-supplier-account" value="341664" />
				<control name="has-export-mpan" value="true" />
				<control name="export-mpan-core" value="99 0000 4444 883" />
				<control name="export-agreed-supply-capacity">200</control>
				<control name="export-supplier-contract-name" value="Non half-hourlies 2007" />
				<control name="export-supplier-account" value="341664" />

				<response-code value="418" />
			</request>
		</test>
		<test name="HH data general import">
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="hh_data.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/general-imports/11/" />
			</request>
			<request path="/chellow/general-imports/11/">
				<refresh />
				<regex pattern="The file has been imported successfully\." />
				<response-code value="200" />
			</request>
		</test>
		<test name="CSV import">
			<request path="/chellow/supplier-contracts/4/batches/"
				method="post">
				<control name="reference" value="06-004" />
				<control name="description" value="CSV batch" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplier-contracts/4/batches/4/bill-imports/"
				method="post">
				<control type="file" name="file" value="bills.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/supplier-contracts/4/batches/4/bill-imports/2/" />
			</request>
			<request path="/chellow/supplier-contracts/4/batches/4/bill-imports/2/">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>
		<test name="Check one is able to delete a generation ok">
			<request path="/chellow/supplies/10/generations/" method="post">
				<control name="start-year" value="2009" />
				<control name="start-month" value="01" />
				<control name="start-day" value="20" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<regex pattern="/chellow/supplies/10/generations/14/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplies/10/generations/14/" method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Check 'view' link is correct on a site in the edit world.">
			<request path="/chellow/sites/7/">
				<regex pattern="/chellow/reports/5/output/\?site-id=7" />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Check that if supply generation dates change, hh data move with them.'">
			<request path="/chellow/supplies/2/generations/" method="post">
				<control name="start-year" value="2008" />
				<control name="start-month" value="7" />
				<control name="start-day" value="7" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<regex pattern="/chellow/supplies/2/generations/15/" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/supplies/2/generations/15/channels/30/hh-data/?year=2008&amp;month=07">
				<regex
					pattern='&lt;td&gt;&lt;a href="/chellow/supplies/2/generations/15/channels/30/hh-data/65/"&gt;65&lt;/a&gt;&lt;/td&gt;&lt;td&gt;2008-07-07T00:00&lt;/td&gt;&lt;td&gt;0.247&lt;/td&gt;&lt;td&gt;A&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check 'view' link is correct on a supply in the edit world.">
			<request path="/chellow/supplies/10/">
				<regex pattern="/chellow/reports/7/output/\?supply-id=10" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check site nav link is correct on site HH data page.">
			<request
				path="/chellow/reports/25/output/?site-code=CI004&amp;year=2005&amp;month=11">
				<regex pattern="/chellow/reports/5/output/\?site-id=1" />

				<!-- Check that columns are in the right order -->
				<regex pattern='kWh&lt;/th&gt;&lt;th colspan="4"&gt;1 net &lt;/th&gt;' />
				<response-code value="200" />
			</request>
		</test>

		<test name="Check no duplicate supplies in Supplies Duration report.">
			<request
				path="/chellow/reports/149/output/?start-year=2008&amp;start-month=07&amp;start-day=01&amp;start-hour=0&amp;finish-year=2008&amp;finish-month=07&amp;finish-day=31&amp;finish-hour=23">
				<regex pattern='("2","1","net","","CH017",){1}' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check last HH is deleted when a day of HH data is deleted.">
			<!-- Delete a day of data -->
			<request path="/chellow/supplies/2/generations/15/channels/30/hh-data/"
				method="post">
				<control name="delete-from-year" value="2008" />
				<control name="delete-from-month" value="07" />
				<control name="delete-from-day" value="07" />
				<control name="days" value="1" />
				<control name="delete" value="Delete" />
				<response-code value="200" />
			</request>
			<!-- Check the last HH of the day is deleted -->
			<request
				path="/chellow/supplies/2/generations/15/channels/30/hh-data/?year=2008&amp;month=07">
				<regex
					pattern='&lt;tbody&gt;[\r\n]*&lt;tr&gt;[\r\n]*&lt;td&gt;&lt;a href="/chellow/supplies/2/generations/15/channels/30/hh-data/113/"&gt;113&lt;/a&gt;&lt;/td&gt;&lt;td&gt;2008-07-08T00:00&lt;/td&gt;&lt;td&gt;0.299&lt;/td&gt;&lt;td&gt;A&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check one is redirected to hh data when a datum is deleted.">
			<request path="/chellow/supplies/2/generations/2/channels/1/hh-data/23/"
				method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
				<regex pattern="/chellow/supplies/2/generations/2/channels/1/hh-data/" />
			</request>
		</test>
		<test
			name="Test that removing HHDC while HH data still present gives proper message.">
			<request path="/chellow/supplies/6/generations/6/" method="post">
				<control name="meter-serial-number" value="" />
				<control name="start-year" value="2003" />
				<control name="start-month" value="08" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="false" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="22 0883 6932 301" />
				<control name="hhdc-contract-id" value="null" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="has-import-mpan" value="true" />
				<control name="import-llfc-code" value="570" />
				<control name="import-mpan-core" value="22 0883 6932 301" />
				<control name="import-agreed-supply-capacity" value="350" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="01" />
				<control name="has-export-mpan" value="false" />
				<response-code value="418" />
				<regex
					pattern="Can't remove the HHDC account while there are still channels there\." />
			</request>
		</test>
		<test name="Test that profile 05 is displayed for a supply generation.">
			<request path="/chellow/supplies/10/generations/11/">
				<regex
					pattern='&lt;option value="5" selected&gt;05 - Non-domestic, MD, load factor 0-20%&lt;/option&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try adding a party viewer.">
			<request path="/chellow/users/" method="post">
				<control name="email-address" value="mishka@localhost" />
				<control name="password" value="fyodor" />
				<control name="user-role-id" value="2" />
				<control name="party-id" value="102" /> <!-- DASL HHDC -->
				<response-code value="303" />
				<regex pattern="/chellow/users/4/" />
			</request>
		</test>
		<test name="Check that the party viewer is able to view snags.">
			<request
				path="/chellow/reports/37/output/?hhdc-contract-id=0&amp;hidden-days=5">
				<credentials username="mishka@localhost" password="fyodor" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Make sure everything's there on the home page.">
			<request path="/chellow/reports/1/output/">
				<credentials username="watkins@example.com" password="alan" />
				<regex
					pattern='&lt;a href="/chellow/reports/133/output/"&gt;Meter Payment Types&lt;/a&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check the edit world supplies page.">
			<request path="/chellow/supplies/">
				<regex pattern='/chellow/reports/99/output/' />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Test deleting the only rate script attached to a supplier contract.">
			<request path="/chellow/supplier-contracts/4/rate-scripts/4/"
				method="post">
				<control name="delete" value="Delete" />
				<regex pattern="You can't delete the last rate script\." />
				<response-code value="418" />
			</request>
		</test>
		<test
			name="Try adding a second rate script (set to 'ongoing'), and see if the supply generation can be updated.">
			<request path="/chellow/supplier-contracts/4/rate-scripts/"
				method="post">
				<control name="start-year" value="2009" />
				<control name="start-month" value="08" />
				<control name="start-day" value="16" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="script" value="" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplies/2/generations/15/" method="post">
				<control name="start-year" value="2008" />
				<control name="start-month" value="07" />
				<control name="start-day" value="07" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="false" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 0470 7514 535" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="01" />
				<control name="meter-serial-number" value="" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="has-import-mpan" value="false" />
				<control name="has-export-mpan" value="true" />
				<control name="export-llfc-code" value="581" />
				<control name="export-mpan-core" value="22 0470 7514 535" />
				<control name="export-agreed-supply-capacity" value="150" />
				<control name="export-supplier-contract-id" value="4" />
				<control name="export-supplier-account" value="010" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check updating of HHDC contract state.">
			<request path="/chellow/hhdc-contracts/0/" method="post">
				<control name="state"><![CDATA[
lastImportDate0=2008-11-30
lastImportName0=Example]]></control>
				<control name="update-state" value="Update State" />
				<response-code value="303" />
			</request>
			<request path="/chellow/hhdc-contracts/0/">
				<response-code value="200" />
				<regex pattern="lastImportDate0=2008-11-30\nlastImportName0=Example" />
			</request>
		</test>
		<test name="Check that numbering of user reports is preserved.">
			<!-- Requires that no other user reports have been created. -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="reports.csv" />
				<response-code value="303" />
				<regex pattern="/general-imports/12/" />
			</request>
			<request path="/chellow/general-imports/12/">
				<refresh />
				<response-code value="200" />
				<regex pattern="The file has been imported successfully\." />
			</request>
			<request path="/chellow/reports/100/">
				<response-code value="200" />
				<regex pattern="Minority Report" />
			</request>
		</test>
		<test name="Check dates are correct for four supply generations.">
			<request path="/chellow/supplies/2/generations/" method="post">
				<control name="start-year" value="2008" />
				<control name="start-month" value="08" />
				<control name="start-day" value="07" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplies/2/generations/" method="post">
				<control name="start-year" value="2008" />
				<control name="start-month" value="09" />
				<control name="start-day" value="07" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplies/2/generations/">
				<regex
					pattern='2&lt;/td&gt;&lt;td&gt;2003-08-03 00:00&lt;/td&gt;&lt;td&gt;2008-07-06 23:30' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Test 'view' link from supplier contract rate scripts.">
			<request path="/chellow/supplier-contracts/4/rate-scripts/">
				<regex pattern="/chellow/reports/77/output/\?supplier-contract-id=4" />
			</request>
		</test>
		<test name="Check there isn't an empty link to the HHDC Contract.">
			<request path="/chellow/supplies/10/generations/11/">
				<regex
					pattern='&lt;option value="0"&gt;HH contract&lt;/option&gt;&lt;/select&gt;&lt;/label&gt; Dynamat data&lt;br&gt;' />
			</request>
		</test>
		<test name="Try bulk delete of HHDC snags.">
			<request path="/chellow/hhdc-contracts/2/" method="post">
				<control name="ignore-year" value="2010" />
				<control name="ignore-month" value="01" />
				<control name="ignore-day" value="13" />
				<control name="ignore-snags" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check python compile error gives a reasonable message.">
			<request path="/chellow/supplier-contracts/4/" method="post">
				<control name="participant-id" value="21" />
				<control name="name" value="Half-hourlies 2007" />
				<control name="charge-script">
				<![CDATA[
def virtual_bill(supply, startDate, finishDate, pw):
    syntax error]]>
				</control>
				<regex pattern="SyntaxError" />
				<response-code value="418" />
			</request>
			<!-- Put back to how it was before -->
			<request path="/chellow/supplier-contracts/4/" method="post">
				<control name="participant-id" value="21" />
				<control name="name" value="Half-hourlies 2007" />
				<control name="charge-script">
				<![CDATA[                                
from net.sf.chellow.monad import Hiber
from java.util import GregorianCalendar, TimeZone, Locale, Calendar
from net.sf.chellow.physical import MpanCore, HhStartDate, Supply, Site
from net.sf.chellow.billing import NonCoreContract, SupplierContract, Dno
from net.sf.chellow.monad.types import MonadDate
from java.lang import System

computer_contract = NonCoreContract.getNonCoreContract('computer')
triad_contract = NonCoreContract.getNonCoreContract('TRIAD')
ccl_contract = NonCoreContract.getNonCoreContract('ccl')
bsuos_contract = NonCoreContract.getNonCoreContract('bsuos')
tlms_contract = NonCoreContract.getNonCoreContract('tlms')

def import_virtual_bill_titles():
    return ['net-gbp', 'tlm', 'ccl-kwh', 'ccl-rate', 'ccl-gbp', 'data-collection-gbp', 'duos-availability-agreed-kva', 'duos-availability-billed-kva', 'duos-availability-rate', 'duos-availability-gbp', 'duos-day-kwh', 'duos-day-gbp', 'duos-night-kwh', 'duos-night-gbp', 'duos-reactive-rate', 'duos-reactive-gbp', 'duos-standing-gbp', 'settlement-gbp', 'night-msp-kwh', 'night-gsp-kwh', 'night-gbp', 'other-msp-kwh', 'other-gsp-kwh', 'other-gbp', 'summer-pk-msp-kwh', 'summer-pk-gsp-kwh', 'summer-pk-gbp', 'winter-low-pk-msp-kwh', 'winter-low-pk-gsp-kwh', 'winter-low-pk-gbp', 'winter-off-pk-msp-kwh', 'winter-off-pk-gsp-kwh', 'winter-off-pk-gbp', 'winter-pk-msp-kwh', 'winter-pk-gsp-kwh', 'winter-pk-gbp', 'bsuos-kwh', 'bsuos-rate', 'bsuos-gbp', 'triad-actual-0-date', 'triad-actual-0-msp-kw', 'triad-actual-0-status', 'triad-actual-0-laf', 'triad-actual-0-gsp-kw', 'triad-actual-1-date', 'triad-actual-1-msp-kw', 'triad-actual-1-status', 'triad-actual-1-laf', 'triad-actual-1-gsp-kw', 'triad-actual-2-date', 'triad-actual-2-msp-kw', 'triad-actual-2-status', 'triad-actual-2-laf', 'triad-actual-2-gsp-kw', 'triad-actual-gsp-kw', 'triad-actual-rate', 'triad-actual-gbp', 'triad-estimate-0-date', 'triad-estimate-0-msp-kw', 'triad-estimate-0-status', 'triad-estimate-0-laf', 'triad-estimate-0-gsp-kw', 'triad-estimate-1-date', 'triad-estimate-1-msp-kw', 'triad-estimate-1-status', 'triad-estimate-1-laf', 'triad-estimate-1-gsp-kw', 'triad-estimate-2-date', 'triad-estimate-2-msp-kw', 'triad-estimate-2-status', 'triad-estimate-2-laf', 'triad-estimate-2-gsp-kw', 'triad-estimate-gsp-kw', 'triad-estimate-rate', 'triad-estimate-months', 'triad-estimate-gbp', 'triad-all-estimates-months', 'triad-all-estimates-gbp']

def displaced_virtual_bill_titles():
    return ['bsuos-kwh', 'bsuos-rate', 'bsuos-gbp', 'ccl-kwh', 'ccl-rate', 'ccl-gbp', 'duos-day-gbp', 'duos-day-kwh', 'duos-night-gbp', 'duos-night-kwh', 'duos-reactive-gbp', 'duos-reactive-working', 'net-gbp', 'duos-standing-gbp', 'night-gbp', 'night-gsp-kwh', 'night-msp-kwh', 'other-gbp', 'other-gsp-kwh', 'other-msp-kwh', 'summer-pk-gbp', 'summer-pk-gsp-kwh', 'summer-pk-msp-kwh', 'triad-gbp', 'triad-working', 'winter-low-pk-gbp', 'winter-low-pk-gsp-kwh', 'winter-low-pk-msp-kwh', 'winter-off-pk-gbp', 'winter-off-pk-gsp-kwh', 'winter-off-pk-msp-kwh', 'winter-pk-gbp', 'winter-pk-gsp-kwh', 'winter-pk-msp-kwh']

slot_names = ['winter-pk', 'winter-low-pk', 'winter-off-pk', 'summer-pk', 'night', 'other']

slots = {}
for slot_name in slot_names:
    slots[slot_name] = {'msp-kwh': slot_name + '-msp-kwh', 'gsp-kwh': slot_name + '-gsp-kwh', 'gbp': slot_name + '-gbp'}


def displaced_virtual_bill(supply_source):
    bill = supply_source.supplier_bill
    bill.update({'net-gbp': 0})

    for slot_name in slot_names:
        slot_keys = slots[slot_name]
        bill[slot_keys['msp-kwh']] = 0
        bill[slot_keys['gsp-kwh']] = 0


    comterp = supply_source.comterp
    contract_func = comterp.get('contract_function')

    supply_source.is_green = False
    supply_source.add_duos_elements()

    for datum in supply_source.hh_data:
        is_weekday = datum['utc-day-of-week'] != Calendar.SATURDAY and datum['utc-day-of-week'] != Calendar.SUNDAY
        if is_weekday and (datum['utc-month'] == Calendar.JANUARY or datum['utc-month'] == Calendar.DECEMBER) and 16 < datum['utc-decimal-hour'] <= 19:
            slot_key = 'winter-pk'
        elif is_weekday and (datum['utc-month'] == Calendar.FEBRUARY or datum['utc-month'] == Calendar.NOVEMBER) and 16 < datum['utc-decimal-hour'] <= 19:
            slot_key = 'winter-low-pk'
        elif is_weekday and (datum['utc-month'] > Calendar.OCTOBER or datum['utc-month'] < Calendar.APRIL) and 8 < datum['utc-decimal-hour'] <= 20:
            slot_key = 'winter-off-pk'
        elif is_weekday and (datum['utc-month'] > Calendar.MARCH or datum['utc-month'] < Calendar.NOVEMBER) and 8 < datum['utc-decimal-hour'] <= 20:
            slot_key = 'summer-pk'
        elif 0 < datum['utc-decimal-hour'] <= 7:
            slot_key = 'night'
        else:
            slot_key = 'other'
        slot_keys = slots[slot_key]
        bill[slot_keys['msp-kwh']] += datum['msp-kwh']
        bill[slot_keys['gsp-kwh']] += datum['gsp-kwh']

    contract_func(ccl_contract, 'ccl', supply_source.pw)(supply_source)

    for suffix in ['kwh', 'rate', 'gbp']:
        key = 'lec-' + suffix
        if key in bill:
            del bill[key]

    contract_func(triad_contract, 'triad_bill', supply_source.pw)(supply_source)
    contract_func(tlms_contract, 'hh', supply_source.pw)(supply_source)
    contract_func(bsuos_contract, 'hh', supply_source.pw)(supply_source)

    rates = supply_source.hh_rate(contract, supply_source.finish_date.getDate(), 'gsp_gbp_per_kwh')
    for slot_name in slot_names:
        slot_keys = slots[slot_name]
        bill[slot_keys['gbp']] = bill[slot_keys['gsp-kwh']] * rates[slot_name]

    for k, v in bill.iteritems():
        if k[-4:] == '-gbp' and k != 'net-gbp':
            bill['net-gbp'] += v
    return bill


def import_virtual_bill(supply_source):
    supply_source.add_duos_elements()
    bill = supply_source.supplier_bill
    bill.update({'net-gbp': 0, 'data-collection-gbp': 0, 'settlement-gbp': 0, 'problem': ''})

    for slot_name in slot_names:
        slot_keys = slots[slot_name]
        bill[slot_keys['msp-kwh']] = 0
        bill[slot_keys['gsp-kwh']] = 0

    comterp = supply_source.comterp

    llfc_code = supply_source.llfc_code
    voltage_level = supply_source.voltage_level_code
    is_substation = supply_source.is_substation
    supply_capacity = supply_source.availability
    supply_source.is_green = False

    utc_cal = GregorianCalendar(TimeZone.getTimeZone("GMT"), Locale.UK)
    ct_cal = GregorianCalendar(TimeZone.getTimeZone("Europe/London"), Locale.UK)

    for datum in supply_source.hh_data:
        is_weekday = datum['utc-day-of-week'] != Calendar.SATURDAY and datum['utc-day-of-week'] != Calendar.SUNDAY
        if is_weekday and (datum['utc-month'] == Calendar.JANUARY or datum['utc-month'] == Calendar.DECEMBER) and 16 < datum['utc-decimal-hour'] <= 19:
            slot_key = 'winter-pk'
        elif is_weekday and (datum['utc-month'] == Calendar.FEBRUARY or datum['utc-month'] == Calendar.NOVEMBER) and 16 < datum['utc-decimal-hour'] <= 19:
            slot_key = 'winter-low-pk'
        elif is_weekday and (datum['utc-month'] > Calendar.OCTOBER or datum['utc-month'] < Calendar.APRIL) and 8 < datum['utc-decimal-hour'] <= 20:
            slot_key = 'winter-off-pk'
        elif is_weekday and (datum['utc-month'] > Calendar.MARCH or datum['utc-month'] < Calendar.NOVEMBER) and 8 < datum['utc-decimal-hour'] <= 20:
            slot_key = 'summer-pk'
        elif 0 < datum['utc-decimal-hour'] <= 7:
            slot_key = 'night'
        else:
            slot_key = 'other'
        slot_keys = slots[slot_key]
        bill[slot_keys['msp-kwh']] += datum['msp-kwh']
        bill[slot_keys['gsp-kwh']] += datum['gsp-kwh']


    utc_cal.setTime(supply_source.start_date.getDate())
    utc_cal.add(Calendar.MONTH, 1)
    utc_cal.set(Calendar.DAY_OF_MONTH, 1)
    utc_cal.set(Calendar.HOUR_OF_DAY, 0)
    utc_cal.set(Calendar.MINUTE, 0)
    utc_cal.set(Calendar.SECOND, 0)
    utc_cal.set(Calendar.MILLISECOND, 0)
    utc_cal.add(Calendar.MINUTE, -30)
    month_end = HhStartDate(utc_cal.getTime())
    utc_cal.add(Calendar.MONTH, -1)
    utc_cal.add(Calendar.MINUTE, 30)
    month_begin = HhStartDate(utc_cal.getTime())

    supply_source.contract_function(ccl_contract, 'ccl')(supply_source)

    for suffix in ['kwh', 'rate', 'gbp']:
        key = 'lec-' + suffix
        if key in bill:
            del bill[key]

    bill['data-collection-gbp'] += 5.89
    bill['settlement-gbp'] += 88

    supply_source.contract_function(triad_contract, 'triad_bill')(supply_source)
    supply_source.contract_function(tlms_contract, 'hh')(supply_source)
    supply_source.contract_function(bsuos_contract, 'hh')(supply_source)
    rates = supply_source.hh_rate(contract, supply_source.finish_date.getDate(), 'gsp_gbp_per_kwh')
    for slot_name in slot_names:
        slot_keys = slots[slot_name]
        bill[slot_keys['gbp']] = bill[slot_keys['gsp-kwh']] * rates[slot_name]

    for k, v in bill.iteritems():
        if k[-4:] == '-gbp' and k != 'net-gbp':
            bill['net-gbp'] += v

    return bill]]>
				</control>
				<response-code value="200" />
			</request>
		</test>
		<test name="Test that ignore snags works.">
			<request path="/chellow/hhdc-contracts/2/" method="post">
				<control name="ignore-year" value="2010" />
				<control name="ignore-month" value="01" />
				<control name="ignore-day" value="13" />
				<control name="ignore-snags" />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Check that when there are gt 2 generations, the previous generation is updated.">
			<request path="/chellow/supplies/2/generations/17/" method="post">
				<control name="start-year" value="2008" />
				<control name="start-month" value="09" />
				<control name="start-day" value="06" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="false" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 0470 7514 535" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="01" />
				<control name="meter-serial-number" value="" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="has-import-mpan" value="false" />
				<control name="has-export-mpan" value="true" />
				<control name="export-llfc-code" value="581" />
				<control name="export-mpan-core" value="22 0470 7514 535" />
				<control name="export-agreed-supply-capacity" value="150" />
				<control name="export-supplier-contract-id" value="4" />
				<control name="export-supplier-account" value="010" />
				<response-code value="200" />
			</request>

			<request path="/chellow/supplies/2/generations/16/">
				<regex
					pattern='&lt;select name="finish-day"&gt;&lt;option value="01"&gt;01&lt;/option&gt;&lt;option value="02"&gt;02&lt;/option&gt;&lt;option value="03"&gt;03&lt;/option&gt;&lt;option value="04"&gt;04&lt;/option&gt;&lt;option value="05" selected&gt;05&lt;/option&gt;' />
			</request>
		</test>
		<test name="Check supplies snapshot">
			<request path="/chellow/reports/33/output/?year=2005&amp;month=12">
				<response-code value="200" />
				<regex pattern='"2005-12-31T23:30Z"' />
			</request>
		</test>
		<test
			name="Generate a 'There are HH data before the start of the updated supply.' message.">
			<request path="/chellow/supplies/6/generations/6/" method="post">
				<control name="start-year" value="2010" />
				<control name="start-month" value="08" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="false" />
				<control name="meter-serial-number" value="" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 0883 6932 301" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="22 0883 6932 301" />
				<control name="has-import-mpan" value="true" />
				<control name="import-llfc-code" value="570" />
				<control name="import-mpan-core" value="22 0883 6932 301" />
				<control name="import-agreed-supply-capacity" value="350" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="01" />
				<control name="has-export-mpan" value="false" />
				<response-code value="418" />
				<regex pattern='There are HH data before the start of the updated supply' />
			</request>
		</test>
		<test name="Test deleting of supplier contracts">
			<!-- Create a new supplier contract -->
			<request path="/chellow/supplier-contracts/" method="post">
				<control name="participant-id" value="196" /> <!-- RWED -->
				<control name="name" value="GDF" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />

				<regex pattern="/chellow/supplier-contracts/12/" />
				<response-code value="303" />
			</request>

			<!-- Now delete the contract -->
			<request path="/chellow/supplier-contracts/12/" method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>

			<!-- Check that it's really gone -->
			<request path="/chellow/supplier-contracts/12/">
				<response-code value="404" />
			</request>
		</test>
		<test name="Test deleting of HHDC contracts">
			<!-- Create an HHDC contract -->
			<request path="/chellow/hhdc-contracts/" method="post">
				<control name="participant-id" value="301" /> <!-- UKDC -->
				<control name="name" value="Siemens Contract" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="has-finished" value="false" />
				<control name="charge-script"></control>
				<control name="properties" value=" " />
				<response-code value="303" />
				<regex pattern="/hhdc-contracts/14/" />
			</request>

			<!-- Now delete the contract -->
			<request path="/chellow/hhdc-contracts/14/" method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>

			<!-- Check that it's really gone -->
			<request path="/chellow/hhdc-contracts/14/">
				<response-code value="404" />
			</request>
		</test>
		<test name="Check TRIAD calculation for March">
			<!-- Load in march's HH data -->
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="hh_data_long.csv" />
				<response-code value="303" />
				<regex pattern="/general-imports/13/" />
			</request>

			<request path="/chellow/general-imports/13/">
				<refresh />
				<response-code value="200" />
				<regex pattern="The file has been imported successfully\." />
			</request>

			<!-- Create the virtual bill -->
			<request path="/chellow/non-core-contracts/" method="post">
				<control name="participant-id" value="31" /> <!-- CALB -->
				<control name="is-core" value="false" />
				<control name="name" value="TRIAD Estimates" />
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<regex pattern="/non-core-contracts/16/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/non-core-contracts/16/rate-scripts/18/"
				method="post">
				<control name="start-year" value="2000" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="script">
				<![CDATA[
def triad_estimates():
    return {}]]>
				</control>
				<response-code value="200" />
			</request>
			<request
				path="/chellow/reports/87/output/?supply-id=8&amp;supply-polarity=import&amp;start-year=2009&amp;start-month=03&amp;start-day=01&amp;start-hour=00&amp;finish-year=2009&amp;finish-month=03&amp;finish-day=31&amp;finish-hour=23">
				<response-code value="200" />
				<regex
					pattern="MPAN Core,Site Code,Site Name,Account,From,To,net-gbp,tlm,ccl-kwh,ccl-rate,ccl-gbp,data-collection-gbp,duos-availability-agreed-kva,duos-availability-billed-kva,duos-availability-rate,duos-availability-gbp,duos-day-kwh,duos-day-gbp,duos-night-kwh,duos-night-gbp,duos-reactive-rate,duos-reactive-gbp,duos-standing-gbp,settlement-gbp,night-msp-kwh,night-gsp-kwh,night-gbp,other-msp-kwh,other-gsp-kwh,other-gbp,summer-pk-msp-kwh,summer-pk-gsp-kwh,summer-pk-gbp,winter-low-pk-msp-kwh,winter-low-pk-gsp-kwh,winter-low-pk-gbp,winter-off-pk-msp-kwh,winter-off-pk-gsp-kwh,winter-off-pk-gbp,winter-pk-msp-kwh,winter-pk-gsp-kwh,winter-pk-gbp,bsuos-kwh,bsuos-rate,bsuos-gbp,triad-actual-0-date,triad-actual-0-msp-kw,triad-actual-0-status,triad-actual-0-laf,triad-actual-0-gsp-kw,triad-actual-1-date,triad-actual-1-msp-kw,triad-actual-1-status,triad-actual-1-laf,triad-actual-1-gsp-kw,triad-actual-2-date,triad-actual-2-msp-kw,triad-actual-2-status,triad-actual-2-laf,triad-actual-2-gsp-kw,triad-actual-gsp-kw,triad-actual-rate,triad-actual-gbp,triad-estimate-0-date,triad-estimate-0-msp-kw,triad-estimate-0-status,triad-estimate-0-laf,triad-estimate-0-gsp-kw,triad-estimate-1-date,triad-estimate-1-msp-kw,triad-estimate-1-status,triad-estimate-1-laf,triad-estimate-1-gsp-kw,triad-estimate-2-date,triad-estimate-2-msp-kw,triad-estimate-2-status,triad-estimate-2-laf,triad-estimate-2-gsp-kw,triad-estimate-gsp-kw,triad-estimate-rate,triad-estimate-months,triad-estimate-gbp,triad-all-estimates-months,triad-all-estimates-gbp" />
				<regex
					pattern='"22 4862 4512 332","CH023","Treglisson","11640077","2009-03-01T00:00Z","2009-03-31T23:30Z","10617.3796247","0","148925.71","0.00456","679.1012376","5.89","230","399.72","0.0368","456.000576","105487.44","770.058312","43438.27","112.939502","0.0033","0.0","0","88","43401.25","46092.1275","288.794834064","54364.73","57735.34326","361.74656673","0","0","0.0","0","0","0.0","51159.73","54331.63326","340.420281354","0","0","0.0","159628.438285","0","149.890063111","2009-01-06T17:00Z","288.82","A","1.07","309.0374","2008-12-01T17:00Z","384.44","A","1.07","411.3508","2008-12-15T17:00Z","185.36","A","1.07","198.3352","306.241133333","25.212997","7721.25677601","2007-12-17T17:00Z","0","E","1.07","0.0","2008-01-03T17:00Z","43.6","A","1.062","46.3032","2007-11-26T17:00Z","0","E","1.07","0.0","15.4344","25.212997","1","32.4289567414","12","-389.147480897","problem"' />
			</request>

			<!-- Try looking at it using the TRIAD report -->
			<request path="/chellow/reports/41/output/?supply-id=5&amp;year=2010">
				<response-code value="200" />
				<regex
					pattern='CI005,"Wheal Rodney","1",net,,22 6158 2968 220,2010-01-07T17:00Z,0,E,1.058,0.0,2010-01-25T17:00Z,0,E,1.058,0.0,2009-12-15T17:00Z,0,E,1.058,0.0,0.0,25.631634,0.0,22 3479 7618 470,2010-01-07T17:00Z,0,E,1.058,0.0,2010-01-25T17:00Z,0,E,1.058,0.0,2009-12-15T17:00Z,0,E,1.058,0.0,0.0,25.631634,0.0' />
			</request>
		</test>
		<test name="Check we can delete a rate script (when it's not the only one)">
			<request path="/chellow/supplier-contracts/4/rate-scripts/12/"
				method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Try the site level monthly data HTML report.">
			<request
				path="/chellow/reports/13/output/?site-id=7&amp;finish-year=2006&amp;finish-month=08">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try 'Supply MPAN Months' report.">
			<request path="/chellow/reports/15/output/?supply-id=2&amp;is-import=true">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try 'Supply Raw HH Data' report.">
			<request
				path="/chellow/reports/17/output/?supply-id=2&amp;months=1&amp;finish-year=2008&amp;finish-month=07">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try site graph report.">
			<request
				path="/chellow/reports/21/output/?site-id=7&amp;finish-year=2008&amp;finish-month=7&amp;months=1">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try generation graph report.">
			<request
				path="/chellow/reports/23/output/?site-id=7&amp;finish-year=2008&amp;finish-month=7&amp;months=1">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try 'Site HH bulk figures' report.">
			<request
				path="/chellow/reports/29/output/?site-id=7&amp;type=used&amp;months=1&amp;year=2008&amp;month=07">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try HHDC virtual bills.">
			<request
				path="/chellow/reports/81/output/?contract-id=0&amp;months=1&amp;end-year=2008&amp;end-month=7">
				<response-code value="200" />
				<regex
					pattern='Import MPAN Core, Export MPAN Core, Start Date, Finish Date,net-gbp' />
				<regex
					pattern='22 9205 6799 106,22 0470 7514 535,2008-07-01T00:00Z,2008-07-31T23:30Z,"0",' />
			</request>
		</test>
		<test name="CSV Sites HH Data">
			<request
				path="/chellow/reports/183/output/?months=1&amp;year=2008&amp;month=07">
				<response-code value="200" />
			</request>
		</test>
		<test name="CSV Supplies Duration">
			<request
				path="/chellow/reports/149/output/?start-year=2009&amp;start-month=03&amp;start-day=1&amp;start-hour=0&amp;finish-year=2009&amp;finish-month=03&amp;finish-day=31&amp;finish-hour=23">
				<regex
					pattern='"8","1","net","","CH023","Treglisson","2009-03-01T00:00Z","2009-03-31T23:30Z","00","845","5","","0","hh",540,22 4862 4512 332,230,Half-hourlies 2007,148925.71,0,158159.10402,399.72,2009-03-13T08:00Z,None,0,,,,,0,0,,0,None,None,1488' />
			</request>
		</test>
		<test name="Manipulate dno contracts">
			<!-- Insert DNO contract -->
			<request path="/chellow/dnos/138/contracts/" method="post"> <!-- Contract of DNO 10 -->
				<control name="name" value="main 2010-04-01" />
				<control name="start-year" value="2010" />
				<control name="start-month" value="04" />
				<control name="start-day" value="01" />
				<regex pattern="/chellow/dnos/138/contracts/103/" />
				<response-code value="303" />
			</request>

			<!-- Check start time of rate script -->
			<request path="/chellow/dnos/138/contracts/103/rate-scripts/773/">
				<regex
					pattern='&lt;select name="start-hour"&gt;&lt;option value="00" selected&gt;00&lt;/option&gt;' />
				<regex
					pattern='&lt;select name="start-minute"&gt;&lt;option value="00" selected&gt;00&lt;/option&gt;' />
				<response-code value="200" />
			</request>

			<!-- Insert rate script -->
			<request path="/chellow/dnos/138/contracts/103/rate-scripts/"
				method="post">
				<control name="start-year" value="2010" />
				<control name="start-month" value="05" />
				<control name="start-day" value="01" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<regex pattern="/chellow/dnos/138/contracts/103/rate-scripts/775/" />
				<response-code value="303" />
			</request>

			<!-- Delete rate script -->
			<request path="/chellow/dnos/138/contracts/103/rate-scripts/775/"
				method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="CSV Sites Monthly Duration">
			<request
				path="/chellow/reports/161/output/?site-code=CH023&amp;months=1&amp;end-year=2009&amp;end-month=03">
				<response-code value="303" />
			</request>
		</test>
		<test name="CSV Sites TRIAD">
			<request path="/chellow/reports/181/output/?site-id=1&amp;year=2010">
				<response-code value="200" />
			</request>
		</test>
		<test name="CSV Sites Monthly Duration">
			<!-- See if it handles the case where there isn't an import virtual bill 
				function. -->
			<request
				path="/chellow/reports/161/output/?site-code=CI017&amp;months=1&amp;end-year=2009&amp;end-month=04">
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/251/output/">
				<refresh />
				<response-code value="200" />
				<regex pattern="FINISHED_site_monthly_duration_for_CI017_1_to_2009_4\.csv" />
			</request>
			<request
				path="/chellow/reports/253/output/?name=FINISHED_site_monthly_duration_for_CI017_1_to_2009_4.csv">
				<refresh />
				<response-code value="200" />
				<regex
					pattern='Site Id,Site Name,Associated Site Ids,Sources,Generator Types,Month,Metered Imported kWh,Metered Displaced kWh,Metered Exported kWh,Metered Used kWh,Metered Parasitic kWh,Metered Generated kWh,Metered 3rd Party Import kWh,Metered 3rd Party Export kWh,Metered Imported GBP,Metered Displaced GBP,Metered Exported GBP,Metered Used GBP,Metered 3rd Party Import GBP,Billed Imported kWh,Billed Imported GBP,Metering Type,Problem' />
				<regex
					pattern='"CI017","Roselands","","net","","2009-04-30","0","0","0","0","0","0","0","0","2784.89","0","0","2784.89","0","0","0","hh","Can&apos;t find the import_virtual_bill function in the supplier contract. "' />
			</request>
		</test>
		<test name="Site In View World">
			<request path="/chellow/reports/5/output/?site-id=3">
				<response-code value="200" />
				<regex
					pattern='&lt;a href="/chellow/reports/7/output/\?supply-id=3"&gt;view&lt;/a&gt;' />
			</request>

			<!-- Check that it shows a dead supply properly -->
			<request path="/chellow/supplies/12/generations/13/" method="post">
				<control name="start-year" value="2005" />
				<control name="start-month" value="10" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="true" />
				<control name="finish-year" value="2010" />
				<control name="finish-month" value="04" />
				<control name="finish-day" value="13" />
				<control name="finish-hour" value="23" />
				<control name="finish-minute" value="30" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 9974 3438 105" />
				<control name="hhdc-contract-id" value="2" />
				<control name="hhdc-account" value="dc-22 9974 3438 105" />
				<control name="meter-serial-number" value="K87D74429" />
				<control name="pc-id" value="5" />
				<control name="mtc-code" value="803" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="0154" />
				<control name="has-import-mpan" value="true" />
				<control name="import-llfc-code" value="540" />
				<control name="import-mpan-core" value="22 9974 3438 105" />
				<control name="import-agreed-supply-capacity" value="20" />
				<control name="import-supplier-contract-id" value="10" />
				<control name="import-supplier-account" value="341665" />
				<control name="has-export-mpan" value="false" />
				<response-code value="200" />
			</request>

			<request path="/chellow/reports/5/output/?site-id=3">
				<response-code value="200" />
				<regex
					pattern='&lt;td&gt;[\r\n]*&lt;a href="/chellow/reports/7/output/\?supply-id=12"&gt;view&lt;/a&gt;[\r\n]*&lt;/td&gt;[\r\n]*&lt;td&gt;3&lt;/td&gt;[\r\n]*&lt;td&gt;2005-10-03&lt;/td&gt;[\r\n]*&lt;td&gt;[\r\n]*2010-04-13[\r\n]*&lt;/td&gt;' />
			</request>
		</test>
		<test name="Try a pre 2010-04-01 DNO 20 bill.">
			<!-- Turn a supply into a 20 supply -->
			<request path="/chellow/supplies/7/generations/7/" method="post">
				<control name="meter-serial-number" value="" />
				<control name="start-year" value="2003" />
				<control name="start-month" value="08" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="false" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 6354 2983 570" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="01" />
				<control name="has-import-mpan" value="true" />
				<control name="import-llfc-code" value="453" />
				<control name="import-mpan-core" value="20 6354 2983 571" />
				<control name="import-agreed-supply-capacity" value="2300" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="141 5532" />
				<control name="has-export-mpan" value="false" />
				<response-code value="200" />
			</request>
			<request
				path="/chellow/reports/87/output/?supply-id=7&amp;supply-polarity=import&amp;start-year=2009&amp;start-month=3&amp;start-day=01&amp;start-hour=00&amp;finish-year=2009&amp;finish-month=03&amp;finish-day=31&amp;finish-hour=23">
				<response-code value="200" />
				<regex
					pattern="MPAN Core,Site Code,Site Name,Account,From,To,net-gbp,tlm,ccl-kwh,ccl-rate,ccl-gbp,data-collection-gbp,duos-availability-agreed-kva,duos-availability-billed-kva,duos-availability-rate,duos-availability-gbp,duos-day-kwh,duos-day-gbp,duos-night-kwh,duos-night-gbp,duos-reactive-rate,duos-reactive-gbp,duos-standing-gbp,settlement-gbp,night-msp-kwh,night-gsp-kwh,night-gbp,other-msp-kwh,other-gsp-kwh,other-gbp,summer-pk-msp-kwh,summer-pk-gsp-kwh,summer-pk-gbp,winter-low-pk-msp-kwh,winter-low-pk-gsp-kwh,winter-low-pk-gbp,winter-off-pk-msp-kwh,winter-off-pk-gsp-kwh,winter-off-pk-gbp,winter-pk-msp-kwh,winter-pk-gsp-kwh,winter-pk-gbp,bsuos-kwh,bsuos-rate,bsuos-gbp,triad-actual-0-date,triad-actual-0-msp-kw,triad-actual-0-status,triad-actual-0-laf,triad-actual-0-gsp-kw,triad-actual-1-date,triad-actual-1-msp-kw,triad-actual-1-status,triad-actual-1-laf,triad-actual-1-gsp-kw,triad-actual-2-date,triad-actual-2-msp-kw,triad-actual-2-status,triad-actual-2-laf,triad-actual-2-gsp-kw,triad-actual-gsp-kw,triad-actual-rate,triad-actual-gbp,triad-estimate-0-date,triad-estimate-0-msp-kw,triad-estimate-0-status,triad-estimate-0-laf,triad-estimate-0-gsp-kw,triad-estimate-1-date,triad-estimate-1-msp-kw,triad-estimate-1-status,triad-estimate-1-laf,triad-estimate-1-gsp-kw,triad-estimate-2-date,triad-estimate-2-msp-kw,triad-estimate-2-status,triad-estimate-2-laf,triad-estimate-2-gsp-kw,triad-estimate-gsp-kw,triad-estimate-rate,triad-estimate-months,triad-estimate-gbp,triad-all-estimates-months,triad-all-estimates-gbp" />
				<regex
					pattern='"20 6354 2983 571","CI017","Roselands","141 5532","2009-03-01T00:00Z","2009-03-31T23:30Z","2273.8","1.0099028","0","0.00456","0","5.89","2300","2300","0","2165.0","0","0","0","0.0","0","0","14.91","88","0","0","0.0","0","0.0","0.0","0","0","0.0","0","0","0.0","0","0","0.0","0","0","0.0","0.0","0.00080602","0.0","2009-01-06T17:00Z","0","E","1.095","0.0","2008-12-01T17:00Z","0","E","1.095","0.0","2008-12-15T17:00Z","0","E","1.095","0.0","0.0","22.19481","0.0","2007-12-17T17:00Z","0","E","1.095","0.0","2008-01-03T17:00Z","0","E","1.079","0.0","2007-11-26T17:00Z","0","E","1.095","0.0","0.0","22.19481","1","0.0","12","-0.0","problem",""' />
			</request>
		</test>
		<test name="Create a supply, and then delete it.">
			<request path="/chellow/sites/5/" method="post">
				<control name="source-id" value="1" />
				<control name="name" value="Supply 54" />
				<control name="start-year" value="2010" />
				<control name="start-month" value="05" />
				<control name="start-day" value="26" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="meter-serial-number" value="" />
				<control name="gsp-group-id" value="3" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 9879 0084 358" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="dc-22 9879 0084 358" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="import-mpan-core" value="22 9879 0084 358" />
				<control name="import-llfc-code" value="540" />
				<control name="import-agreed-supply-capacity" value="700" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="d" />
				<control name="export-mpan-core" value="" />
				<control name="insert" value="Insert" />

				<regex pattern="/chellow/supplies/13/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplies/13/" method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Test importing of sse.edi bills">
			<request path="/chellow/supplier-contracts/" method="post">
				<control name="participant-id" value="6" />
				<control name="name" value="Non half-hourlies 2010" />
				<control name="start-year" value="2010" />
				<control name="start-month" value="01" />
				<control name="start-day" value="01" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<regex pattern="/chellow/supplier-contracts/18/" />
			</request>

			<request path="/chellow/supplier-contracts/18/" method="post">
				<control name="participant-id" value="6" />
				<control name="name" value="Non half-hourlies 2010" />
				<control name="charge-script">
				<![CDATA[
def import_virtual_bill_titles():
    return ['net-gbp']


def import_virtual_bill(supply_source):
    sum_msp_kwh = sum(h['msp-kwh'] for h in supply_source.hh_data)
    return {'net-gbp': sum_msp_kwh * 0.1, 'sum-msp-kwh': sum_msp_kwh, 'problem': ''}]]>
				</control>
				<response-code value="200" />
			</request>

			<!-- Add new generation -->
			<request path="/chellow/supplies/11/generations/" method="post">
				<control name="start-year" value="2010" />
				<control name="start-month" value="01" />
				<control name="start-day" value="01" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<regex pattern="/chellow/supplies/11/generations/19/" />
				<response-code value="303" />
			</request>

			<!-- Change to new supplier contract -->
			<request path="/chellow/supplies/11/generations/19/" method="post">
				<control name="start-year" value="2010" />
				<control name="start-month" value="01" />
				<control name="start-day" value="03" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="false" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 1065 3921 534" />
				<control name="hhdc-contract-id" value="2" />
				<control name="hhdc-account" value="dc-22 1065 3921 534" />
				<control name="meter-serial-number" value="I02D89150" />
				<control name="pc-id" value="3" />
				<control name="mtc-code" value="801" />
				<control name="cop-id" value="6" />
				<control name="ssc-code" value="0393" />
				<control name="has-import-mpan" value="true" />
				<control name="import-llfc-code" value="110" />
				<control name="import-mpan-core" value="22 1065 3921 534" />
				<control name="import-agreed-supply-capacity" value="30" />
				<control name="import-supplier-contract-id" value="18" />
				<control name="import-supplier-account" value="SA342376000" />
				<control name="has-export-mpan" value="false" />
				<response-code value="200" />
			</request>

			<!-- Create a new batch -->
			<request path="/chellow/supplier-contracts/18/batches/"
				method="post">
				<control name="reference" value="07-008" />
				<control name="description" value="SSE batch" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplier-contracts/18/batches/5/bill-imports/"
				method="post">
				<control type="file" name="file" value="bills.sse.edi" />
				<response-code value="303" />
				<regex pattern="/supplier-contracts/18/batches/5/bill-imports/3/" />
			</request>
			<request path="/chellow/supplier-contracts/18/batches/5/bill-imports/3/">
				<refresh />
				<regex
					pattern='&lt;th&gt;Reference&lt;/th&gt;&lt;th&gt;Account Reference&lt;/th&gt;&lt;th&gt;MPANs&lt;/th&gt;&lt;th&gt;Issue Date&lt;/th&gt;&lt;th&gt;Start Date&lt;/th&gt;&lt;th&gt;Finish Date&lt;/th&gt;&lt;th&gt;kWh&lt;/th&gt;&lt;th&gt;Net&lt;/th&gt;&lt;th&gt;VAT&lt;/th&gt;&lt;th&gt;Type&lt;/th&gt;&lt;th&gt;Breakdown&lt;/th&gt;&lt;th&gt;R1 MPAN&lt;/th&gt;&lt;th&gt;R1 Meter Serial Number&lt;/th&gt;&lt;th&gt;R1 Coefficient&lt;/th&gt;&lt;th&gt;R1 Units&lt;/th&gt;&lt;th&gt;R1 TPR&lt;/th&gt;&lt;th&gt;R1 Previous Read Date&lt;/th&gt;&lt;th&gt;R1 Previous Read Value&lt;/th&gt;&lt;th&gt;R1 Previous Read Type&lt;/th&gt;&lt;th&gt;R1 Present Read Date&lt;/th&gt;&lt;th&gt;R1 Present Read Value&lt;/th&gt;&lt;th&gt;R1 Present Read Type&lt;/th&gt;&lt;th&gt;R2 MPAN&lt;/th&gt;&lt;th&gt;R2 Meter Serial Number&lt;/th&gt;&lt;th&gt;R2 Coefficient&lt;/th&gt;&lt;th&gt;R2 Units&lt;/th&gt;&lt;th&gt;R2 TPR&lt;/th&gt;&lt;th&gt;R2 Previous Read Date&lt;/th&gt;&lt;th&gt;R2 Previous Read Value&lt;/th&gt;&lt;th&gt;R2 Previous Read Type&lt;/th&gt;&lt;th&gt;R2 Present Read Date&lt;/th&gt;&lt;th&gt;R2 Present Read Value&lt;/th&gt;&lt;th&gt;R2 Present Read Type&lt;/th&gt;&lt;th&gt;R3 MPAN&lt;/th&gt;&lt;th&gt;R3 Meter Serial Number&lt;/th&gt;&lt;th&gt;R3 Coefficient&lt;/th&gt;&lt;th&gt;R3 Units&lt;/th&gt;&lt;th&gt;R3 TPR&lt;/th&gt;&lt;th&gt;R3 Previous Read Date&lt;/th&gt;&lt;th&gt;R3 Previous Read Value&lt;/th&gt;&lt;th&gt;R3 Previous Read Type&lt;/th&gt;&lt;th&gt;R3 Present Read Date&lt;/th&gt;&lt;th&gt;R3 Present Read Value&lt;/th&gt;&lt;th&gt;R3 Present Read Type&lt;/th&gt;&lt;th&gt;R4 MPAN&lt;/th&gt;&lt;th&gt;R4 Meter Serial Number&lt;/th&gt;&lt;th&gt;R4 Coefficient&lt;/th&gt;&lt;th&gt;R4 Units&lt;/th&gt;&lt;th&gt;R4 TPR&lt;/th&gt;&lt;th&gt;R4 Previous Read Date&lt;/th&gt;&lt;th&gt;R4 Previous Read Value&lt;/th&gt;&lt;th&gt;R4 Previous Read Type&lt;/th&gt;&lt;th&gt;R4 Present Read Date&lt;/th&gt;&lt;th&gt;R4 Present Read Value&lt;/th&gt;&lt;th&gt;R4 Present Read Type&lt;/th&gt;' />
				<regex
					pattern='&lt;td&gt;3423760005&lt;/td&gt;&lt;td&gt;SA342376000&lt;/td&gt;&lt;td&gt;03 801 110 22 10653921534&lt;/td&gt;&lt;td&gt;2010-05-12&lt;/td&gt;&lt;td&gt;2010-01-19&lt;/td&gt;&lt;td&gt;2010-04-20&lt;/td&gt;&lt;td&gt;253&lt;/td&gt;&lt;td&gt;36.16&lt;/td&gt;&lt;td&gt;1.8&lt;/td&gt;&lt;td&gt;N&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;03 801 110 22 1065 3921 534&lt;/td&gt;&lt;td&gt;K87D74429&lt;/td&gt;&lt;td&gt;00001&lt;/td&gt;&lt;td&gt;1&lt;/td&gt;&lt;td&gt;kWh&lt;/td&gt;&lt;td&gt;2010-01-18&lt;/td&gt;&lt;td&gt;16963&lt;/td&gt;&lt;td&gt;E&lt;/td&gt;&lt;td&gt;2010-04-20&lt;/td&gt;&lt;td&gt;17216&lt;/td&gt;&lt;td&gt;E&lt;/td&gt;' />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>


			<!-- Test the bill checking -->
			<request path="/chellow/reports/111/output/?batch-id=5">
				<refresh />
				<regex
					pattern='batch,bill-reference,bill-type,bill-kwh,bill-net-gbp,bill-vat-gbp, bill-start-date,bill-finish-date,bill-mpan-core,site-code,site-name,covered-from,covered-to,covered-bills,covered-net-gbp,virtual-net-gbp,difference-net-gbp' />
				<regex
					pattern='"07-008","3423760005","N","253","36.16","1.8","2010-01-19T00:00Z","2010-04-20T23:30Z","22 1065 3921 534","CI017","Roselands","2010-01-19T00:00Z","2010-04-20T23:30Z","8","36.16","25.3","10.86","virtual-problem","","","","virtual-sum-msp-kwh","253.0","covered-sum-msp-kwh","253.0"' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Test reports for a supply-less site">
			<!-- Create a new site -->
			<request path="/chellow/sites/" method="post">
				<control name="code" value="B00LG" />
				<control name="name" value="Bieling" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/13/output/?site-id=8">
				<response-code value="200" />
			</request>
		</test>
		<test name="Check can import channel snag ignores okay.">
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="channel-snag-ignores.xml" />
				<response-code value="303" />
				<regex pattern="/chellow/general-imports/14/" />
			</request>
			<request path="/chellow/general-imports/14/">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check can import site snag ignores okay.">
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="site-snag-ignores.xml" />
				<response-code value="303" />
				<regex pattern="/chellow/general-imports/15/" />
			</request>
			<request path="/chellow/general-imports/15/">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Create a supply, and then delete it.">
			<request path="/chellow/sites/7/" method="post">
				<control name="source-id" value="3" />
				<control name="generator-type-id" value="2" />
				<control name="name" value="Supply H8" />
				<control name="start-year" value="2010" />
				<control name="start-month" value="05" />
				<control name="start-day" value="26" />
				<control name="start-hour" value="05" />
				<control name="start-minute" value="26" />
				<control name="meter-serial-number" value="" />
				<control name="gsp-group-id" value="3" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 9879 0084 358" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="dc-22 9879 0084 358" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="import-mpan-core" value="22 9879 0084 358" />
				<control name="import-llfc-code" value="540" />
				<control name="import-agreed-supply-capacity" value="700" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="d" />
				<control name="export-mpan-core" value="" />
				<control name="insert" value="Insert" />

				<regex pattern="/chellow/supplies/14/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplies/14/" method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="GDF CSV Bills">
			<!-- Create a new batch -->
			<request path="/chellow/supplier-contracts/4/batches/"
				method="post">
				<control name="reference" value="008" />
				<control name="description" value="GDF CSV batch" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplier-contracts/4/batches/6/bill-imports/"
				method="post">
				<control type="file" name="file" value="bills.gdf.csv" />
				<response-code value="303" />
				<regex pattern="/supplier-contracts/4/batches/6/bill-imports/4/" />
			</request>
			<request path="/chellow/supplier-contracts/4/batches/6/bill-imports/4/">
				<refresh />
				<regex
					pattern='&lt;th&gt;Reference&lt;/th&gt;&lt;th&gt;Account Reference&lt;/th&gt;&lt;th&gt;MPANs&lt;/th&gt;&lt;th&gt;Issue Date&lt;/th&gt;&lt;th&gt;Start Date&lt;/th&gt;&lt;th&gt;Finish Date&lt;/th&gt;&lt;th&gt;kWh&lt;/th&gt;&lt;th&gt;Net&lt;/th&gt;&lt;th&gt;VAT&lt;/th&gt;&lt;th&gt;Type&lt;/th&gt;&lt;th&gt;Breakdown&lt;/th&gt;&lt;th&gt;R1 MPAN&lt;/th&gt;&lt;th&gt;R1 Meter Serial Number&lt;/th&gt;&lt;th&gt;R1 Coefficient&lt;/th&gt;&lt;th&gt;R1 Units&lt;/th&gt;&lt;th&gt;R1 TPR&lt;/th&gt;&lt;th&gt;R1 Previous Read Date&lt;/th&gt;&lt;th&gt;R1 Previous Read Value&lt;/th&gt;&lt;th&gt;R1 Previous Read Type&lt;/th&gt;&lt;th&gt;R1 Present Read Date&lt;/th&gt;&lt;th&gt;R1 Present Read Value&lt;/th&gt;&lt;th&gt;R1 Present Read Type&lt;/th&gt;&lt;th&gt;R2 MPAN&lt;/th&gt;&lt;th&gt;R2 Meter Serial Number&lt;/th&gt;&lt;th&gt;R2 Coefficient&lt;/th&gt;&lt;th&gt;R2 Units&lt;/th&gt;&lt;th&gt;R2 TPR&lt;/th&gt;&lt;th&gt;R2 Previous Read Date&lt;/th&gt;&lt;th&gt;R2 Previous Read Value&lt;/th&gt;&lt;th&gt;R2 Previous Read Type&lt;/th&gt;&lt;th&gt;R2 Present Read Date&lt;/th&gt;&lt;th&gt;R2 Present Read Value&lt;/th&gt;&lt;th&gt;R2 Present Read Type&lt;/th&gt;&lt;th&gt;R3 MPAN&lt;/th&gt;&lt;th&gt;R3 Meter Serial Number&lt;/th&gt;&lt;th&gt;R3 Coefficient&lt;/th&gt;&lt;th&gt;R3 Units&lt;/th&gt;&lt;th&gt;R3 TPR&lt;/th&gt;&lt;th&gt;R3 Previous Read Date&lt;/th&gt;&lt;th&gt;R3 Previous Read Value&lt;/th&gt;&lt;th&gt;R3 Previous Read Type&lt;/th&gt;&lt;th&gt;R3 Present Read Date&lt;/th&gt;&lt;th&gt;R3 Present Read Value&lt;/th&gt;&lt;th&gt;R3 Present Read Type&lt;/th&gt;&lt;th&gt;R4 MPAN&lt;/th&gt;&lt;th&gt;R4 Meter Serial Number&lt;/th&gt;&lt;th&gt;R4 Coefficient&lt;/th&gt;&lt;th&gt;R4 Units&lt;/th&gt;&lt;th&gt;R4 TPR&lt;/th&gt;&lt;th&gt;R4 Previous Read Date&lt;/th&gt;&lt;th&gt;R4 Previous Read Value&lt;/th&gt;&lt;th&gt;R4 Previous Read Type&lt;/th&gt;&lt;th&gt;R4 Present Read Date&lt;/th&gt;&lt;th&gt;R4 Present Read Value&lt;/th&gt;&lt;th&gt;R4 Present Read Type&lt;/th&gt;' />
				<regex
					pattern='&lt;td&gt;KUH773&lt;/td&gt;&lt;td&gt;02&lt;/td&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;2010-06-09&lt;/td&gt;&lt;td&gt;2010-05-01&lt;/td&gt;&lt;td&gt;2010-05-31&lt;/td&gt;&lt;td&gt;32124.5&lt;/td&gt;&lt;td&gt;2219.41&lt;/td&gt;&lt;td&gt;388.4&lt;/td&gt;&lt;td&gt;N&lt;/td&gt;&lt;td&gt;&lt;/td&gt;' />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>
		<test name="Test displaced virtual bill.">
			<request
				path="/chellow/reports/109/output/?site-id=1&amp;months=1&amp;end-year=2010&amp;end-month=06">
				<refresh />
				<regex
					pattern='Site Code,Site Name,Associated Site Ids,From,To,Gen Types,CHP kWh,LM kWh, Turbine kWh,net-gbp' />
				<regex
					pattern='"CI004","Lower Treave","","2010-06-01T00:00Z","2010-06-30T23:30Z","chp",,,,"0.0","bsuos-gbp","0.0","bsuos-kwh","0.0","bsuos-rate","0.00152641","ccl-rate","0.0047","duos-green-gbp","0.0","duos-green-kwh","0","duos-green-rate","0.0013","night-gbp","0.0","night-gsp-kwh","0","night-msp-kwh","0","other-gbp","0.0","other-gsp-kwh","0.0","other-msp-kwh","0","problem","","summer-pk-gbp","0.0","summer-pk-gsp-kwh","0","summer-pk-msp-kwh","0","tlm","1.008955","triad-estimate-0-date","2010-01-07T17:00Z","triad-estimate-0-gsp-kw","0.0","triad-estimate-0-laf","1.078","triad-estimate-0-msp-kw","0","triad-estimate-0-status","E","triad-estimate-1-date","2010-01-25T17:00Z","triad-estimate-1-gsp-kw","0.0","triad-estimate-1-laf","1.078","triad-estimate-1-msp-kw","0","triad-estimate-1-status","E","triad-estimate-2-date","2009-12-15T17:00Z","triad-estimate-2-gsp-kw","0.0","triad-estimate-2-laf","1.078","triad-estimate-2-msp-kw","0","triad-estimate-2-status","E","triad-estimate-gbp","0.0","triad-estimate-gsp-kw","0.0","triad-estimate-months","1","triad-estimate-rate","26.057832","winter-low-pk-gbp","0.0","winter-low-pk-gsp-kwh","0","winter-low-pk-msp-kwh","0","winter-off-pk-gbp","0.0","winter-off-pk-gsp-kwh","0","winter-off-pk-msp-kwh","0","winter-pk-gbp","0.0","winter-pk-gsp-kwh","0","winter-pk-msp-kwh","0"' />

				<response-code value="200" />
			</request>
			<request
				path="/chellow/reports/109/output/?site-id=1&amp;months=12&amp;end-year=2010&amp;end-month=06">
				<refresh />
				<response-code value="200" />
			</request>
		</test>
		<test name="Test bulk ignore.">
			<request path="/chellow/hhdc-contracts/0/" method="post">
				<control name="ignore-year" value="2008" />
				<control name="ignore-month" value="09" />
				<control name="ignore-day" value="01" />
				<control name="ignore-snags" value="Ignore Snags" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check that a generation can be deleted.">
			<request path="/chellow/supplies/2/generations/15/" method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test
			name="Check a contract virtual bill that crosses a generation boundary comes out correctly.">
			<!-- Put in an import virtual bill function -->
			<request path="/chellow/supplier-contracts/10/" method="post">
				<control name="participant-id" value="180" /> <!-- HYDE -->
				<control name="name" value="Non half-hourlies 2007" />
				<control name="charge-script">
				<![CDATA[
def import_virtual_bill_titles():
    return ['net-gbp', 'vat-gbp', 'gross-gbp', 'problem']


def import_virtual_bill(supply_source):
    return {'net-gbp': 0.0, 'vat-gbp':0.0, 'gross-gbp': 0.0, 'problem': ''}]]>
				</control>
				<response-code value="200" />
			</request>
			<request
				path="/chellow/reports/87/output/?supply-id=12&amp;supply-polarity=import&amp;start-year=2010&amp;start-month=04&amp;start-day=01&amp;start-hour=00&amp;finish-year=2010&amp;finish-month=04&amp;finish-day=30&amp;finish-hour=23">
				<response-code value="200" />
				<regex
					pattern="MPAN Core,Site Code,Site Name,Account,From,To,net-gbp,vat-gbp,gross-gbp,problem" />
				<regex
					pattern='"22 9974 3438 105","CI005","Wheal Rodney","341665","2010-04-01T00:00Z","2010-04-13T23:30Z","0.0","0.0","0.0",""' />
			</request>
		</test>
		<test name="NHH CSV import">
			<request path="/chellow/supplier-contracts/18/batches/"
				method="post">
				<control name="reference" value="07-002" />
				<control name="description" value="nhh csv batch" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplier-contracts/18/batches/7/bill-imports/"
				method="post">
				<control type="file" name="file" value="bills-nhh.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/supplier-contracts/18/batches/7/bill-imports/5/" />

			</request>
			<request path="/chellow/supplier-contracts/18/batches/7/bill-imports/5/">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
			<request path="/chellow/supplier-contracts/18/batches/7/bills/10/reads/7/">
				<regex
					pattern='31&lt;/option&gt;&lt;/select&gt; &lt;select name="present-hour"&gt;&lt;option value="00" selected&gt;00&lt;/option&gt;' />
				<regex
					pattern='&lt;select name="present-minute"&gt;&lt;option value="00" selected&gt;00&lt;/option&gt;' />
			</request>
		</test>
		<test name="Test viewers' search">
			<request path="/chellow/reports/99/output/?search-pattern=">
				<regex
					pattern='&lt;td&gt;&lt;a href="/chellow/reports/7/output/\?supply-id=10"&gt;supply&lt;/a&gt;&lt;/td&gt;&lt;td&gt;P96C93722&lt;/td&gt;' />
				<response-code value="200" />
			</request>

			<!-- Check that searching for an account with a space works -->
			<request path="/chellow/reports/99/output/?search-pattern=141%205532">
				<regex pattern='/chellow/reports/7/output/\?supply-id=7' />
				<response-code value="307" />
			</request>

			<!-- Check that searching on an MSN works -->
			<request path="/chellow/reports/99/output/?search-pattern=P96C93722">
				<regex pattern='/chellow/reports/7/output/\?supply-id=10' />
				<response-code value="307" />
			</request>
		</test>

		<test name="Check can view a supply.">
			<request path="/chellow/reports/7/output/?supply-id=3">
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Check that if the end date of a generation is altered, it can tell if there's a succeeding generation.">
			<request path="/chellow/supplies/11/generations/12/" method="post">
				<control name="start-year" value="2005" />
				<control name="start-month" value="09" />
				<control name="start-day" value="06" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="is-ended" value="true" />
				<control name="finish-year" value="2010" />
				<control name="finish-month" value="01" />
				<control name="finish-day" value="03" />
				<control name="finish-hour" value="23" />
				<control name="finish-minute" value="30" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 1065 3921 534" />
				<control name="hhdc-contract-id" value="2" />
				<control name="hhdc-account" value="dc-22 1065 3921 534" />
				<control name="meter-serial-number" value="I02D89150" />
				<control name="pc-id" value="3" />
				<control name="mtc-code" value="801" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="0393" />
				<control name="has-import-mpan" value="true" />
				<control name="import-llfc-code" value="110" />
				<control name="import-mpan-core" value="22 1065 3921 534" />
				<control name="import-agreed-supply-capacity" value="30" />
				<control name="import-supplier-contract-id" value="10" />
				<control name="import-supplier-account" value="SA342376" />
				<control name="has-export-mpan" value="false" />

				<response-code value="200" />
			</request>
		</test>
		<test
			name="Check that it works if a supply generation is inserted by CSV before the beginning of a supply ">
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="supply-generation-insert.csv" />
				<response-code value="303" />
				<regex pattern="/general-imports/16/" />
			</request>
			<request path="/chellow/general-imports/16/">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
			<request path="/chellow/supplies/10/generations/22/">
				<!-- Check the import supplier account is there -->
				<regex pattern="341664" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check that the general import of register reads works.">
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file" value="bills-general.csv" />
				<response-code value="303" />
				<regex pattern="/general-imports/17/" />
			</request>
			<request path="/chellow/general-imports/17/">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/105/output/?bill-id=11">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex
					pattern='&lt;td&gt;38992&lt;/td&gt;&lt;td&gt;&lt;a title="Estimated" href="/chellow/reports/143/output/\?type-id=4"&gt;E&lt;/a&gt;&lt;/td&gt;&lt;td&gt;2007-01-17 00:00&lt;/td&gt;&lt;td&gt;39000&lt;/td&gt;&lt;td&gt;&lt;a title="Estimated" href="/chellow/reports/143/output/\?type-id=4"&gt;E&lt;/a&gt;&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Can we export hh data in general import format for a particular supply?">
			<request
				path="/chellow/reports/31/output/?is-core=false&amp;has-supplies=true&amp;mpan-core=22%209205%206799%20106">
				<response-code value="200" />
				<regex
					pattern="&lt;value&gt;&lt;!\[CDATA\[22 0470 7514 535\]\]&gt;&lt;/value&gt;" />
			</request>
		</test>
		<test name="Check the 'update bill' page.">
			<request path="/chellow/supplier-contracts/18/batches/5/bills/8/">
				<response-code value="200" />
				<regex pattern="type-id" />
				<regex pattern='&lt;option value="2" selected&gt;N Normal&lt;/option&gt;' />
				<regex pattern='name="account" value="SA342376000"' />
			</request>
		</test>
		<test name="Check the batch page.">
			<request path="/chellow/reports/91/output/?batch-id=5">
				<response-code value="200" />
				<regex
					pattern="&lt;td&gt;2010-01-19 00:00&lt;/td&gt;&lt;td&gt;2010-04-20 23:30&lt;/td&gt;" />
			</request>
		</test>
		<test name="Test supply generation update for a supply with 2 mpans.">
			<request path="/chellow/general-imports/" method="post">
				<control type="file" name="import-file"
					value="supply-generation-update-2-mpans.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/general-imports/18/" />
			</request>
			<request path="/chellow/general-imports/18/">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Add batch to HHDC contract">
			<!-- Insert a new batch -->
			<request path="/chellow/hhdc-contracts/0/batches/" method="post">
				<control name="reference" value="001-7t" />
				<control name="description" value="hhdc batch" />
				<response-code value="303" />
				<regex pattern="/reports/203/output/\?batch-id=8" />
			</request>

			<!-- Check that it's there to edit -->
			<request path="/chellow/hhdc-contracts/0/batches/8/">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try adding bills to the HHDC batch">
			<request path="/chellow/hhdc-contracts/0/batches/8/bill-imports/"
				method="post">
				<control type="file" name="file" value="hhdc-bill.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/hhdc-contracts/0/batches/8/bill-imports/6/" />
			</request>
			<request path="/chellow/hhdc-contracts/0/batches/8/bill-imports/6/">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>
		<test name="Add batch to MOP contract">
			<!-- Insert a new batch -->
			<request path="/chellow/mop-contracts/8/batches/" method="post">
				<control name="reference" value="99/992" />
				<control name="description" value="mop batch" />
				<response-code value="303" />
				<regex pattern="/reports/193/output/\?batch-id=9" />
			</request>

			<!-- Check that it's there -->
			<request path="/chellow/mop-contracts/8/batches/9/">
				<response-code value="200" />
			</request>

			<!-- Check we can see it in 'view' mode -->
			<request path="/chellow/reports/193/output/?batch-id=9">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try adding bills to the MOP batch">
			<request path="/chellow/mop-contracts/8/batches/9/bill-imports/"
				method="post">
				<control type="file" name="file" value="mop-bill.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/mop-contracts/8/batches/9/bill-imports/7/" />
			</request>
			<request path="/chellow/mop-contracts/8/batches/9/bill-imports/7/">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>
		<test
			name="If a new supply has a blank LLFC field, check it gives a good error message.">
			<request path="/chellow/sites/7/" method="post">
				<control name="source-id" value="1" />
				<control name="name" value="Supply 54" />
				<control name="start-year" value="2010" />
				<control name="start-month" value="05" />
				<control name="start-day" value="26" />
				<control name="meter-serial-number" value="" />
				<control name="gsp-group-id" value="3" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 9879 0084 358" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="dc-22 9879 0084 358" />
				<control name="pc-id" value="9" />
				<control name="mtc-code" value="845" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="" />
				<control name="import-mpan-core" value="22 9879 0084 358" />
				<control name="import-llfc-code" value="" />
				<control name="import-agreed-supply-capacity" value="700" />
				<control name="import-supplier-contract-id" value="4" />
				<control name="import-supplier-account" value="d" />
				<control name="export-mpan-core" value="" />
				<control name="insert" value="Insert" />

				<regex pattern="The LLFC must be an integer between 0 and 999" />
				<response-code value="418" />
			</request>
		</test>
		<test name="Try out simple.csv hh import format.">
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh.simple.csv" />
				<response-code value="303" />
				<regex pattern="/reports/65/output/\?hhdc-contract-id=0&amp;process-id=13" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=13">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
			<!-- Check that the datum has been correctly loaded in -->
			<request
				path="/chellow/reports/17/output/?supply-id=8&amp;months=1&amp;finish-year=2010&amp;finish-month=02">
				<regex
					pattern="&lt;td&gt;2010-02-04 20:00Z&lt;/td&gt;[\r\n]*&lt;td&gt;30.4339&lt;/td&gt;" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try editor view of meter payment types.">
			<request path="/chellow/meter-payment-types/">
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Try a monthly sites duration for a site with a 3rd party supply.">
			<request path="/chellow/sites/4/" method="post">
				<control name="source-id" value="5" />
				<control name="name" value="3" />
				<control name="start-year" value="2010" />
				<control name="start-month" value="05" />
				<control name="start-day" value="26" />
				<control name="meter-serial-number" value="" />
				<control name="gsp-group-id" value="3" />
				<control name="mop-contract-id" value="8" />
				<control name="mop-account" value="mc-22 9789 0534 938" />
				<control name="hhdc-contract-id" value="0" />
				<control name="hhdc-account" value="dc-22 9789 0534 938" />
				<control name="pc-id" value="3" />
				<control name="mtc-code" value="801" />
				<control name="cop-id" value="5" />
				<control name="ssc-code" value="393" />
				<control name="import-mpan-core" value="22 9789 0534 938" />
				<control name="import-llfc-code" value="110" />
				<control name="import-agreed-supply-capacity" value="0" />
				<control name="import-supplier-contract-id" value="18" />
				<control name="import-supplier-account" value="taa2" />
				<control name="export-mpan-core" value="" />
				<control name="insert" value="Insert" />

				<regex pattern="/chellow/supplies/16/" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/161/output/?site-code=CI017&amp;months=1&amp;end-year=2010&amp;end-month=07">
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/251/output/">
				<refresh />
				<regex pattern="FINISHED_site_monthly_duration_for_CI017_1_to_2010_7.csv" />
				<response-code value="200" />
			</request>
			<request
				path="/chellow/reports/253/output/?name=FINISHED_site_monthly_duration_for_CI017_1_to_2010_7.csv">
				<regex
					pattern='"CI017","Roselands","","3rd-party,net","","2010-07-31","0","0","0","0","0","0","0","0","1869.26","0","0","1869.26","0","0","0","hh",""' />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Try creating and deleting a rate script for a non-core contract.">
			<request path="/chellow/non-core-contracts/39/rate-scripts/"
				method="post">
				<control name="start-year" value="2010" />
				<control name="start-month" value="04" />
				<control name="start-day" value="01" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="insert" value="Insert" />

				<regex pattern="/chellow/non-core-contracts/39/rate-scripts/777/" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/non-core-contracts/39/rate-scripts/777/?view=confirm-delete">
				<regex pattern="Are you sure you want to delete this rate script\?" />
				<response-code value="200" />
			</request>
			<request path="/chellow/non-core-contracts/39/rate-scripts/777/"
				method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
			<request path="/chellow/non-core-contracts/39/rate-scripts/777/">
				<response-code value="404" />
			</request>
		</test>
		<test name="Try adding a rate script before other rate scripts.">
			<request path="/chellow/non-core-contracts/39/rate-scripts/"
				method="post">
				<control name="start-year" value="1999" />
				<control name="start-month" value="04" />
				<control name="start-day" value="01" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<control name="insert" value="Insert" />

				<regex pattern="/chellow/non-core-contracts/39/rate-scripts/779/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/non-core-contracts/39/rate-scripts/779/">
				<regex
					pattern='&lt;input name="finish-year" size="4" maxlength="4" value="2007"&gt;' />

				<!-- Check that the start hour of a non-core rate script is correct." -->
				<regex
					pattern='&lt;select name="start-hour"&gt;&lt;option value="00" selected&gt;00&lt;/option&gt;' />

				<response-code value="200" />
			</request>
			<request path="/chellow/non-core-contracts/39/rate-scripts/779/"
				method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Adding a bill manually.">
			<request path="/chellow/supplier-contracts/4/batches/6/bills/"
				method="post">
				<control name="mpan-core" value="22 9813 2107 763" />
				<control name="reference" value="KUH774" />
				<control name="issue-year" value="2010" />
				<control name="issue-month" value="12" />
				<control name="issue-day" value="06" />
				<control name="start-year" value="2010" />
				<control name="start-month" value="12" />
				<control name="start-day" value="06" />
				<control name="finish-year" value="2010" />
				<control name="finish-month" value="12" />
				<control name="finish-day" value="06" />
				<control name="kwh" value="0" />
				<control name="net" value="0" />
				<control name="vat" value="0" />
				<control name="gross" value="0" />
				<control name="account" value="02" />
				<control name="bill-type-id" value="1" />
				<control name="breakdown" value="" />
				<regex pattern="/chellow/supplier-contracts/4/batches/6/bills/14/" />
				<response-code value="303" />
			</request>
			<request path="/chellow/supplier-contracts/4/batches/6/bills/14/">
				<regex
					pattern='&lt;select name="start-day"&gt;&lt;option value="01"&gt;01&lt;/option&gt;&lt;option value="02"&gt;02&lt;/option&gt;&lt;option value="03"&gt;03&lt;/option&gt;&lt;option value="04"&gt;04&lt;/option&gt;&lt;option value="05"&gt;05&lt;/option&gt;&lt;option value="06" selected&gt;06&lt;/option&gt;&lt;option value="07"&gt;07&lt;/option&gt;&lt;option value="08"&gt;08&lt;/option&gt;&lt;option value="09"&gt;09&lt;/option&gt;&lt;option value="10"&gt;10&lt;/option&gt;&lt;option value="11"&gt;11&lt;/option&gt;&lt;option value="12"&gt;12&lt;/option&gt;&lt;option value="13"&gt;13&lt;/option&gt;&lt;option value="14"&gt;14&lt;/option&gt;&lt;option value="15"&gt;15&lt;/option&gt;&lt;option value="16"&gt;16&lt;/option&gt;&lt;option value="17"&gt;17&lt;/option&gt;&lt;option value="18"&gt;18&lt;/option&gt;&lt;option value="19"&gt;19&lt;/option&gt;&lt;option value="20"&gt;20&lt;/option&gt;&lt;option value="21"&gt;21&lt;/option&gt;&lt;option value="22"&gt;22&lt;/option&gt;&lt;option value="23"&gt;23&lt;/option&gt;&lt;option value="24"&gt;24&lt;/option&gt;&lt;option value="25"&gt;25&lt;/option&gt;&lt;option value="26"&gt;26&lt;/option&gt;&lt;option value="27"&gt;27&lt;/option&gt;&lt;option value="28"&gt;28&lt;/option&gt;&lt;option value="29"&gt;29&lt;/option&gt;&lt;option value="30"&gt;30&lt;/option&gt;&lt;option value="31"&gt;31&lt;/option&gt;&lt;/select&gt; &lt;select name="start-hour"&gt;&lt;option value="00" selected&gt;00&lt;/option&gt;&lt;option value="01"&gt;01&lt;/option&gt;&lt;option value="02"&gt;02&lt;/option&gt;&lt;option value="03"&gt;03&lt;/option&gt;&lt;option value="04"&gt;04&lt;/option&gt;&lt;option value="05"&gt;05&lt;/option&gt;&lt;option value="06"&gt;06&lt;/option&gt;&lt;option value="07"&gt;07&lt;/option&gt;&lt;option value="08"&gt;08&lt;/option&gt;&lt;option value="09"&gt;09&lt;/option&gt;&lt;option value="10"&gt;10&lt;/option&gt;&lt;option value="11"&gt;11&lt;/option&gt;&lt;option value="12"&gt;12&lt;/option&gt;&lt;option value="13"&gt;13&lt;/option&gt;&lt;option value="14"&gt;14&lt;/option&gt;&lt;option value="15"&gt;15&lt;/option&gt;&lt;option value="16"&gt;16&lt;/option&gt;&lt;option value="17"&gt;17&lt;/option&gt;&lt;option value="18"&gt;18&lt;/option&gt;&lt;option value="19"&gt;19&lt;/option&gt;&lt;option value="20"&gt;20&lt;/option&gt;&lt;option value="21"&gt;21&lt;/option&gt;&lt;option value="22"&gt;22&lt;/option&gt;&lt;option value="23"&gt;23&lt;/option&gt;&lt;/select&gt;:&lt;select name="start-minute"&gt;&lt;option value="00" selected&gt;00&lt;/option&gt;&lt;option value="30"&gt;30&lt;/option&gt;&lt;/select&gt;' />
				<regex
					pattern='&lt;select name="finish-day"&gt;&lt;option value="01"&gt;01&lt;/option&gt;&lt;option value="02"&gt;02&lt;/option&gt;&lt;option value="03"&gt;03&lt;/option&gt;&lt;option value="04"&gt;04&lt;/option&gt;&lt;option value="05"&gt;05&lt;/option&gt;&lt;option value="06" selected&gt;06&lt;/option&gt;&lt;option value="07"&gt;07&lt;/option&gt;&lt;option value="08"&gt;08&lt;/option&gt;&lt;option value="09"&gt;09&lt;/option&gt;&lt;option value="10"&gt;10&lt;/option&gt;&lt;option value="11"&gt;11&lt;/option&gt;&lt;option value="12"&gt;12&lt;/option&gt;&lt;option value="13"&gt;13&lt;/option&gt;&lt;option value="14"&gt;14&lt;/option&gt;&lt;option value="15"&gt;15&lt;/option&gt;&lt;option value="16"&gt;16&lt;/option&gt;&lt;option value="17"&gt;17&lt;/option&gt;&lt;option value="18"&gt;18&lt;/option&gt;&lt;option value="19"&gt;19&lt;/option&gt;&lt;option value="20"&gt;20&lt;/option&gt;&lt;option value="21"&gt;21&lt;/option&gt;&lt;option value="22"&gt;22&lt;/option&gt;&lt;option value="23"&gt;23&lt;/option&gt;&lt;option value="24"&gt;24&lt;/option&gt;&lt;option value="25"&gt;25&lt;/option&gt;&lt;option value="26"&gt;26&lt;/option&gt;&lt;option value="27"&gt;27&lt;/option&gt;&lt;option value="28"&gt;28&lt;/option&gt;&lt;option value="29"&gt;29&lt;/option&gt;&lt;option value="30"&gt;30&lt;/option&gt;&lt;option value="31"&gt;31&lt;/option&gt;&lt;/select&gt; &lt;select name="finish-hour"&gt;&lt;option value="00"&gt;00&lt;/option&gt;&lt;option value="01"&gt;01&lt;/option&gt;&lt;option value="02"&gt;02&lt;/option&gt;&lt;option value="03"&gt;03&lt;/option&gt;&lt;option value="04"&gt;04&lt;/option&gt;&lt;option value="05"&gt;05&lt;/option&gt;&lt;option value="06"&gt;06&lt;/option&gt;&lt;option value="07"&gt;07&lt;/option&gt;&lt;option value="08"&gt;08&lt;/option&gt;&lt;option value="09"&gt;09&lt;/option&gt;&lt;option value="10"&gt;10&lt;/option&gt;&lt;option value="11"&gt;11&lt;/option&gt;&lt;option value="12"&gt;12&lt;/option&gt;&lt;option value="13"&gt;13&lt;/option&gt;&lt;option value="14"&gt;14&lt;/option&gt;&lt;option value="15"&gt;15&lt;/option&gt;&lt;option value="16"&gt;16&lt;/option&gt;&lt;option value="17"&gt;17&lt;/option&gt;&lt;option value="18"&gt;18&lt;/option&gt;&lt;option value="19"&gt;19&lt;/option&gt;&lt;option value="20"&gt;20&lt;/option&gt;&lt;option value="21"&gt;21&lt;/option&gt;&lt;option value="22"&gt;22&lt;/option&gt;&lt;option value="23" selected&gt;23&lt;/option&gt;&lt;/select&gt;:&lt;select name="finish-minute"&gt;&lt;option value="00"&gt;00&lt;/option&gt;&lt;option value="30" selected&gt;30&lt;/option&gt;&lt;/select&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Deleting a batch with bills with register reads.">
			<request path="/chellow/supplier-contracts/18/batches/5/"
				method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Viewing the batches of a supplier contract in edit mode.">
			<request path="/chellow/supplier-contracts/18/batches/">
				<regex pattern='="description"' />
			</request>
		</test>
		<test name="Viewing the batches of a DC contract in edit mode.">
			<request path="/chellow/hhdc-contracts/0/batches/">
				<regex pattern='="description"' />
			</request>
		</test>
		<test name="Viewing the batches of a MOP contract in edit mode.">
			<request path="/chellow/mop-contracts/8/batches/">
				<regex pattern='="description"' />
			</request>
		</test>
		<test name="Viewing a batch in view mode, when it has a custom report.">
			<request path="/chellow/configuration/" method="post">
				<control name="properties"><![CDATA[batch.report.01=100]]></control>
				<response-code value="200" />
			</request>

			<!-- Check that we can see it okay -->
			<request path="/chellow/reports/193/output/?batch-id=9">
				<response-code value="200" />
			</request>
		</test>
		<test name="Check 'no channel' error when importing hh data.">
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc-contract-id" value="0" />
				<control type="file" name="import-file" value="hh-no-channel.simple.csv" />
				<response-code value="303" />
				<regex pattern="/reports/65/output/\?hhdc-contract-id=0&amp;process-id=14" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc-contract-id=0&amp;process-id=14">
				<refresh />
				<regex
					pattern="There is no channel for the datum: MPAN core: 22 4862 4512 332, Is import\? false, Is Kwh\? true, Start date 2010-02-04T20:00Z, Value 30.4339, Status A." />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Check good error message if new generation has same start date as existing generation.">
			<!-- Can we add a new supply generation ok? -->
			<request path="/chellow/supplies/11/generations/" method="post">
				<control name="start-year" value="2005" />
				<control name="start-month" value="09" />
				<control name="start-day" value="06" />
				<control name="start-hour" value="00" />
				<control name="start-minute" value="00" />
				<regex pattern="There's already a generation with that start date\." />
				<response-code value="418" />
			</request>
		</test>
		<test name="Check MOP and DC bills are displaying correctly">
			<request path="/chellow/reports/7/output/?supply-id=6">
				<regex
					pattern='&lt;td&gt;[\r\n] *&lt;a href="/chellow/reports/203/output/\?batch-id=8"&gt;001-7t&lt;/a&gt;[\r\n] *&lt;/td&gt;[\r\n] *&lt;td&gt;00031&lt;/td&gt;[\r\n] *&lt;td&gt;22 0883 6932 301&lt;/td&gt;' />
				<regex
					pattern='&lt;td&gt;[\r\n] *&lt;a href="/chellow/reports/193/output/\?batch-id=9"&gt;99/992&lt;/a&gt;[\r\n] *&lt;/td&gt;[\r\n] *&lt;td&gt;06&lt;/td&gt;[\r\n] *&lt;td&gt;22 0883 6932 301&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try adding a note.">
			<request path="/chellow/reports/239/output/" method="post">
				<control name="supply_id" value="2" />
				<control name="note"><![CDATA[Some people, when confronted with a problem, think I know,
				I'll use regular expressions. Now they have two problems.]]></control>
				<response-code value="303" />
			</request>
		</test>
	</test-group>
</imprimatur>