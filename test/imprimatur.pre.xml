<?xml version="1.0"?>
<!DOCTYPE imprimatur PUBLIC 
    "-//Imprimatur DTD 009//EN"
    "http://imprimatur.sourceforge.net/imprimatur-009.dtd">
<imprimatur port="8080" hostname="localhost">
	<!-- Users -->
	<test-group>
		<test name="Manipulating users">
			<request path="/chellow/reports/255/output/" method="post">
				<credentials username="watkins@example.com" password="alan" />
				<control name="email_address" value="watkins@example.com" />
				<control name="user_role_code" value="editor" />
				<control name="password" value="alan" />
				<response-code value="303" />
				<regex pattern="/reports/257/output/\?user_id=1" />
			</request>
			<request path="/chellow/reports/255/output/" method="post">
				<control name="email_address" value="lydgate@localhost" />
				<control name="user_role_code" value="editor" />
				<control name="password" value="science" />
				<response-code value="303" />
				<regex pattern="/reports/257/output/\?user_id=2" />
			</request>
			<request path="/chellow/reports/257/output/?user_id=2">
				<regex
					pattern='&lt;input type="hidden" name="user_id" value="2"&gt;\s*&lt;legend&gt;Delete this user&lt;/legend&gt;' />
				<response-code value="200" />
			</request>
			<!-- Check that a duplicate email gives a proper error message -->
			<request path="/chellow/reports/255/output/" method="post">
				<control name="email_address" value="lydgate@localhost" />
				<control name="user_role_code" value="editor" />
				<control name="password" value="science" />
				<regex pattern="already a user with this email address" />
				<response-code value="400" />
			</request>
			<!-- Test that we're able to change the password -->
			<request path="/chellow/reports/257/output/" method="post">
				<control name="user_id" value="2" />
				<control name="current_password" value="science" />
				<control name="new_password" value="rosamund" />
				<control name="confirm_new_password" value="rosamund" />
				<response-code value="303" />
			</request>
			<!-- Test that we can change the role -->
			<request path="/chellow/reports/257/output/" method="post">
				<control name="user_id" value="2" />
				<control name="email_address" value="mary-ann-evans@example.com" />
				<control name="user_role_code" value="editor" />
				<response-code value="303" />
			</request>
			<!-- ...and change it back -->
			<request path="/chellow/reports/257/output/" method="post">
				<control name="user_id" value="2" />
				<control name="email_address" value="lydgate@localhost" />
				<control name="user_role_code" value="editor" />
				<response-code value="303" />
			</request>
		</test>
	</test-group>
	<test-group>
		<test name="Check that invalid email address gives unauthorized.">
			<request path="/chellow/reports/315/output/" method="post">
				<credentials username="godel" password="dancer" />
				<control name="participant_id" value="222" /> <!-- HYDE -->
				<control name="name" value="Non half-hourlies 2007" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="has_finished" value="false" />

				<response-code value="401" />
			</request>
		</test>
		<test name="Check duplicate report name gives good error message">
			<request path="/chellow/reports/" method="post">
				<credentials username="watkins@example.com" password="alan" />
				<control name="name" value="Home" />
				<response-code value="400" />
				<regex pattern="There's already a report with that name\." />
			</request>
		</test>
		<test name="site">
			<!-- Valid -->
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="sites.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=0" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=0">
				<refresh />
				<response-code value="200" />
				<regex pattern="The file has been imported successfully\." />
			</request>

			<!-- duplicates -->
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="sites.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=1" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=1">
				<refresh />
				<regex pattern="There&amp;#39;s already a site with this code\." />
				<response-code value="200" />
			</request>

			<!-- Delete a site -->
			<request path="/chellow/reports/311/output/" method="post">
				<control name="site_id" value="2" />
				<control name="delete" value="Delete" />

				<response-code value="303" />
			</request>

			<!-- Show and and add a site -->
			<request path="/chellow/reports/297/output/">

				<regex pattern="Add a site" />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/297/output/" method="post">
				<control name="code" value="CH017" />
				<control name="name" value="Parbola" />
				<response-code value="303" />
			</request>
		</test>

		<test name="HHDC contracts">
			<request path="/chellow/reports/277/output/" method="post">
				<control name="participant_id" value="58" /> <!-- DASL -->
				<control name="name" value="HH contract" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="has_finished" value="false" />
				<response-code value="303" />
				<regex pattern="/reports/115/output/\?hhdc_contract_id=53" />
			</request>

			<!-- Update Contract -->
			<request path="/chellow/reports/279/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control name="party_id" value="30" /> <!-- DASL -->
				<control name="name" value="HH contract" />
				<control name="charge_script"><![CDATA[
def virtual_bill_titles():
    return ['net-gbp', 'problem']

def virtual_bill(supply_source):
    supply_source.dc_bill['net-gbp'] = 0]]></control>
				<control name="properties" value="{'mpan_map': {'maptest': '2292056799106'}}" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/279/output/?hhdc_contract_id=53">
				<regex pattern="HH contract" />
				<response-code value="200" />
			</request>

			<!-- Check that we can see HHDC rate script okay. Contract 53. -->
			<request path="/chellow/reports/173/output/?hhdc_rate_script_id=305">
				<!-- Check that 'has_finished' field is there -->
				<regex pattern="HH contract" />
				<response-code value="200" />
			</request>

			<!-- Check that we can see the edit view of the HHDC rate script okay. 
				Contract 53. -->
			<request path="/chellow/reports/249/output/?hhdc_rate_script_id=305">
				<!-- Check that 'has_finished' field is there -->
				<regex pattern="has_finished" />

				<!-- Check the hhdc_rate_script_id for update is there -->
				<regex
					pattern='&lt;legend&gt;Update Rate Script&lt;/legend&gt;\s*&lt;input type="hidden" name="hhdc_rate_script_id"\s*value="305"&gt;' />
				<response-code value="200" />
			</request>

			<!-- Check that we can update an HHDC rate script okay -->
			<request path="/chellow/reports/249/output/" method="post">
				<control name="hhdc_rate_script_id" value="305" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="script" value="{}" />
				<response-code value="303" />
			</request>

			<!-- Add another HHDC contract -->
			<request path="/chellow/reports/277/output/" method="post">
				<control name="participant_id" value="58" />
				<control name="name" value="Dynamat data" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<response-code value="303" />
				<regex pattern="/reports/115/output/\?hhdc_contract_id=54" />
			</request>

			<!-- Update the newly added HHDC -->
			<request path="/chellow/reports/279/output/" method="post">
				<control name="hhdc_contract_id" value="54" />
				<control name="party_id" value="30" />
				<control name="name" value="Dynamat data" />
				<control name="charge_script"><![CDATA[
def virtual_bill_titles():
    return ['net-gbp', 'problem']

def virtual_bill(supply_source):
    supply_source.dc_bill['net-gbp'] = 0]]></control>
				<control name="properties" value='{"props": 1}' />
				<response-code value="303" />
			</request>

			<!-- Update state of Dynamat HHDC -->
			<request path="/chellow/reports/279/output/" method="post">
				<control name="hhdc_contract_id" value="54" />
				<control name="update_state" value="" />
				<control name="state" value='{"stat": 2}' />
				<response-code value="303" />
			</request>

			<!-- View Dynamat HHDC -->
			<request path="/chellow/reports/279/output/?hhdc_contract_id=54">
				<response-code value="200" />
				<regex
					pattern='&lt;textarea name="charge_script" rows="40" cols="80"&gt;\s*def virtual_bill_title' />
				<regex
					pattern='&lt;textarea name="properties" rows="40" cols="80"&gt;\{&amp;#34;props&amp;#34;: 1\}&lt;/textarea&gt;' />
				<regex
					pattern='&lt;textarea name="state" rows="40" cols="80"&gt;\{&amp;#34;stat&amp;#34;: 2\}&lt;/textarea&gt;' />
			</request>
		</test>

		<test name="Check one can update the participant for an HHDC contract.">
			<request path="/chellow/reports/279/output/" method="post">
				<control name="hhdc_contract_id" value="54" />
				<control name="party_id" value="651" /> <!-- UKDC -->
				<control name="name" value="Dynamat data" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="has_finished" value="false" />
				<control name="charge_script"><![CDATA[
def virtual_bill_titles():
    return ['net-gbp', 'problem']

def virtual_bill(supply_source):
    supply_source.dc_bill['net-gbp'] = 0]]></control>
				<control name="properties" value="{}" />
				<response-code value="303" />
			</request>

			<!-- Check it's still there -->
			<request path="/chellow/reports/279/output/?hhdc_contract_id=54">
				<response-code value="200" />
				<regex pattern='option value="651" selected' />
			</request>
		</test>
		<test name="Manipulate supplier contracts">
			<!-- Check correct fields present for adding a supplier contract -->
			<request path="/chellow/reports/315/output/">
				<regex pattern='name="start_year"' />
				<response-code value="200" />
			</request>

			<!-- Create a new supplier contract -->
			<request path="/chellow/reports/315/output/" method="post">
				<control name="participant_id" value="25" /> <!-- BIZZ -->
				<control name="name" value="Half-hourlies 2007" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="charge_script"><![CDATA[
def virtual_bill_titles():
    return ['net-gbp', 'vat-gbp', 'rate', 'gross-gbp', 'problem']

def virtual_bill(data_source):
    bill = data_source.supplier_bill
    for rate_name, rate_set in supply_source.supplier_rate_sets.iteritems():
        if len(rate_set) == 1:
            bill[rate_name] = rate_set.pop()
    bill.update({'net-gbp': 0.0, 'vat-gbp':0.0, 'gross-gbp': 0.0, 'problem': ''})]]>
				</control>
				<control name="properties"
					value="{&apos;hydrogen&apos;: &apos;sonata&apos;}" />

				<regex pattern="/reports/77/output/\?supplier_contract_id=55" />
			</request>

			<!-- Check that it's displayed properly -->
			<request path="/chellow/reports/317/output/?supplier_contract_id=55">
				<regex pattern='&lt;option value="25" selected&gt;' />
				<regex pattern='&lt;textarea name="properties" rows="20" cols="80"&gt;\{&amp;#39;hydrogen&amp;#39;: &amp;#39;sonata&amp;#39;\}&lt;/textarea&gt;'/>
				<response-code value="200" />
			</request>

			<request path="/chellow/reports/77/output/?supplier_contract_id=55">
				<regex
					pattern='&lt;legend&gt;Download Displaced Virtual Bills&lt;/legend&gt;\s*&lt;br/&gt;\s*For &lt;input name="months" value="1" maxlength="2" size="2"&gt;\s*month\(s\) until the end of\s*&lt;input name="finish_year" maxlength="4" size="4" value="2014"&gt;' />
				<response-code value="200" />
			</request>

			<!-- Update the associated rate script. Supplier contract 54 -->
			<request path="/chellow/reports/319/output/" method="post">
				<control name="supplier_rate_script_id" value="307" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="has_finished" value="false" />
				<control name="script"><![CDATA[def gsp_gbp_per_kwh():
    return {
        'winter-pk': 0.0193918,
        'winter-low-pk': 0.0501474,
        'winter-off-pk': 0.0062656,
        'summer-pk': 0.0062656,
        'night': 0.0062656,
        'other': 0.0062656}]]>
				</control>
				<response-code value="303" />
			</request>

		</test>

		<test name="Manipulate non-core contracts">
			<!-- Create a new non-core contract -->
			<request path="/chellow/reports/265/output/" method="post">
				<control name="participant_id" value="31" /> <!-- CALB -->
				<control name="is_core" value="false" />
				<control name="name" value="VAT" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<regex pattern="/chellow/reports/267/output/\?non_core_contract_id=56" />
				<response-code value="303" />
			</request>

			<!-- Update the new non-core contract -->
			<request path="/chellow/reports/269/output/" method="post">
				<control name="non_core_contract_id" value="56" />
				<control name="name" value="VAT 2" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="charge_script"><![CDATA[import sys
				
def totalElement(account, startDate, finishDate):
    return ["total", 22.3, "VAT cost"]]]>
				</control>
				<control name="properties" value="{}" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/267/output/?non_core_contract_id=56">
				<regex pattern="import sys\s*def" />
				<response-code value="200" />
			</request>

			<!-- Delete it -->
			<request path="/chellow/reports/269/output/" method="post">
				<control name="non_core_contract_id" value="56" />
				<control name="delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Insert MOP contract">
			<request path="/chellow/reports/361/output/" method="post">
				<control name="participant_id" value="241" /> <!-- LENG -->
				<control name="name" value="MOP Contract" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<response-code value="303" />
				<regex pattern="/reports/107/output/\?mop_contract_id=57" />
			</request>

			<!-- Update with a charge script -->
			<request path="/chellow/reports/151/output/" method="post">
				<control name="mop_contract_id" value="57" />
				<control name="party_id" value="377" /> <!-- LENG -->
				<control name="name" value="MOP Contract" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="charge_script"><![CDATA[def virtual_bill_titles():
    return ['net-gbp', 'problem']

def virtual_bill(ds):
    bill = ds.mop_bill
    bill['net-gbp'] = 0]]></control>
				<control name="properties" value="{}" />
				<response-code value="303" />
				<regex pattern="/reports/107/output/\?mop_contract_id=57" />
			</request>

			<!-- Check we can see the rate scripts -->
			<request path="/chellow/reports/107/output/?mop_contract_id=57">
				<response-code value="200" />
			</request>
		</test>

		<test name="Insert a modern supplier contract">
			<!-- Create a new supplier contract for 2013 -->
			<request path="/chellow/reports/315/output/" method="post">
				<control name="participant_id" value="42" /> <!-- CGEN -->
				<control name="name" value="Half-hourlies 2013" />
				<control name="start_year" value="2013" />
				<control name="start_month" value="01" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="charge_script" value="" />
				<control name="properties" value="{}" />

				<regex pattern="/chellow/reports/77/output/\?supplier_contract_id=58" />
				<response-code value="303" />
			</request>


			<!-- Update the associated rate script. Supplier contract 58 -->
			<request path="/chellow/reports/319/output/" method="post">
				<control name="supplier_rate_script_id" value="310" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="has_finished" value="false" />
				<control name="script"><![CDATA[def gsp_gbp_per_kwh():
    return {
        'winter-pk': 0.0193918,
        'winter-low-pk': 0.0501474,
        'winter-off-pk': 0.0062656,
        'summer-pk': 0.0062656,
        'night': 0.0062656,
        'other': 0.0062656}]]>
				</control>
				<response-code value="303" />
			</request>

			<!-- Create a new supplier contract -->
			<request path="/chellow/reports/315/output/" method="post">
				<control name="participant_id" value="222" /> <!-- HYDE -->
				<control name="name" value="Non half-hourlies 2007" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="has_finished" value="false" />
				<control name="charge_script" value="" />
				<control name="properties" value="{}" />

				<regex pattern="/reports/77/output/\?supplier_contract_id=59" />
				<response-code value="303" />
			</request>
		</test>

		<test name="supplies">
			<!-- Give proper error if there are too few fields -->

			<request path="/chellow/reports/293/output/" method="post">
				<control
				 	type="file" name="import_file" value="supplies-too-few-fields.csv" />
				<regex pattern="/reports/295/output/\?process_id=2" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=2">
				<refresh />
				<regex
					pattern=
						"Another field called Supply Name needs to be added on the end" />
				<response-code value="200" />
			</request>

			<!-- non-existent source code -->
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="supplies_source.csv" />
				<regex pattern="/reports/295/output/\?process_id=3" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=3">
				<refresh />
				<!-- check that it knows that the first line has a source code that is 
					too long -->
				<regex
					pattern=
						"There&amp;#39;s no source with the code &amp;#39;netlong&amp;#39;"
				/>
				<response-code value="200" />
			</request>

			<!-- Line 2 has a DNO that doesn't exist -->
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="supplies_dno.csv" />
				<regex pattern="/reports/295/output/\?process_id=4" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=4">
				<refresh />
				<!-- check that it knows that line 2 has a DNO that doesn't exist -->
				<regex
					pattern=
						"There isn&amp;#39;t a DNO contract with the code &amp;#39;79&amp;#39;\."
				 	/>
				<response-code value="200" />
			</request>

			<!-- Check that it gives a sensible error message if a data is malformed -->
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="supplies_date.csv" />
				<regex pattern="/chellow/reports/295/output/\?process_id=5" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=5">
				<refresh />
				<!-- check that it knows that line 1 has a malformed date -->
				<regex
					pattern="Can&amp;#39;t parse the date: 2003-0/\*\*d8/03. It needs to be of the form yyyy-mm-dd hh:MM. invalid literal for int\(\) with base 10: " />
				<response-code value="200" />
			</request>

			<!-- Check for a sensible error message if the site doesn't exist -->
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="supplies_no_site.csv" />
				<regex pattern="/chellow/reports/295/output/\?process_id=6" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=6">
				<refresh />
				<!-- check that it knows that line 1 has a malformed date -->
				<regex pattern="There isn&amp;#39;t a site with the code zzznozzz\." />
				<response-code value="200" />
			</request>

			<!-- Valid import of supplies -->
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="supplies.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=7" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=7">
				<refresh max="21" />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
			<!-- Check that a supply with only an import MPAN is there -->
			<request path="/chellow/reports/311/output/?site_id=4">
				<regex pattern="22 6354 2983 570" />

				<!-- Check we the 'site_id' field is there -->
				<regex
					pattern='&lt;fieldset&gt;\s*&lt;input type="hidden" name="site_id" value="4"&gt;\s*&lt;legend&gt;Update this site&lt;/legend&gt;' />

				<response-code value="200" />
			</request>

			<!-- Can we see a site ok? -->

			<request path="/chellow/reports/311/output/?site_id=1">
				<!-- Is the era displayed? -->
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;2003-08-03 00:00&lt;/td&gt;\s*&lt;td&gt;Ongoing&lt;/td&gt;\s*&lt;td&gt;gen&lt;/td&gt;\s*&lt;td&gt;2&lt;/td&gt;\s*&lt;td&gt;\s*&lt;/td&gt;\s*&lt;td&gt;\s*22 7907 4116 080\s*&lt;/td&gt;\s*&lt;/tr&gt;' />

				<!-- Does it show the import MPAN? -->
				<regex pattern='22 9813 2107 763' />

				<response-code value="200" />
			</request>

		</test>
		<!-- Can we see a supply ok? -->
		<test name="view a supply">
			<!-- View a supply in edit mode -->
			<request path="/chellow/reports/305/output/?supply_id=2">
				<!-- Check table of existing eras is there -->
				<regex
					pattern='&lt;table&gt;\s*&lt;caption&gt;Existing Eras&lt;/caption&gt;' />

				<!-- Check reference to ongoing era -->
				<regex
					pattern='&lt;td&gt;2003-08-03 00:00&lt;/td&gt;\s*&lt;td&gt;\s*Ongoing' />

				<response-code value="200" />
			</request>
			<request method="post" path="/chellow/reports/305/output/">
				<!-- Can we update a supply name? -->
				<!-- Can we update a supply source? -->
				<control name="supply_id" value="1" />
				<control name="name" value="Hello" />
				<control name="source_id" value="4" />
				<control name="generator_type_id" value="1" />
				<control name="gsp_group_id" value="11" />
				<regex pattern='/reports/7/output/\?supply_id=1' />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/305/output/?supply_id=1">
				<regex pattern='value="Hello"&gt;' />
				<regex pattern='option value="1" selected&gt;chp&lt;/option&gt;' />
				<response-code value="200" />
			</request>

			<request method="post" path="/chellow/reports/305/output/">
				<!-- Change it back. -->
				<control name="supply_id" value="1" />
				<control name="name" value="1" />
				<control name="source_id" value="1" />
				<control name="generator_type_id" value="1" />
				<control name="gsp_group_id" value="11" />
				<response-code value="303" />
			</request>
		</test>

		<!-- Can we see a supply era ok? -->
		<test name="view era in edit mode. Supply 1">
			<request path="/chellow/reports/307/output/?era_id=1">
				<!-- Check start date year is there -->
				<regex pattern="start_year" />
				<regex
					pattern='&lt;option value="53" selected&gt;HH contract&lt;/option&gt;' />
				<regex
					pattern='"imp_supplier_contract_id"&gt;\s*&lt;option value="55" selected&gt;Half-hourlies 2007' />

				<!-- Can we see the MOP account? -->
				<regex pattern='"mc-22 9205 6799 106"' />

				<response-code value="200" />
			</request>
			<!-- Supply 2 -->
			<request path="/chellow/reports/307/output/?era_id=2">
				<!-- Check site code is correct -->
				<regex pattern='&lt;td&gt;\s*CI004\s*&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Manipulating eras">

			<!-- Can we add a new era ok? -->
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="2" />
				<control name="start_year" value="2006" />
				<control name="start_month" value="07" />
				<control name="start_day" value="20" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="Insert" />

				<regex pattern="/chellow/reports/7/output/\?supply_id=2" />
				<response-code value="303" />
			</request>

			<!-- Let's check it's carried forward the import mpan. Supply 2 -->
			<request path="/chellow/reports/307/output/?era_id=8">
				<regex pattern="22 9813 2107 763" />
				<regex pattern='name="mtc_code" value="845" size="3" maxlength="3"' />
				<response-code value="200" />
			</request>

			<!-- Can we delete the era ok? Supply 2 -->
			<request path="/chellow/reports/307/output/?era_id=8&amp;delete=Delete">
				<regex pattern="Are you sure you want to delete this" />
				<response-code value="200" />
			</request>

			<!-- When a supply era is ended, check that the snags are updated. Supply 
				5 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="5" />
				<control name="start_year" value="2003" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="true" />
				<control name="finish_year" value="2003" />
				<control name="finish_month" value="08" />
				<control name="finish_day" value="13" />
				<control name="finish_hour" value="23" />
				<control name="finish_minute" value="30" />
				<control name="gsp_group_id" value="11" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="22 0883 6932 301" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="22 0883 6932 301" />
				<control name="msn" value="" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="imp_llfc_code" value="570" />
				<control name="imp_mpan_core" value="22 0883 6932 301" />
				<control name="imp_sc" value="350" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="4341" />
				<response-code value="303" />
			</request>

			<!-- Check it's correct in edit view -->
			<request path="/chellow/reports/307/output/?era_id=5">

				<!-- Check start day is correct -->
				<regex pattern='option value="3" selected&gt;03&lt;/option&gt;' />

				<!-- Check the end date is right -->
				<regex
					pattern='&lt;input type="checkbox" name="is_ended" value="true" checked' />
				<regex pattern='option value="13" selected&gt;13&lt;/option&gt;' />
				<regex pattern='option value="23" selected&gt;23&lt;/option&gt;' />

				<response-code value="200" />
			</request>

			<!-- Check it's correct in supply view -->
			<request path="/chellow/reports/7/output/?supply_id=5">
				<response-code value="200" />
				<!-- Check the end date is right -->
				<regex pattern='&lt;a title="2003-08-13 23:30"&gt;2003-08-13&lt;/a&gt;' />
				<regex
					pattern='&lt;legend&gt;TRIAD&lt;/legend&gt;\s*&lt;input type="hidden" name="supply_id"' />
				<regex
					pattern='&lt;a href="/chellow/reports/15/output/\?supply_id=5&amp;amp;is_import=true&amp;amp;year=\d{4}&amp;amp;years=1"&gt;Import&lt;/a&gt;' />
			</request>
			<!-- Supply 5, Era 5 -->
			<request path="/chellow/reports/301/output/?channel_id=18">
				<response-code value="200" />
				<!-- Check the end date is right -->
				<regex pattern='Channel Export\s*REACTIVE_EXP' />
				<regex
					pattern='&lt;td&gt;2003-08-03 00:00&lt;/td&gt;\s*&lt;td&gt;2003-08-13 23:30&lt;/td&gt;\s*&lt;td&gt;Missing&lt;/td&gt;' />
			</request>

			<!-- Check that if the hhdc contract is changed, the hhdc contract of 
				the snags change -->
			<!-- Check the export supply capacity can be updated as well. Supply 5 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="5" />
				<control name="msn" value="" />
				<control name="start_year" value="2003" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="true" />
				<control name="finish_year" value="2003" />
				<control name="finish_month" value="08" />
				<control name="finish_day" value="13" />
				<control name="finish_hour" value="23" />
				<control name="finish_minute" value="30" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="22 0883 6932 301" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="22 0883 6932 301" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="imp_llfc_code" value="570" />
				<control name="imp_mpan_core" value="22 0883 6932 301" />
				<control name="imp_gsp_group_id" value="11" />
				<control name="imp_sc" value="430" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="4341" />

				<response-code value="303" />
			</request>

			<!-- Check the change is there in edit view -->
			<request path="/chellow/reports/307/output/?era_id=5">
				<regex
					pattern='&lt;input name="imp_sc" value="430" size="9" maxlength="9"&gt;' />
			</request>

			<request path="/chellow/reports/301/output/?channel_id=18">
				<response-code value="200" />
				<regex pattern='Channel Export\s*REACTIVE_EXP' />

				<!-- Check the snag is there -->
				<regex
					pattern='&lt;td&gt;2003-08-03 00:00&lt;/td&gt;\s*&lt;td&gt;2003-08-13 23:30&lt;/td&gt;\s*&lt;td&gt;Missing&lt;/td&gt;' />
			</request>
			<!-- Put it back to how it was. Supply 5 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="5" />
				<control name="msn" value="" />
				<control name="start_year" value="2003" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="22 0883 6932 301" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="22 0883 6932 301" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="imp_llfc_code" value="570" />
				<control name="imp_mpan_core" value="22 0883 6932 301" />
				<control name="imp_sc" value="350" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="4341" />
				<response-code value="303" />
			</request>

			<!-- Valid bulk update of supply eras -->
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="era-update.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/reports/295/output/\?process_id=8" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=8">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="supplies-bad-mpan.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=9" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=9">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex
					pattern="The MPAN core 22 9813 2107 763 is already attached to another supply\." />
				<response-code value="200" />
			</request>

			<!-- Attach another site to an era. Supply 2 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="2" />
				<control name="site_code" value="CI005" />
				<control name="attach" value="Attach" />
				<response-code value="303" />
			</request>

			<!-- Check that we prevent mpan cores from changing without an overlapping 
				period. Supply 2 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="8" />
				<control name="msn" value="" />
				<control name="start_year" value="2006" />
				<control name="start_month" value="07" />
				<control name="start_day" value="20" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 9813 2107 763" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="01" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="3" />
				<control name="ssc_code" value="" />
				<control name="imp_llfc_code" value="580" />
				<control name="imp_mpan_core" value="2276930477695" />
				<control name="imp_sc" value="430" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="01" />

				<response-code value="400" />

				<!-- Also, we've changed the CoP to be 3. Check that this is remembered 
					when there is an error. -->
				<regex pattern='&lt;option value="3" selected&gt;3 CoP 3&lt;/option&gt;' />

				<regex
					pattern="MPAN cores can&amp;#39;t change without an overlapping period" />
			</request>

			<!-- Check that we get a good error message if the LLFC is of the wrong 
				polarity. Supply 2 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="8" />
				<control name="msn" value="" />
				<control name="start_year" value="2006" />
				<control name="start_month" value="07" />
				<control name="start_day" value="20" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 9813 2107 763" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="01" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="3" />
				<control name="ssc_code" value="" />
				<control name="imp_llfc_code" value="521" />
				<control name="imp_mpan_core" value="22 9813 2107 763" />
				<control name="imp_sc" value="430" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="01" />

				<response-code value="400" />

				<regex pattern="The imp line loss factor 521 is actually an exp one\." />
			</request>
		</test>

		<test name="Import hh data">
			<!-- Check it gives a sensible error message if the files doesn't start 
				with #F2 -->

			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="no_hash.df2" />

				<regex pattern="/reports/65/output/\?hhdc_contract_id=53&amp;process_id=0" />
				<response-code value="303" />
			</request>

			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=0"
				method="post">
				<regex pattern="The first line must be &amp;#39;#F2&amp;#39;" />
				<response-code value="200" />
			</request>

			<!-- Import some hh Stark DF2 data -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data.df2" />
				<response-code value="303" />
				<regex pattern="/reports/65/output/\?hhdc_contract_id=53&amp;process_id=1" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=1">
				<refresh />
				<!-- Check it's loaded ok and has ignored the blank line and the #F2 
					line -->
				<regex pattern="The import has completed.*successfully." />

				<!-- Check link to hhdc is correct -->
				<regex pattern="/chellow/reports/115/output/\?hhdc_contract_id=53" />
				<response-code value="200" />
			</request>

			<!-- Supply 1, era 1 -->
			<request path="/chellow/reports/301/output/?channel_id=4">
				<regex pattern='Channel Export\s*REACTIVE_EXP' />
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/117/output/\?snag_id=4"&gt;view&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;2003-08-03 00:00&lt;/td&gt;\s*&lt;td&gt;Ongoing&lt;/td&gt;\s*&lt;td&gt;Missing&lt;/td&gt;' />
				<response-code value="200" />
			</request>
			<!-- Check if more hh data imports ok -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data2.df2" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Detect if hh import still works if first hh datum is missing.">
			<!-- This relies on the datum 15/11/2005,00:30,1.0,A being already loaded, 
				with a gap before it. -->

			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="missing.df2" />
				<regex pattern="/reports/65/output/\?hhdc_contract_id=53&amp;process_id=3" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=3">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
		</test>
		<test name="Do we handle BST ok?">
			<!-- This relies on the default timezone being BST -->

			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data_timezone.df2" />
				<regex
					pattern="/chellow/reports/65/output/\?hhdc_contract_id=53&amp;process_id=4" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=4">
				<!-- Check it's loaded ok -->
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
		</test>

		<test name="Actual reads snags combined properly">
			<!-- Test that 3 non-actual reads in a row generate a single snag -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data_not_actual.df2" />
				<regex
					pattern="/chellow/reports/65/output/\?hhdc_contract_id=53&amp;process_id=5" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=5">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>

			<!-- supply 1, era 1 -->
			<request path="/chellow/reports/301/output/?channel_id=3">
				<regex pattern='Channel Export\s*ACTIVE' />
				<regex
					pattern='&lt;td&gt;\s*&lt;a href="/chellow/reports/117/output/\?snag_id=45"&gt;view&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;2005-12-15 07:00&lt;/td&gt;\s*&lt;td&gt;2005-12-15 08:00&lt;/td&gt;\s*&lt;td&gt;Estimated&lt;/td&gt;' />
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/117/output/\?snag_id=3"&gt;view&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;2003-08-03 00:00&lt;/td&gt;\s*&lt;td&gt;2005-12-15 06:30&lt;/td&gt;\s*&lt;td&gt;Missing&lt;/td&gt;' />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data_not_actual2.df2" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=5">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>

			<!-- supply 1, era 1 -->
			<request path="/chellow/reports/301/output/?channel_id=3">
				<regex pattern="Channel Export\s*ACTIVE" />
				<regex
					pattern='&lt;td&gt;\s*&lt;a href="/chellow/reports/117/output/\?snag_id=45"&gt;view&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;2005-12-15 07:00&lt;/td&gt;\s*&lt;td&gt;2005-12-15 09:30&lt;/td&gt;\s*&lt;td&gt;Estimated&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Importing simple CSV data">
			<!-- Test if a CSV HH file can be imported -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data.simple.csv" />
				<regex pattern="/reports/65/output/\?hhdc_contract_id=53&amp;process_id=7" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=7">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
			<!-- Check that the imported HH datum is correct for supply 1, era 1 -->
			<request
				path="/chellow/reports/301/output/?channel_id=3&amp;start_year=2005&amp;start_month=09">
				<regex
					pattern='&lt;td&gt;2005-09-15 00:00&lt;/td&gt;\s*&lt;td&gt;1.0&lt;/td&gt;\s*&lt;td&gt;A&lt;/td&gt;' />
			</request>
		</test>
		<test name="Various DF2 tests.">
			<!-- Check it gives a sensible error message if the comma after the value 
				is missing -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data_malformed.df2" />
				<regex pattern="/reports/65/output/\?hhdc_contract_id=53&amp;process_id=8" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=8">
				<refresh />
				<regex pattern="Problem at line number: 4" />
				<response-code value="200" />
			</request>

			<!-- Check it gives a sensible error message if the first mpan is malformed -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data_bad_beginning.df2" />
				<regex pattern="/reports/65/output/\?hhdc_contract_id=53&amp;process_id=9" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=9">
				<refresh />
				<regex
					pattern="The MPAN core &amp;#39;2204707514535,,,&amp;#39; must contain exactly 13 digits" />
				<response-code value="200" />
			</request>

			<!-- Check sensible error message if header but no data -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data_header_but_no_data.df2" />
				<regex pattern="/reports/65/output/\?hhdc_contract_id=53&amp;process_id=10" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=10">
				<refresh />
				<regex pattern="The import has completed.*successfully\." />
				<response-code value="200" />
			</request>
		</test>
		<test name="Manipulate channels">
			<!-- Make sure 'show HH data' button works, supply 6, era 6 -->
			<request path="/chellow/reports/301/output/?channel_id=19">
				<regex pattern='Import\s*ACTIVE' />
				<response-code value="200" />
			</request>
		</test>
		<!-- Manipulate Hh data" -->
		<test name="Make sure 'show HH data' button works, supply 6, era 6">
			<request path="/chellow/reports/301/output/?channel_id=21">
				<regex pattern='Export\s*REACTIVE_EXP' />
				<regex pattern='action="\."&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Give good error for invalid date.">
			<request
				path="/chellow/reports/301/output/?channel_id=21&amp;start_year=2006&amp;start_month=13">
				<regex pattern='Invalid date' />
				<response-code value="400" />
			</request>
		</test>
		<test name="Check site level snag">
			<request path="/chellow/reports/39/output/">
				<regex pattern='CI004' />
				<!-- There's an hh where export to net is *less* than imported from generator, 
					check this doesn't show up. -->

				<regex
					pattern='&lt;td&gt;\s*&lt;a href="/chellow/reports/119/output/\?site_snag_id=43"&gt;view&lt;/a&gt; \[&lt;a href="/chellow/reports/373/output/\?site_snag_id=43"&gt;edit&lt;/a&gt;\]\s*&lt;/td&gt;\s*&lt;td&gt;[^&lt;]*&lt;/td&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/5/output/\?site_id=1"&gt;CI004&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;Lower Treave&lt;/td&gt;\s*&lt;td&gt;Export to net &amp;gt; import from generators.&lt;/td&gt;\s*&lt;td&gt;2005-10-29 23:30&lt;/td&gt;\s*&lt;td&gt;\s*2005-10-30 01:00&lt;/td&gt;\s*&lt;/tr&gt;\s*&lt;/tbody&gt;' />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/371/output/">
				<!-- Check that there's an 'ignore-year' parameter. -->
				<regex pattern='name="ignore_year"' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check view of channel level snag">
			<!-- Supply 1, era 1 -->
			<request path="/chellow/reports/117/output/?snag_id=1">
				<response-code value="200" />
			</request>
		</test>

		<test name="Delete channel without data">
			<!-- Check that for a supply with multiple eras, a channel without any 
				data can be deleted. This test needs some hh data loaded somewhere. Supply 
				2, era 8, exp active -->
			<request path="/chellow/reports/303/output/" method="post">
				<control name="channel_id" value="25" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>

			<!-- Put it back to how it was before. Supply 2 -->
			<request path="/chellow/reports/299/output/" method="post">
				<control name="era_id" value="8" />
				<control name="imp_related" value="false" />
				<control name="channel_type" value="ACTIVE" />
				<response-code value="303" />
			</request>

			<!-- Check it gives an error if the hhdc contract is removed from a supply 
				era that has data. Supply 1 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="1" />
				<control name="start_year" value="2003" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="msn" value="" />
				<control name="gsp_group_id" value="11" />
				<control name="pc_id" value="9" />
				<control name="hhdc_contract_id" value="null" />
				<control name="hhdc_account" value="01" />
				<control name="imp_mtc_code" value="845" />
				<control name="imp_llfc_code" value="550" />
				<control name="imp_mpan_core" value="22 9205 6799 106" />
				<control name="imp_ssc_code" value="" />
				<control name="imp_sc" value="450" />
				<control name="imp_supplier_contract_id" value="6" />
				<control name="imp_supplier_account" value="11640077" />
				<control name="exp_mtc_code" value="845" />
				<control name="exp_llfc_code" value="581" />
				<control name="exp_mpan_core" value="22 0470 7514 535" />
				<control name="exp_ssc_code" value="" />
				<control name="exp_sc" value="150" />
				<control name="exp_supplier_contract_id" value="6" />
				<control name="exp_supplier_account" value="01" />
				<response-code value="400" />
			</request>
		</test>

		<test name="View a snag">
			<request path="/chellow/reports/119/output/?site_snag_id=43">
				<response-code value="200" />
				<regex
					pattern="&lt;th&gt;Finish Date&lt;/th&gt;\s*&lt;td&gt;2005-10-30 01:00&lt;/td&gt;" />
			</request>
		</test>
		<test name="site snags stay ignored">
			<!-- Assumes various site snags are present at this stage -->
			<request path="/chellow/reports/371/output/" method="post">
				<control name="ignore_year" value="2006" />
				<control name="ignore_month" value="12" />
				<control name="ignore_day" value="26" />
				<control name="ignore_hour" value="00" />
				<control name="ignore_minute" value="00" />
				<control name="ignore" value="Ignore" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data.df2" />
				<regex pattern="/reports/65/output/\?hhdc_contract_id=53&amp;process_id=11" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=11">
				<refresh />
				<regex pattern="The import has completed.*successfully" />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/39/output/">
				<regex pattern='&lt;tbody&gt;\s*&lt;/tbody&gt;' />
				<response-code value="200" />
			</request>
			<request
				path="/chellow/reports/17/output/?supply_id=5&amp;months=1&amp;finish_year=2010&amp;finish_month=03">
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;\s*2010-03-15 12:00\s*&lt;/td&gt;\s*&lt;td&gt;0&lt;/td&gt;\s*&lt;td&gt;A&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Batches">
			<!-- Create a new batch -->
			<request path="/chellow/reports/287/output/" method="post">
				<control name="supplier_contract_id" value="55" />
				<control name="reference" value="04-003" />
				<control name="description" value="Contract 4, batch number 3" />
				<response-code value="303" />
			</request>

			<!-- Check it gives a good error message for a duplicate name -->
			<request path="/chellow/reports/287/output/" method="post">
				<control name="supplier_contract_id" value="55" />
				<control name="reference" value="04-003" />
				<control name="description" value="dup batch" />
				<regex
					pattern="There&amp;#39;s already a batch attached to the contract Half-hourlies 2007 with the reference 04-003\." />
				<response-code value="400" />
			</request>
		</test>
		<test name="Bill imports">
			<!-- Create a new import. Supplier contract 55 -->
			<request path="/chellow/reports/321/output/" method="post">
				<control name="supplier_batch_id" value="1" />
				<control type="file" name="import_file" value="bills.mm" />
				<response-code value="303" />
				<regex pattern="/reports/323/output/\?importer_id=0" />
			</request>

			<!-- Supplier contract 55, batch 1 -->
			<request path="/chellow/reports/323/output/?importer_id=0">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="&lt;td&gt;2007-02-28 00:00&lt;/td&gt;\s*&lt;td&gt;0&lt;/td&gt;\s*&lt;td&gt;4463.08&lt;/td&gt;" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>

		<test name="Set up NHH">
			<!-- Valid import of supplies -->
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="nhh-supplies.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=10" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=10">
				<refresh max="21" />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
			<!-- Check values have been imported correctly. Supply 11 -->
			<request path="/chellow/reports/307/output/?era_id=11">
				<regex pattern="K87D74429" />
				<response-code value="200" />
			</request>

			<!-- Create a new batch -->
			<request path="/chellow/reports/287/output/" method="post">
				<control name="supplier_contract_id" value="59" />
				<control name="reference" value="06-002" />
				<control name="description" value="Bgb batch" />
				<response-code value="303" />
			</request>

			<!-- Supplier contract 59 -->
			<request path="/chellow/reports/321/output/" method="post">
				<control name="supplier_batch_id" value="3" />
				<control type="file" name="import_file" value="bills.bgb.edi" />

				<response-code value="303" />
				<regex pattern="/reports/323/output/\?importer_id=1" />
			</request>

			<!-- Supplier contract 59, batch 3 -->
			<request path="/chellow/reports/323/output/?importer_id=1">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>
		<test name="Check that resolved HH estimates have their snags cleared.">
			<!-- Set a previously estimated HH to actual, supply 1, era 1, channel 
				3 -->
			<request path="/chellow/reports/309/output/" method="post">
				<control name="update" value="Update" />
				<control name="hh_datum_id" value="12" />
				<control name="value" value="0.5" />
				<control name="status" value="A" />
				<response-code value="303" />
			</request>

			<!-- Check that the snag has been cleared. Supply 1, era 1 -->
			<request path="/chellow/reports/301/output/?channel_id=3">
				<regex pattern='Channel Export\s*ACTIVE' />
				<regex
					pattern='&lt;td&gt;2005-12-15 07:30&lt;/td&gt;\s*&lt;td&gt;2005-12-15 09:30&lt;/td&gt;\s*&lt;td&gt;Estimated&lt;/td&gt;' />
			</request>
			<!-- Change it back. supply 1, era 1. -->
			<request path="/chellow/reports/309/output/" method="post">
				<control name="hh_datum_id" value="12" />
				<control name="value" value="0.5" />
				<control name="status" value="E" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Test of BGlobal HH data import">
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_data.bg.csv" />
				<response-code value="303" />
				<regex
					pattern="/chellow/reports/65/output/\?hhdc_contract_id=53&amp;process_id=12" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=12">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Check the BGlobal data is imported to the right number of sig figs">
			<!-- supply 1, era 1 -->
			<request
				path="/chellow/reports/301/output/?channel_id=1&amp;start_year=2008&amp;start_month=07">
				<regex pattern="0\.262" />
			</request>
		</test>
		<test
			name="Check okay if supply era update is interupted by an error. Supply 9">
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="9" />
				<control name="msn" value="P96C93722" />
				<control name="start_year" value="2005" />
				<control name="start_month" value="08" />
				<control name="start_day" value="06" />
				<control name="is_ended" value="false" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="535" />
				<control name="llfc_code" value="510" />
				<control name="imp_mpan_core" value="22 0195 4836 192" />
				<control name="ssc_code" value="0127" />
				<control name="gsp_group_id" value="11" />
				<control name="imp_sc" value="30" />
				<control name="hhdc_contract_id" value="HH contract" />
				<control name="hhdc_account"></control>
				<control name="imp_supplier_contract_id" value="Non half-hourlies 2007" />
				<control name="imp_supplier_account" value="341664" />

				<!-- Should error on this -->
				<control name="exp_mpan_core" value="99 0000 4444 883" />
				<control name="exp_sc" value="200" />
				<control name="exp_supplier_contract_id" value="Non half-hourlies 2007" />
				<control name="exp_supplier_account" value="341664" />

				<response-code value="400" />
			</request>
		</test>
		<test name="HH data general import">
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="hh_data.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/reports/295/output/\?process_id=11" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=11">
				<refresh />
				<regex pattern="The file has been imported successfully\." />
				<response-code value="200" />
			</request>
		</test>
		<test name="CSV import">
			<!-- Create new batch -->
			<request path="/chellow/reports/287/output/" method="post">
				<control name="supplier_contract_id" value="55" />
				<control name="reference" value="06-004" />
				<control name="description" value="CSV batch" />

				<response-code value="303" />
			</request>

			<!-- Insert bills. Supplier contract 55 -->
			<request path="/chellow/reports/321/output/" method="post">
				<control name="supplier_batch_id" value="4" />
				<control type="file" name="import_file" value="bills.csv" />

				<response-code value="303" />
				<regex pattern="/reports/323/output/\?importer_id=2" />
			</request>

			<!-- Supplier contract 54, batch 4 -->
			<request path="/chellow/reports/323/output/?importer_id=2">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>
		<test name="Check one is able to delete an era ok">
			<!-- First create the era -->
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="9" />
				<control name="start_year" value="2009" />
				<control name="start_month" value="01" />
				<control name="start_day" value="20" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="Insert" />
				<regex pattern="/chellow/reports/7/output/\?supply_id=9" />
				<response-code value="303" />
			</request>

			<!-- Delete era. Supply 9 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="12" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Check 'view' link is correct on a site in the edit world.">
			<request path="/chellow/reports/311/output/?site_id=7">
				<regex pattern="/chellow/reports/5/output/\?site_id=7" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check that if era dates change, hh data move with them.">
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="1" />
				<control name="start_year" value="2008" />
				<control name="start_month" value="7" />
				<control name="start_day" value="7" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="Insert" />

				<regex pattern="/chellow/reports/7/output/\?supply_id=1" />
				<response-code value="303" />
			</request>

			<!-- supply 1, era 13 -->
			<request
				path="/chellow/reports/301/output/?channel_id=32&amp;start_year=2008&amp;start_month=07">
				<regex
					pattern='&lt;td&gt;\s*\[&lt;a href="/chellow/reports/309/output/\?hh_datum_id=66"&gt;edit&lt;/a&gt;\]\s*&lt;/td&gt;\s*&lt;td&gt;2008-07-07 00:00&lt;/td&gt;\s*&lt;td&gt;0.247&lt;/td&gt;\s*&lt;td&gt;A&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check 'view' link is correct on a supply in the edit world.">
			<request path="/chellow/reports/305/output/?supply_id=10">
				<regex pattern="/chellow/reports/7/output/\?supply_id=10" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check site nav link is correct on site HH data page.">
			<request
				path="/chellow/reports/25/output/?site_code=CI004&amp;year=2005&amp;month=11">
				<regex pattern="/chellow/reports/5/output/\?site_id=1" />

				<!-- Check that columns are in the right order -->
				<regex
					pattern='kWh&lt;/th&gt;\s*&lt;th colspan="4"&gt;\s*1 net\s*&lt;/th&gt;' />
				<response-code value="200" />
			</request>
		</test>

		<test name="Check no duplicate supplies in Supplies Duration report.">
			<request
				path="/chellow/reports/149/output/?start_year=2008&amp;start_month=07&amp;start_day=01&amp;start_hour=0&amp;start_minute=0&amp;finish_year=2008&amp;finish_month=07&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<regex pattern='("1","1","net","","CH017",){1}' />

				<!-- Check full line -->
				<regex
					pattern='"2","1","net","","CI004","Lower Treave","2008-07-01 00:00","2008-07-31 23:30","00","845","5","","0","hh",570,22 9813 2107 763,430,Half-hourlies 2007,0,0,0.0,0,,None,1488,581,22 3475 1614 211,900,Half-hourlies 2007,0,0,,0,,None,1488' />

				<response-code value="200" />
			</request>
		</test>
		<test name="Check last HH is deleted when a day of HH data is deleted.">
			<!-- Delete a day of data. Supply 1, era 13 -->
			<request path="/chellow/reports/303/output/" method="post">
				<control name="channel_id" value="32" />
				<control name="start_year" value="2008" />
				<control name="start_month" value="07" />
				<control name="start_day" value="07" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="finish_year" value="2008" />
				<control name="finish_month" value="07" />
				<control name="finish_day" value="07" />
				<control name="finish_hour" value="23" />
				<control name="finish_minute" value="30" />
				<control name="delete_data" value="Delete" />

				<regex pattern="Data successfully deleted\." />
				<response-code value="200" />
			</request>
			<!-- Check the last HH of the day is deleted. Supply 1, era 13 -->
			<request
				path="/chellow/reports/301/output/?channel_id=32&amp;start_year=2008&amp;start_month=07">
				<regex
					pattern='&lt;tbody&gt;\s*&lt;tr&gt;\s*&lt;td&gt;\s*\[&lt;a href="/chellow/reports/309/output/\?hh_datum_id=114"&gt;edit&lt;/a&gt;\]\s*&lt;/td&gt;\s*&lt;td&gt;2008-07-08 00:00&lt;/td&gt;\s*&lt;td&gt;0.299&lt;/td&gt;\s*&lt;td&gt;A&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check one is redirected to hh data when a datum is deleted.">
			<!-- supply 1, era 1, channel 1 -->
			<request path="/chellow/reports/309/output/?hh_datum_id=23"
				method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
				<regex pattern="/chellow/reports/301/output/\?channel_id=1" />
			</request>
		</test>
		<test name="Test that it gives an error if the hhdc_contract_id is null.">
			<!-- Supply 5 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="5" />
				<control name="msn" value="" />
				<control name="start_year" value="2003" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="22 0883 6932 301" />
				<control name="hhdc_contract_id" value="null" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="imp_llfc_code" value="570" />
				<control name="imp_mpan_core" value="22 0883 6932 301" />
				<control name="imp_sc" value="350" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="01" />

				<response-code value="400" />
				<regex pattern="Problem parsing the field hhdc_contract_id as an integer: invalid literal for int\(\) with base 10: .*null"/>
			</request>
		</test>
		<test name="Test that profile 05 is displayed for an era. Supply 9">
			<request path="/chellow/reports/307/output/?era_id=9">
				<regex
					pattern='&lt;option value="5" selected&gt;05 - Non-domestic, MD, load factor 0-20%&lt;/option&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try adding a party viewer.">
			<request path="/chellow/reports/255/output/" method="post">
				<control name="email_address" value="mishka@localhost" />
				<control name="password" value="fyodor" />
				<control name="user_role_code" value="party-viewer" />
				<control name="party_id" value="30" /> <!-- BMET HHDC -->
				<response-code value="303" />
				<regex pattern="/chellow/reports/257/output/\?user_id=4" />
			</request>
		</test>
		<test name="Check that the party viewer is able to view snags.">
			<request
				path="/chellow/reports/37/output/?hhdc-contract-id=53&amp;hidden_days=5">
				<credentials username="mishka@localhost" password="fyodor" />

				<regex
					pattern="&lt;td&gt;\s*22 0470 7514 535\s*&lt;/td&gt;\s*&lt;td&gt;\s*&lt;ul&gt;\s*&lt;li&gt;\s*CH017 Parbola\s*&lt;/li&gt;" />
				<regex
					pattern="There are 46 snag\(s\) older than 5 days that aren't ignored\." />
				<regex
					pattern='&lt;a href="/chellow/reports/115/output/\?hhdc_contract_id=53"&gt;HH contract&lt;/a&gt;' />
				<regex
					pattern='&lt;li&gt;\s*&lt;a href="/chellow/reports/117/output/\?snag_id=1"&gt;view&lt;/a&gt;  \[&lt;a href="/chellow/reports/365/output/\?snag_id=1"&gt;edit&lt;/a&gt;\]\s*&lt;/li&gt;' />

				<response-code value="200" />
			</request>
		</test>
		<test name="Make sure everything's there on the home page.">
			<request path="/chellow/reports/1/output/">
				<credentials username="watkins@example.com" password="alan" />
				<regex
					pattern='&lt;a href="/chellow/reports/133/output/"&gt;Meter Payment Types&lt;/a&gt;' />
				<regex
					pattern='&lt;a href="/chellow/reports/337/output/"&gt;\s*Sources\s*&lt;/a&gt;' />
				<regex
					pattern='&lt;a href="/chellow/reports/341/output/"&gt;\s*Generator Types\s*&lt;/a&gt;' />

				<response-code value="200" />
			</request>
		</test>
		<test
			name="Test deleting the only rate script attached to a supplier contract.">
			<!-- Supplier contract 58 -->
			<request path="/chellow/reports/319/output/" method="post">
				<control name="supplier_rate_script_id" value="307" />
				<control name="delete" value="Delete" />
				<regex pattern="You can&amp;#39;t delete the last rate script\." />
				<response-code value="400" />
			</request>
		</test>
		<test
			name="Try adding a second rate script (set to 'ongoing'), and see if the era can be updated.">
			<request path="/chellow/reports/325/output/" method="post">
				<control name="supplier_contract_id" value="59" />
				<control name="start_year" value="2009" />
				<control name="start_month" value="08" />
				<control name="start_day" value="16" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="script" value="" />

				<response-code value="303" />
			</request>

			<!-- Supply 1 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="13" />
				<control name="start_year" value="2008" />
				<control name="start_month" value="07" />
				<control name="start_day" value="07" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 0470 7514 535" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="01" />
				<control name="msn" value="" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="exp_llfc_code" value="581" />
				<control name="exp_mpan_core" value="22 0470 7514 535" />
				<control name="exp_sc" value="150" />
				<control name="exp_supplier_contract_id" value="59" />
				<control name="exp_supplier_account" value="010" />

				<response-code value="303" />
			</request>
		</test>
		<test name="Check updating of HHDC contract state.">
			<request path="/chellow/reports/279/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control name="state"><![CDATA[{
'last_import_keys': {'.': '1960-11-30 00:00_example.csv'}}]]></control>
				<control name="update_state" value="Update State" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/115/output/?hhdc_contract_id=53">
				<response-code value="200" />
				<regex
					pattern="\{\s*&amp;#39;last_import_keys&amp;#39;: \{&amp;#39;.&amp;#39;: &amp;#39;1960-11-30 00:00_example.csv&amp;#39;\}\}" />

				<!-- Check link to channel snags -->
				<regex pattern="hidden_days" />

				<!-- Check link to add a rate script -->
				<regex
					pattern='Rate Scripts\s*\[&lt;a href="/chellow/reports/383/output/\?hhdc_contract_id=53"&gt;add&lt;/a&gt;\]' />

			</request>
		</test>
		<test name="Check adding of user report.">
			<!-- Requires that no other user reports have been created. -->
			<request path="/chellow/reports/" method="post">
				<control name="is_core" value="false" />
				<control name="name" value="Minority Report" />
				<response-code value="303" />
				<regex pattern="/reports/2/" />
			</request>
			<request path="/chellow/reports/2/">
				<response-code value="200" />
				<regex pattern="Minority Report" />
			</request>
		</test>
		<test name="Check dates are correct for four eras.">

			<!-- Insert era -->
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="1" />
				<control name="start_year" value="2008" />
				<control name="start_month" value="08" />
				<control name="start_day" value="07" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="insert_era" />

				<response-code value="303" />
			</request>

			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="1" />
				<control name="start_year" value="2008" />
				<control name="start_month" value="09" />
				<control name="start_day" value="07" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="insert_era" />

				<response-code value="303" />
			</request>

			<request path="/chellow/reports/305/output/?supply_id=1">
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;2003-08-03 00:00&lt;/td&gt;\s*&lt;td&gt;2008-07-06 23:30' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Test 'view' link from supplier contract rate scripts.">
			<request path="/chellow/reports/325/output/?supplier_contract_id=59">
				<regex pattern="/chellow/reports/77/output/\?supplier_contract_id=59" />
			</request>
		</test>
		<test name="Check 'HH Contract' option is there. Supply 9.">
			<request path="/chellow/reports/307/output/?era_id=9">
				<regex
					pattern='&lt;option value="53"&gt;HH contract&lt;/option&gt;\s*&lt;/select&gt;' />
			</request>
		</test>
		<test name="Try bulk delete of HHDC snags.">
			<request path="/chellow/reports/279/output/" method="post">
				<control name="hhdc_contract_id" value="54" />
				<control name="ignore_year" value="2010" />
				<control name="ignore_month" value="01" />
				<control name="ignore_day" value="13" />
				<control name="ignore_hour" value="00" />
				<control name="ignore_minute" value="00" />
				<control name="ignore_snags" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Check python compile error gives a reasonable message.">
			<request path="/chellow/reports/317/output/" method="post">
				<control name="supplier_contract_id" value="55" />
				<control name="party_id" value="25" /> <!-- BIZZ -->
				<control name="name" value="Half-hourlies 2007" />
				<control name="charge_script">
				<![CDATA[
def virtual_bill(supply, startDate, finishDate, pw):
    syntax error]]>
				</control>
				<control name="properties" value="{}" />
				<regex pattern="mismatched input &amp;#39;error&amp;#39; expecting NEWLINE|invalid syntax \(&amp;lt;unknown&amp;gt;, line 4\)" />
				<response-code value="400" />
			</request>
			<!-- Put back to how it was before -->
			<request path="/chellow/reports/317/output/" method="post">
				<control name="supplier_contract_id" value="55" />
				<control name="party_id" value="25" />
				<control name="name" value="Half-hourlies 2007" />
				<control name="charge_script"><![CDATA[from net.sf.chellow.monad import Monad
import datetime
import pytz
from dateutil.relativedelta import relativedelta

Monad.getUtils()['impt'](globals(), 'db', 'utils', 'templater', 'triad', 'computer', 'ccl', 'bsuos', 'tlms', 'duos', 'system_price')

HH = utils.HH

def virtual_bill_titles():
    return ['net-gbp', 'tlm', 'ccl-kwh', 'ccl-rate', 'ccl-gbp', 'data-collection-gbp', 'duos-availability-kva', 'duos-availability-days', 'duos-availability-rate', 'duos-availability-gbp', 'duos-excess-availability-kva', 'duos-excess-availability-days', 'duos-excess-availability-rate', 'duos-excess-availability-gbp','duos-day-kwh', 'duos-day-gbp', 'duos-night-kwh', 'duos-night-gbp', 'duos-reactive-rate', 'duos-reactive-gbp', 'duos-standing-gbp', 'settlement-gbp', 'night-msp-kwh', 'night-gsp-kwh', 'night-gbp', 'other-msp-kwh', 'other-gsp-kwh', 'other-gbp', 'summer-pk-msp-kwh', 'summer-pk-gsp-kwh', 'summer-pk-gbp', 'winter-low-pk-msp-kwh', 'winter-low-pk-gsp-kwh', 'winter-low-pk-gbp', 'winter-off-pk-msp-kwh', 'winter-off-pk-gsp-kwh', 'winter-off-pk-gbp', 'winter-pk-msp-kwh', 'winter-pk-gsp-kwh', 'winter-pk-gbp', 'bsuos-kwh', 'bsuos-rate', 'bsuos-gbp', 'triad-actual-1-date', 'triad-actual-1-msp-kw', 'triad-actual-1-status', 'triad-actual-1-laf', 'triad-actual-1-gsp-kw', 'triad-actual-2-date', 'triad-actual-2-msp-kw', 'triad-actual-2-status', 'triad-actual-2-laf', 'triad-actual-2-gsp-kw', 'triad-actual-3-date', 'triad-actual-3-msp-kw', 'triad-actual-3-status', 'triad-actual-3-laf', 'triad-actual-3-gsp-kw', 'triad-actual-gsp-kw', 'triad-actual-rate', 'triad-actual-gbp', 'triad-estimate-1-date', 'triad-estimate-1-msp-kw', 'triad-estimate-1-status', 'triad-estimate-1-laf', 'triad-estimate-1-gsp-kw', 'triad-estimate-2-date', 'triad-estimate-2-msp-kw', 'triad-estimate-2-status', 'triad-estimate-2-laf', 'triad-estimate-2-gsp-kw', 'triad-estimate-3-date', 'triad-estimate-3-msp-kw', 'triad-estimate-3-status', 'triad-estimate-3-laf', 'triad-estimate-3-gsp-kw', 'triad-estimate-gsp-kw', 'triad-estimate-rate', 'triad-estimate-months', 'triad-estimate-gbp', 'triad-all-estimates-months', 'triad-all-estimates-gbp', 'problem']

def displaced_virtual_bill_titles():
    return ['net-gbp', 'bsuos-kwh', 'bsuos-rate', 'bsuos-gbp', 'ccl-kwh', 'ccl-rate', 'ccl-gbp', 'ssp-rate', 'tlm', 'duos-green-kwh', 'duos-green-rate', 'duos-green-gbp', 'duos-reactive-gbp', 'duos-reactive-working', 'duos-standing-gbp', 'night-gbp', 'night-gsp-kwh', 'night-msp-kwh', 'other-gbp', 'other-gsp-kwh', 'other-msp-kwh', 'summer-pk-gbp', 'summer-pk-gsp-kwh', 'summer-pk-msp-kwh', 'triad-gbp', 'triad-working', 'winter-low-pk-gbp', 'winter-low-pk-gsp-kwh', 'winter-low-pk-msp-kwh', 'winter-off-pk-gbp', 'winter-off-pk-gsp-kwh', 'winter-off-pk-msp-kwh', 'winter-pk-gbp', 'winter-pk-gsp-kwh', 'winter-pk-msp-kwh', 'triad-actual-1-date', 'triad-actual-1-msp-kw', 'triad-actual-1-status', 'triad-actual-1-laf', 'triad-actual-1-gsp-kw', 'triad-actual-2-date', 'triad-actual-2-msp-kw', 'triad-actual-2-status', 'triad-actual-2-laf', 'triad-actual-2-gsp-kw', 'triad-actual-3-date', 'triad-actual-3-msp-kw', 'triad-actual-3-status', 'triad-actual-3-laf', 'triad-actual-3-gsp-kw', 'triad-actual-gsp-kw', 'triad-actual-rate', 'triad-actual-gbp', 'triad-estimate-1-date', 'triad-estimate-1-msp-kw', 'triad-estimate-1-status', 'triad-estimate-1-laf', 'triad-estimate-1-gsp-kw', 'triad-estimate-2-date', 'triad-estimate-2-msp-kw', 'triad-estimate-2-status', 'triad-estimate-2-laf', 'triad-estimate-2-gsp-kw', 'triad-estimate-3-date', 'triad-estimate-3-msp-kw', 'triad-estimate-3-status', 'triad-estimate-3-laf', 'triad-estimate-3-gsp-kw', 'triad-estimate-gsp-kw', 'triad-estimate-rate', 'triad-estimate-months', 'triad-estimate-gbp', 'triad-all-estimates-months', 'triad-all-estimates-gbp', 'problem']

slot_names = ['winter-pk', 'winter-low-pk', 'winter-off-pk', 'summer-pk', 'night', 'other']

slots = {}
for slot_name in slot_names:
    slots[slot_name] = {'msp-kwh': slot_name + '-msp-kwh', 'gsp-kwh': slot_name + '-gsp-kwh', 'gbp': slot_name + '-gbp'}


def displaced_virtual_bill(supply_source):
    bill = supply_source.supplier_bill

    # just check that revolving works
    supply_source.revolve_to_3rd_party_used()
    supply_source.revolve_to_gen_used()
    
    for slot_name in slot_names:
        slot_keys = slots[slot_name]
        bill[slot_keys['msp-kwh']] = 0
        bill[slot_keys['gsp-kwh']] = 0


    supply_source.is_green = False
    duos.duos_vb(supply_source)
    
    for hh in supply_source.hh_data:
        is_weekday = hh['utc-day-of-week'] < 5
        if is_weekday and hh['utc-month'] in (1, 12) and 16 < hh['utc-decimal-hour'] <= 19:
            slot_key = 'winter-pk'
        elif is_weekday and hh['utc-month'] in (2, 11) and 16 < hh['utc-decimal-hour'] <= 19:
            slot_key = 'winter-low-pk'
        elif is_weekday and (hh['utc-month'] > 10 or hh['utc-month'] < 4) and 8 < hh['utc-decimal-hour'] <= 20:
            slot_key = 'winter-off-pk'
        elif is_weekday and (hh['utc-month'] > 3 or hh['utc-month'] < 11) and 8 < hh['utc-decimal-hour'] <= 20:
            slot_key = 'summer-pk'
        elif 0 < hh['utc-decimal-hour'] <= 7:
            slot_key = 'night'
        else:
            slot_key = 'other'
        slot_keys = slots[slot_key]
        bill[slot_keys['msp-kwh']] += hh['msp-kwh']
        bill[slot_keys['gsp-kwh']] += hh['gsp-kwh']
        rates = supply_source.hh_rate(db_id, hh['start-date'], 'gsp_gbp_per_kwh')
        bill[slot_keys['gbp']] += hh['gsp-kwh'] * rates[slot_name]
        
    ccl.ccl(supply_source)

    for suffix in ['kwh', 'rate', 'gbp']:
        key = 'lec-' + suffix
        if key in bill:
            del bill[key]

    triad.triad_bill(supply_source)
    tlms.hh(supply_source)
    bsuos.hh(supply_source)
    system_price.hh(supply_source)

    for rate_name, rate_set in supply_source.supplier_rate_sets.iteritems():
        if len(rate_set) == 1:
            bill[rate_name] = rate_set.pop()

    for k in bill.keys():
        if k.startswith('duos-reactive-'):
            del bill[k]

    bill['net-gbp'] = sum(v for k, v in bill.iteritems() if k[-4:] == '-gbp')


def virtual_bill(supply_source):
    duos.duos_vb(supply_source)
    bill = supply_source.supplier_bill
    bill.update({'net-gbp': 0, 'data-collection-gbp': 0, 'settlement-gbp': 0, 'problem': ''})

    for slot_name in slot_names:
        slot_keys = slots[slot_name]
        bill[slot_keys['msp-kwh']] = 0
        bill[slot_keys['gsp-kwh']] = 0


    llfc_code = supply_source.llfc_code
    voltage_level = supply_source.voltage_level_code
    is_substation = supply_source.is_substation
    supply_capacity = supply_source.sc
    supply_source.is_green = False

    for datum in supply_source.hh_data:
        is_weekday = datum['utc-day-of-week'] < 5
        if is_weekday and datum['utc-month'] in (1, 12) and 16 < datum['utc-decimal-hour'] <= 19:
            slot_key = 'winter-pk'
        elif is_weekday and datum['utc-month'] in (2, 11) and 16 < datum['utc-decimal-hour'] <= 19:
            slot_key = 'winter-low-pk'
        elif is_weekday and (datum['utc-month'] > 10 or datum['utc-month'] < 4) and 8 < datum['utc-decimal-hour'] <= 20:
            slot_key = 'winter-off-pk'
        elif is_weekday and (datum['utc-month'] > 3 or datum['utc-month'] < 11) and 8 < datum['utc-decimal-hour'] <= 20:
            slot_key = 'summer-pk'
        elif 0 < datum['utc-decimal-hour'] <= 7:
            slot_key = 'night'
        else:
            slot_key = 'other'
        slot_keys = slots[slot_key]
        bill[slot_keys['msp-kwh']] += datum['msp-kwh']
        bill[slot_keys['gsp-kwh']] += datum['gsp-kwh']

    month_begin = datetime.datetime(supply_source.start_date.year, supply_source.start_date.month, 1, tzinfo=pytz.utc)
    month_end = month_begin + relativedelta(months=1) - HH

    ccl.ccl(supply_source)

    for suffix in ['kwh', 'rate', 'gbp']:
        key = 'lec-' + suffix
        if key in bill:
            del bill[key]

    bill['data-collection-gbp'] += 5.89
    bill['settlement-gbp'] += 88

    triad.triad_bill(supply_source)
    tlms.hh(supply_source)
    bsuos.hh(supply_source)
    rates = supply_source.hh_rate(db_id, supply_source.finish_date, 'gsp_gbp_per_kwh')
    for slot_name in slot_names:
        slot_keys = slots[slot_name]
        bill[slot_keys['gbp']] = bill[slot_keys['gsp-kwh']] * rates[slot_name]

    for rate_name, rate_set in supply_source.supplier_rate_sets.iteritems():
        if len(rate_set) == 1:
            bill[rate_name] = rate_set.pop()
            
    bill['net-gbp'] = sum(v for k, v in bill.iteritems() if k[-4:] == '-gbp')]]></control>
				<control name="properties" value="{}"/>
				<response-code value="303" />
			</request>
		</test>
		<test
			name="Check that when there are gt 2 eras, the previous era is updated. Supply 1">
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="15" />
				<control name="start_year" value="2008" />
				<control name="start_month" value="09" />
				<control name="start_day" value="06" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 0470 7514 535" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="01" />
				<control name="msn" value="" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="exp_llfc_code" value="581" />
				<control name="exp_mpan_core" value="22 0470 7514 535" />
				<control name="exp_sc" value="150" />
				<control name="exp_supplier_contract_id" value="55" />
				<control name="exp_supplier_account" value="010" />

				<response-code value="303" />
			</request>

			<!-- Supply 1 -->
			<request path="/chellow/reports/307/output/?era_id=14">
				<regex
					pattern='&lt;select name="finish_day"&gt;\s*&lt;option value="1"&gt;01&lt;/option&gt;\s*&lt;option value="2"&gt;02&lt;/option&gt;\s*&lt;option value="3"&gt;03&lt;/option&gt;\s*&lt;option value="4"&gt;04&lt;/option&gt;\s*&lt;option value="5" selected&gt;05&lt;/option&gt;' />
			</request>
		</test>
		<test name="Check supplies snapshot">
			<request path="/chellow/reports/33/output/?year=2005&amp;month=12">
				<response-code value="200" />
				<regex
					pattern='"2005-12-31 23:30","CI005","Wheal Rodney","","","11","net","","22","LV","nhh","no","05","803","5","0154","2","MOP Contract","mc-22 9974 3438 105","Dynamat data","dc-22 9974 3438 105","K87D74429","2005-10-06 00:00","","","","","false","false","false","false","false","false","22 9974 3438 105","20","540","PC 5-8 &amp; HH S/S","Non half-hourlies 2007","341665","","","","","","","","","",""' />
			</request>
		</test>
		<test name="Generate an orphaned hh data message. Supply 5">
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="5" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="msn" value="" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 0883 6932 301" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="22 0883 6932 301" />
				<control name="imp_llfc_code" value="570" />
				<control name="imp_mpan_core" value="22 0883 6932 301" />
				<control name="imp_sc" value="350" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="01" />

				<response-code value="400" />
				<regex
					pattern='There are orphaned HH data between 2003-08-03 00:00 and 2010-08-02 23:30\.' />
			</request>

			<!-- Generate similar one for ongoing orphaned data -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="5" />
				<control name="start_year" value="2003" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="true" />
				<control name="finish_year" value="2003" />
				<control name="finish_month" value="08" />
				<control name="finish_day" value="03" />
				<control name="finish_hour" value="00" />
				<control name="finish_minute" value="00" />
				<control name="msn" value="" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 0883 6932 301" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="22 0883 6932 301" />
				<control name="imp_llfc_code" value="570" />
				<control name="imp_mpan_core" value="22 0883 6932 301" />
				<control name="imp_sc" value="350" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="01" />

				<response-code value="400" />
				<regex
					pattern='There are orphaned HH data between 2003-08-03 00:30 and ongoing\.' />
			</request>
		</test>
		<test name="Test deleting of supplier contracts">
			<!-- Create a new supplier contract -->
			<request path="/chellow/reports/315/output/" method="post">
				<control name="participant_id" value="308" /> <!-- RWED -->
				<control name="name" value="GDF" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="charge_script" value="" />
				<control name="properties" value="{}" />

				<regex pattern="/reports/77/output/\?supplier_contract_id=60" />
				<response-code value="303" />
			</request>

			<!-- Now delete the contract -->
			<request path="/chellow/reports/317/output/" method="post">
				<control name="supplier_contract_id" value="60" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>

			<!-- Check that it's really gone -->
			<request path="/chellow/reports/317/output/?supplier_contract_id=60">
				<response-code value="404" />
			</request>
		</test>
		<test name="Test deleting of HHDC contracts">
			<!-- Create an HHDC contract -->
			<request path="/chellow/reports/277/output/" method="post">
				<control name="participant_id" value="344" /> <!-- UKDC -->
				<control name="name" value="Siemens Contract" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<response-code value="303" />
				<regex pattern="/chellow/reports/115/output/\?hhdc_contract_id=61" />
			</request>

			<!-- Now delete the contract -->
			<request path="/chellow/reports/279/output/" method="post">
				<control name="hhdc_contract_id" value="61" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>

			<!-- Check that it's really gone -->
			<request path="/chellow/reports/115/output/?hhdc_contract_id=61">
				<response-code value="404" />
			</request>
		</test>
		<test name="Check TRIAD calculation for March">
			<!-- Load in march's HH data -->
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="hh_data_long.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=12" />
			</request>

			<request path="/chellow/reports/295/output/?process_id=12">
				<refresh max="45" />
				<response-code value="200" />
				<regex pattern="The file has been imported successfully\." />
			</request>

			<!-- Create the virtual bill -->
			<request path="/chellow/reports/265/output/" method="post">
				<control name="is_core" value="false" />
				<control name="name" value="TRIAD Estimates" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<regex pattern="/reports/267/output/\?non_core_contract_id=62" />
				<response-code value="303" />
			</request>

			<!-- Edit the rate script -->
			<request path="/chellow/reports/273/output/" method="post">
				<control name="rate_script_id" value="315" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="script">
				<![CDATA[
def triad_estimates():
    return {}]]>
				</control>
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/291/output/?supply_id=7&amp;start_year=2009&amp;start_month=03&amp;start_day=01&amp;start_hour=00&amp;start_minute=0&amp;finish_year=2009&amp;finish_month=03&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<response-code value="200" />
				<regex
					pattern='"Imp MPAN Core","Exp MPAN Core","Site Code","Site Name","Account","From","To","","mop-net-gbp","mop-problem","","dc-net-gbp","dc-problem","","imp-supplier-net-gbp","imp-supplier-tlm","imp-supplier-ccl-kwh","imp-supplier-ccl-rate","imp-supplier-ccl-gbp","imp-supplier-data-collection-gbp","imp-supplier-duos-availability-kva","imp-supplier-duos-availability-days","imp-supplier-duos-availability-rate","imp-supplier-duos-availability-gbp","imp-supplier-duos-excess-availability-kva","imp-supplier-duos-excess-availability-days","imp-supplier-duos-excess-availability-rate","imp-supplier-duos-excess-availability-gbp","imp-supplier-duos-day-kwh","imp-supplier-duos-day-gbp","imp-supplier-duos-night-kwh","imp-supplier-duos-night-gbp","imp-supplier-duos-reactive-rate","imp-supplier-duos-reactive-gbp","imp-supplier-duos-standing-gbp","imp-supplier-settlement-gbp","imp-supplier-night-msp-kwh","imp-supplier-night-gsp-kwh","imp-supplier-night-gbp","imp-supplier-other-msp-kwh","imp-supplier-other-gsp-kwh","imp-supplier-other-gbp","imp-supplier-summer-pk-msp-kwh","imp-supplier-summer-pk-gsp-kwh","imp-supplier-summer-pk-gbp","imp-supplier-winter-low-pk-msp-kwh","imp-supplier-winter-low-pk-gsp-kwh","imp-supplier-winter-low-pk-gbp","imp-supplier-winter-off-pk-msp-kwh","imp-supplier-winter-off-pk-gsp-kwh","imp-supplier-winter-off-pk-gbp","imp-supplier-winter-pk-msp-kwh","imp-supplier-winter-pk-gsp-kwh","imp-supplier-winter-pk-gbp","imp-supplier-bsuos-kwh","imp-supplier-bsuos-rate","imp-supplier-bsuos-gbp","imp-supplier-triad-actual-1-date","imp-supplier-triad-actual-1-msp-kw","imp-supplier-triad-actual-1-status","imp-supplier-triad-actual-1-laf","imp-supplier-triad-actual-1-gsp-kw","imp-supplier-triad-actual-2-date","imp-supplier-triad-actual-2-msp-kw","imp-supplier-triad-actual-2-status","imp-supplier-triad-actual-2-laf","imp-supplier-triad-actual-2-gsp-kw","imp-supplier-triad-actual-3-date","imp-supplier-triad-actual-3-msp-kw","imp-supplier-triad-actual-3-status","imp-supplier-triad-actual-3-laf","imp-supplier-triad-actual-3-gsp-kw","imp-supplier-triad-actual-gsp-kw","imp-supplier-triad-actual-rate","imp-supplier-triad-actual-gbp","imp-supplier-triad-estimate-1-date","imp-supplier-triad-estimate-1-msp-kw","imp-supplier-triad-estimate-1-status","imp-supplier-triad-estimate-1-laf","imp-supplier-triad-estimate-1-gsp-kw","imp-supplier-triad-estimate-2-date","imp-supplier-triad-estimate-2-msp-kw","imp-supplier-triad-estimate-2-status","imp-supplier-triad-estimate-2-laf","imp-supplier-triad-estimate-2-gsp-kw","imp-supplier-triad-estimate-3-date","imp-supplier-triad-estimate-3-msp-kw","imp-supplier-triad-estimate-3-status","imp-supplier-triad-estimate-3-laf","imp-supplier-triad-estimate-3-gsp-kw","imp-supplier-triad-estimate-gsp-kw","imp-supplier-triad-estimate-rate","imp-supplier-triad-estimate-months","imp-supplier-triad-estimate-gbp","imp-supplier-triad-all-estimates-months","imp-supplier-triad-all-estimates-gbp","imp-supplier-problem"' />
				<regex
					pattern='"22 4862 4512 332","","CH023","Treglisson","11640077","2009-03-01 00:00","2009-03-31 23:30","","0","","","0","","","10614.4095537","","148925.71","0.00456","679.1012376","5.89","230","31","0.0368","262.384","169.72","31","0.0368","193.616576","105487.44","770.058312","43438.27","112.939502","0.0033","0.0","","88","43401.25","46092.1275","288.794834064","54364.73","57735.34326","361.74656673","0","0","0.0","0","0","0.0","51159.73","54331.63326","340.420281354","0","0","0.0","159627.381103","","146.91999205","2009-01-06 17:00","288.82","A","1.07","309.0374","2008-12-01 17:00","384.44","A","1.07","411.3508","2008-12-15 17:00","185.36","A","1.07","198.3352","306.241133333","25.212997","7721.25677601","2007-12-17 17:00","0","E","1.07","0.0","2008-01-03 17:00","43.6","A","1.062","46.3032","2007-11-26 17:00","0","E","1.07","0.0","15.4344","25.212997","1","32.4289567414","12","-389.147480897",""' />

				<regex pattern="text/csv" />
				<regex pattern="supply_virtual_bills_7.csv" />
			</request>

			<!-- Try looking at it using the TRIAD report -->
			<request path="/chellow/reports/41/output/?supply_id=4&amp;year=2010">
				<response-code value="200" />
				<regex
					pattern='CI005,"Wheal Rodney","1",net,"","22 6158 2968 220","2010-01-07 17:00","0","E","1.058","0.0","2010-01-25 17:00","0","E","1.058","0.0","2009-12-15 17:00","0","E","1.058","0.0","0.0","25.631634","0.0","22 3479 7618 470","2010-01-07 17:00","0","E","1.058","0.0","2010-01-25 17:00","0","E","1.058","0.0","2009-12-15 17:00","0","E","1.058","0.0","0.0","25.631634","0.0"' />
			</request>
		</test>
		<test
			name="Check we can delete a rate script (when it's not the only one). Supplier contract 59.">
			<request path="/chellow/reports/319/output/" method="post">
				<control name="supplier_rate_script_id" value="311" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Try 'Supply MPAN Months' report.">
			<request
				path="/chellow/reports/15/output/?supply_id=2&amp;is_import=true&amp;year=2014&amp;years=1">
				<regex pattern="&amp;gt;\s*Import\s*data by month" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try 'Supply Raw HH Data' report.">
			<request
				path="/chellow/reports/17/output/?supply_id=1&amp;months=1&amp;finish_year=2008&amp;finish_month=07">
				<regex pattern='&lt;option value="07" selected&gt;07&lt;/option&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try site graph report.">
			<request
				path="/chellow/reports/21/output/?site_id=7&amp;finish_year=2008&amp;finish_month=7&amp;months=1">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try era graph report.">
			<request
				path="/chellow/reports/23/output/?site_id=7&amp;finish_year=2008&amp;finish_month=7&amp;months=1">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try 'Site HH bulk figures' report.">
			<request
				path="/chellow/reports/29/output/?site_id=5&amp;type=used&amp;months=1&amp;finish_year=2008&amp;finish_month=01">
				<regex pattern="CH023,used,2008-01-01,3.77" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try HHDC virtual bills.">
			<request
				path="/chellow/reports/81/output/?hhdc_contract_id=53&amp;months=1&amp;end_year=2008&amp;end_month=7">
				<response-code value="200" />
				<regex
					pattern='Import MPAN Core, Export MPAN Core, Start Date, Finish Date,net-gbp' />
				<regex
					pattern='22 9205 6799 106,22 0470 7514 535,2008-07-01 00:00,2008-07-06 23:30,"0",' />
				<regex pattern='attachment; filename="hhdc_vbs.csv"' />
			</request>
		</test>
		<test name="CSV Sites HH Data">
			<!-- Can we make a supply have source sub and view site level hh data 
				okay? -->
			<request method="post" path="/chellow/reports/305/output/">
				<!-- Can we update a supply name? -->
				<!-- Can we update a supply source? -->
				<control name="supply_id" value="1" />
				<control name="name" value="Hello" />
				<control name="source_id" value="2" />
				<control name="generator_type_id" value="1" />
				<control name="gsp_group_id" value="11" />

				<regex pattern='/reports/7/output/\?supply_id=1' />
				<response-code value="303" />
			</request>

			<request
				path="/chellow/reports/183/output/?start_year=2008&amp;start_month=07&amp;start_day=1&amp;start_hour=0&amp;start_minute=0&amp;finish_year=2008&amp;finish_month=07&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<response-code value="200" />
			</request>
		</test>
		<test name="CSV Supplies Duration">
			<request
				path="/chellow/reports/149/output/?start_year=2009&amp;start_month=03&amp;start_day=1&amp;start_hour=0&amp;start_minute=0&amp;finish_year=2009&amp;finish_month=03&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<regex
					pattern='"7","1","net","","CH023","Treglisson","2009-03-01 00:00","2009-03-31 23:30","00","845","5","","0","hh",540,22 4862 4512 332,230,Half-hourlies 2007,148925.71,0,158159.10402,399.72,2009-03-13 08:00,None,0,,,,,0,0,,0,,None,1488' />
			</request>
		</test>

		<test name="Manipulate dno contracts">
			<!-- Insert rate script -->
			<request path="/chellow/reports/243/output/" method="post">
				<control name="dno_contract_id" value="37" /> <!-- DNO 10 -->
				<control name="start_year" value="2010" />
				<control name="start_month" value="05" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<regex pattern="/chellow/reports/69/output/\?dno_rate_script_id=316" />
				<response-code value="303" />
			</request>

			<!-- Test bad syntax gives an error -->
			<request path="/chellow/reports/285/output/" method="post">
				<control name="dno_rate_script_id" value="316" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="05" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="script" value="{{/0erk" />
				<control name="update" value="Update" />
				<response-code value="400" />
			</request>

			<!-- Delete rate script -->
			<request path="/chellow/reports/285/output/" method="post">
				<control name="dno_rate_script_id" value="316" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="CSV Sites Monthly Duration">
			<request
				path="/chellow/reports/161/output/?site_id=5&amp;months=1&amp;finish_year=2009&amp;finish_month=03">
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/251/output/">
				<refresh max="20" />
				<regex pattern="FINISHED_site_monthly_duration_for_CH023_1_to_2009_3\.csv" />
				<response-code value="200" />
			</request>
		</test>
		<test name="CSV Sites TRIAD">
			<request path="/chellow/reports/181/output/?site_id=1&amp;year=2010">
				<response-code value="200" />
			</request>
		</test>
		<test name="CSV Sites Monthly Duration">
			<!-- See if it handles the case where there isn't an import virtual bill 
				function. -->
			<request
				path="/chellow/reports/161/output/?site_id=4&amp;months=1&amp;finish_year=2009&amp;finish_month=04">
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/251/output/">
				<refresh max="20" />
				<regex pattern="FINISHED_site_monthly_duration_for_CI017_1_to_2009_4\.csv" />
				<response-code value="200" />
			</request>
			<request
				path="/chellow/reports/253/output/?name=FINISHED_site_monthly_duration_for_CI017_1_to_2009_4.csv">
				<refresh />
				<response-code value="200" />
				<regex
					pattern='Site Id,Site Name,Associated Site Ids,Sources,Generator Types,Month,Metered Imported kWh,Metered Displaced kWh,Metered Exported kWh,Metered Used kWh,Metered Parasitic kWh,Metered Generated kWh,Metered 3rd Party Import kWh,Metered 3rd Party Export kWh,Metered Imported GBP,Metered Displaced GBP,Metered Exported GBP,Metered Used GBP,Metered 3rd Party Import GBP,Billed Imported kWh,Billed Imported GBP,Metering Type,Problem' />
				<regex
					pattern='"CI017","Roselands","","net","","2009-04-30 23:30","0","0","0","0","0","0","0","0","2784.89","0","0","2784.89","0","0","0","hh","Can&#39;t find the virtual_bill function in the supplier contract. "' />
			</request>
			<!-- Update the supplier contract -->
			<request path="/chellow/reports/317/output/" method="post">
				<control name="supplier_contract_id" value="58" />
				<control name="party_id" value="25" /> <!-- BIZZ -->
				<control name="name" value="Half-hourlies 2013" />
				<control name="charge_script"><![CDATA[from net.sf.chellow.monad import Monad
import datetime
from dateutil.relativedelta import relativedelta
import pytz
from sqlalchemy import or_

Monad.getUtils()['impt'](globals(), 'computer', 'db', 'utils', 'computer', 'triad', 'ccl', 'bsuos', 'tlms', 'duos', 'rcrc')


def virtual_bill_titles():
    return ['net-gbp', 'tlm', 'ccl-kwh', 'ccl-rate', 'ccl-gbp', 'data-collection-gbp', 'duos-availability-kva', 'duos-availability-days', 'duos-availability-rate', 'duos-availability-gbp', 'duos-excess-availability-kva', 'duos-excess-availability-days', 'duos-excess-availability-rate', 'duos-excess-availability-gbp','duos-green-kwh', 'duos-green-rate', 'duos-green-gbp', 'duos-green-kwh', 'duos-green-rate', 'duos-amber-gbp', 'duos-amber-kwh', 'duos-red-rate', 'duos-red-gbp', 'duos-reactive-rate', 'duos-reactive-gbp','duos-fixed-days', 'duos-fixed-rate', 'duos-fixed-gbp', 'settlement-gbp', 'night-msp-kwh', 'night-gsp-kwh', 'night-gbp', 'other-msp-kwh', 'other-gsp-kwh', 'other-gbp', 'summer-pk-msp-kwh', 'summer-pk-gsp-kwh', 'summer-pk-gbp', 'winter-low-pk-msp-kwh', 'winter-low-pk-gsp-kwh', 'winter-low-pk-gbp', 'winter-off-pk-msp-kwh', 'winter-off-pk-gsp-kwh', 'winter-off-pk-gbp', 'winter-pk-msp-kwh', 'winter-pk-gsp-kwh', 'winter-pk-gbp', 'bsuos-kwh', 'bsuos-rate', 'bsuos-gbp', 'triad-actual-1-date', 'triad-actual-1-msp-kw', 'triad-actual-1-status', 'triad-actual-1-laf', 'triad-actual-1-gsp-kw', 'triad-actual-2-date', 'triad-actual-2-msp-kw', 'triad-actual-2-status', 'triad-actual-2-laf', 'triad-actual-2-gsp-kw', 'triad-actual-3-date', 'triad-actual-3-msp-kw', 'triad-actual-3-status', 'triad-actual-3-laf', 'triad-actual-3-gsp-kw', 'triad-actual-gsp-kw', 'triad-actual-rate', 'triad-actual-gbp', 'triad-estimate-1-date', 'triad-estimate-1-msp-kw', 'triad-estimate-1-status', 'triad-estimate-1-laf', 'triad-estimate-1-gsp-kw', 'triad-estimate-2-date', 'triad-estimate-2-msp-kw', 'triad-estimate-2-status', 'triad-estimate-2-laf', 'triad-estimate-2-gsp-kw', 'triad-estimate-3-date', 'triad-estimate-3-msp-kw', 'triad-estimate-3-status', 'triad-estimate-3-laf', 'triad-estimate-3-gsp-kw', 'triad-estimate-gsp-kw', 'triad-estimate-rate', 'triad-estimate-months', 'triad-estimate-gbp', 'triad-all-estimates-months', 'triad-all-estimates-gbp', 'problem']

def displaced_virtual_bill_titles():
    return ['bsuos-kwh', 'bsuos-rate', 'bsuos-gbp', 'ccl-kwh', 'ccl-rate', 'ccl-gbp', 'duos-day-gbp', 'duos-day-kwh', 'duos-night-gbp', 'duos-night-kwh', 'duos-reactive-gbp', 'duos-reactive-working', 'net-gbp', 'duos-standing-gbp', 'night-gbp', 'night-gsp-kwh', 'night-msp-kwh', 'other-gbp', 'other-gsp-kwh', 'other-msp-kwh', 'summer-pk-gbp', 'summer-pk-gsp-kwh', 'summer-pk-msp-kwh', 'triad-gbp', 'triad-working', 'winter-low-pk-gbp', 'winter-low-pk-gsp-kwh', 'winter-low-pk-msp-kwh', 'winter-off-pk-gbp', 'winter-off-pk-gsp-kwh', 'winter-off-pk-msp-kwh', 'winter-pk-gbp', 'winter-pk-gsp-kwh', 'winter-pk-msp-kwh']

slot_names = ['winter-pk', 'winter-low-pk', 'winter-off-pk', 'summer-pk', 'night', 'other']

slots = {}
for slot_name in slot_names:
    slots[slot_name] = {'msp-kwh': slot_name + '-msp-kwh', 'gsp-kwh': slot_name + '-gsp-kwh', 'gbp': slot_name + '-gbp'}


def displaced_virtual_bill(supply_source):
    bill = supply_source.supplier_bill
    
    supply_source.is_green = False
    duos.duos_vb(supply_source)

    for datum in supply_source.hh_data:
        is_weekday = datum['start-date'].weekday() < 5
        if is_weekday and datum['utc-month'] in (1, 12) and 16 < datum['utc-decimal-hour'] <= 19:
            slot_key = 'winter-pk'
        elif is_weekday and datum['utc-month'] in (2, 11) and 16 < datum['utc-decimal-hour'] <= 19:
            slot_key = 'winter-low-pk'
        elif is_weekday and (datum['utc-month'] > 10 or datum['utc-month'] < 4) and 8 < datum['utc-decimal-hour'] <= 20:
            slot_key = 'winter-off-pk'
        elif is_weekday and (datum['utc-month'] > 3 or datum['utc-month'] < 11) and 8 < datum['utc-decimal-hour'] <= 20:
            slot_key = 'summer-pk'
        elif 0 < datum['utc-decimal-hour'] <= 7:
            slot_key = 'night'
        else:
            slot_key = 'other'
        slot_keys = slots[slot_key]
        bill[slot_keys['msp-kwh']] += datum['msp-kwh']
        bill[slot_keys['gsp-kwh']] += datum['gsp-kwh']

    ccl.ccl(supply_source)

    for suffix in ['kwh', 'rate', 'gbp']:
        key = 'lec-' + suffix
        if key in bill:
            del bill[key]

    triad.triad_bill(supply_source)
    tlms.hh(supply_source)
    bsuos.hh(supply_source)

    rates = supply_source.hh_rate(db_id, supply_source.finish_date, 'gsp_gbp_per_kwh')
    for slot_name in slot_names:
        slot_keys = slots[slot_name]
        bill[slot_keys['gbp']] = bill[slot_keys['gsp-kwh']] * rates[slot_name]

    for rate_name, rate_set in supply_source.supplier_rate_sets.iteritems():
        if len(rate_set) == 1:
            bill[rate_name] = rate_set.pop()

    bill['net-gbp'] = sum(v for k, v in bill.iteritems() if k[-4:] == '-gbp')


def virtual_bill(supply_source):
    duos.duos_vb(supply_source)
    ccl.ccl(supply_source)
    triad.triad_bill(supply_source)
    tlms.hh(supply_source)
    rcrc.hh(supply_source)
    bsuos.hh(supply_source)
    
    bill = supply_source.supplier_bill
    supply_source.is_green = False

    for datum in supply_source.hh_data:
        is_weekday = datum['utc-day-of-week'] < 5
        if is_weekday and datum['utc-month'] in (1, 12) and 16 < datum['utc-decimal-hour'] <= 19:
            slot_key = 'winter-pk'
        elif is_weekday and datum['utc-month'] in (2, 11) and 16 < datum['utc-decimal-hour'] <= 19:
            slot_key = 'winter-low-pk'
        elif is_weekday and (datum['utc-month'] > 10 or datum['utc-month'] < 4) and 8 < datum['utc-decimal-hour'] <= 20:
            slot_key = 'winter-off-pk'
        elif is_weekday and (datum['utc-month'] > 3 or datum['utc-month'] < 11) and 8 < datum['utc-decimal-hour'] <= 20:
            slot_key = 'summer-pk'
        elif 0 < datum['utc-decimal-hour'] <= 7:
            slot_key = 'night'
        else:
            slot_key = 'other'
        slot_keys = slots[slot_key]
        bill[slot_keys['msp-kwh']] += datum['msp-kwh']
        bill[slot_keys['gsp-kwh']] += datum['gsp-kwh']
        rates = supply_source.hh_rate(db_id, datum['start-date'], 'gsp_gbp_per_kwh')
        bill[slot_keys['gbp']] += datum['gsp-kwh'] * rates[slot_name]

    for suffix in ['kwh', 'rate', 'gbp']:
        key = 'lec-' + suffix
        if key in bill:
            del bill[key]

    bill['data-collection-gbp'] += 5.89
    bill['settlement-gbp'] += 88
    
    for rate_name, rate_set in supply_source.supplier_rate_sets.iteritems():
        if len(rate_set) == 1:
            bill[rate_name] = rate_set.pop()
    
    bill['net-gbp'] = sum(v for k, v in bill.iteritems() if k[-4:] == '-gbp')
]]></control>
				<control name="properties" value="{}"/>

				<response-code value="303" />
				<regex pattern="/reports/77/output/\?supplier_contract_id=58" />
			</request>
			<request path="/chellow/reports/317/output/" method="post">
				<control name="supplier_contract_id" value="59" />
				<control name="name" value="Non half-hourlies 2007" />
				<control name="party_id" value="351" />
				<control name="charge_script">
				<![CDATA[
def virtual_bill_titles():
    return ['net-gbp', 'vat-gbp', 'gross-gbp', 'sum-msp-kwh', 'problem']


def virtual_bill(supply_source):
    bill = supply_source.supplier_bill
    sum_msp_kwh = sum(h['msp-kwh'] for h in supply_source.hh_data)

    for rate_name, rate_set in supply_source.supplier_rate_sets.iteritems():
        if len(rate_set) == 1:
            bill[rate_name] = rate_set.pop()

    bill.update({'net-gbp': 0.0, 'vat-gbp':0.0, 'gross-gbp': 0.0, 'sum-msp-kwh': sum_msp_kwh})]]>
				</control>
				<control name="properties" value="{}"/>

				<response-code value="303" />
			</request>
		</test>
		<test name="Set configuration properties">
			<request path="/chellow/reports/269/output/" method="post">
				<control name="non_core_contract_id" value="13" />
				<control name="name" value="configuration" />
				<control name="charge_script" value="" />
				<control name="properties"><![CDATA[{
    'ips': {'127.0.0.1': 'implicit-user@localhost'},
    'site_links': [
        {'name': 'Google Maps', 'href': 'https://maps.google.com/maps?q='}]}
]]></control>
				<response-code value="303" />
			</request>
		</test>
		<test name="Site In View World">
			<request path="/chellow/reports/5/output/?site_id=3">
				<response-code value="200" />
				<regex
					pattern='&lt;a href="/chellow/reports/7/output/\?supply_id=2"&gt;view&lt;/a&gt;' />
				<regex
					pattern='&lt;a href="https://maps.google.com/maps\?q=CI005"&gt;Google Maps&lt;/a&gt;' />
				<regex pattern='&lt;option value="imp_net"&gt;Imported&lt;/option&gt;' />
			</request>

			<!-- Check that it shows a dead supply properly. Supply 11 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="11" />
				<control name="start_year" value="2005" />
				<control name="start_month" value="10" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="true" />
				<control name="finish_year" value="2010" />
				<control name="finish_month" value="04" />
				<control name="finish_day" value="13" />
				<control name="finish_hour" value="23" />
				<control name="finish_minute" value="30" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 9974 3438 105" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="dc-22 9974 3438 105" />
				<control name="msn" value="K87D74429" />
				<control name="pc_id" value="5" />
				<control name="mtc_code" value="803" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="0154" />
				<control name="imp_llfc_code" value="540" />
				<control name="imp_mpan_core" value="22 9974 3438 105" />
				<control name="imp_sc" value="20" />
				<control name="imp_supplier_contract_id" value="59" />
				<control name="imp_supplier_account" value="SA341665" />

				<response-code value="303" />
			</request>

			<request path="/chellow/reports/5/output/?site_id=3">
				<response-code value="200" />
				<regex
					pattern='&lt;td&gt;\s*&lt;a href="/chellow/reports/7/output/\?supply_id=11"&gt;view&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;3&lt;/td&gt;\s*&lt;td&gt;2005-10-03 00:00&lt;/td&gt;\s*&lt;td&gt;\s*2010-04-13 23:30\s*&lt;/td&gt;' />
			</request>
		</test>
		<test name="Try a pre 2010-04-01 DNO 20 bill.">
			<!-- Insert a 20 supply -->
			<request path="/chellow/reports/311/output/" method="post">
				<control name="site_id" value="1" />
				<control name="source_id" value="1" />
				<control name="name" value="Reserve Supply" />
				<control name="start_year" value="2003" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="msn" value="" />
				<control name="gsp_group_id" value="8" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 6354 2983 570" />
				<control name="hhdc_contract_id" value="54" />
				<control name="hhdc_account" value="01" />
				<control name="imp_llfc_code" value="453" />
				<control name="imp_mpan_core" value="20 6354 2983 571" />
				<control name="imp_sc" value="2300" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="141 5532" />
				<control name="insert" value="insert" />

				<regex pattern="/reports/7/output/\?supply_id=12" />
				<response-code value="303" />
			</request>

			<!-- Add import related ACTIVE channel. Supply 12 -->
			<request path="/chellow/reports/299/output/" method="post">
				<control name="era_id" value="16" />
				<control name="imp_related" value="true" />
				<control name="channel_type" value="ACTIVE" />
				<regex pattern="/chellow/reports/301/output/\?channel_id=42" />
				<response-code value="303" />
			</request>

			<!-- Try out simple.csv hh import format. -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="54" />
				<control type="file" name="import_file" value="hh.simple.csv" />
				<response-code value="303" />
				<regex pattern="/reports/65/output/\?hhdc_contract_id=54&amp;process_id=0" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=54&amp;process_id=0">
				<refresh />
				<regex pattern="The import has completed.*successfully." />
				<response-code value="200" />
			</request>
			<!-- Check that the first datum has been correctly loaded in -->
			<request
				path="/chellow/reports/17/output/?supply_id=7&amp;months=1&amp;finish_year=2010&amp;finish_month=02">
				<regex
					pattern="&lt;td&gt;\s*2010-02-04 20:00\s*&lt;/td&gt;\s*&lt;td&gt;30.4339&lt;/td&gt;" />
				<response-code value="200" />
			</request>
			<request
				path="/chellow/reports/291/output/?supply_id=12&amp;start_year=2009&amp;start_month=3&amp;start_day=01&amp;start_hour=00&amp;start_minute=0&amp;finish_year=2009&amp;finish_month=03&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<response-code value="200" />
				<regex
					pattern='"Imp MPAN Core","Exp MPAN Core","Site Code","Site Name","Account","From","To","","mop-net-gbp","mop-problem","","dc-net-gbp","dc-problem","","imp-supplier-net-gbp","imp-supplier-tlm","imp-supplier-ccl-kwh","imp-supplier-ccl-rate","imp-supplier-ccl-gbp","imp-supplier-data-collection-gbp","imp-supplier-duos-availability-kva","imp-supplier-duos-availability-days","imp-supplier-duos-availability-rate","imp-supplier-duos-availability-gbp","imp-supplier-duos-excess-availability-kva","imp-supplier-duos-excess-availability-days","imp-supplier-duos-excess-availability-rate","imp-supplier-duos-excess-availability-gbp","imp-supplier-duos-day-kwh","imp-supplier-duos-day-gbp","imp-supplier-duos-night-kwh","imp-supplier-duos-night-gbp","imp-supplier-duos-reactive-rate","imp-supplier-duos-reactive-gbp","imp-supplier-duos-standing-gbp","imp-supplier-settlement-gbp","imp-supplier-night-msp-kwh","imp-supplier-night-gsp-kwh","imp-supplier-night-gbp","imp-supplier-other-msp-kwh","imp-supplier-other-gsp-kwh","imp-supplier-other-gbp","imp-supplier-summer-pk-msp-kwh","imp-supplier-summer-pk-gsp-kwh","imp-supplier-summer-pk-gbp","imp-supplier-winter-low-pk-msp-kwh","imp-supplier-winter-low-pk-gsp-kwh","imp-supplier-winter-low-pk-gbp","imp-supplier-winter-off-pk-msp-kwh","imp-supplier-winter-off-pk-gsp-kwh","imp-supplier-winter-off-pk-gbp","imp-supplier-winter-pk-msp-kwh","imp-supplier-winter-pk-gsp-kwh","imp-supplier-winter-pk-gbp","imp-supplier-bsuos-kwh","imp-supplier-bsuos-rate","imp-supplier-bsuos-gbp","imp-supplier-triad-actual-1-date","imp-supplier-triad-actual-1-msp-kw","imp-supplier-triad-actual-1-status","imp-supplier-triad-actual-1-laf","imp-supplier-triad-actual-1-gsp-kw","imp-supplier-triad-actual-2-date","imp-supplier-triad-actual-2-msp-kw","imp-supplier-triad-actual-2-status","imp-supplier-triad-actual-2-laf","imp-supplier-triad-actual-2-gsp-kw","imp-supplier-triad-actual-3-date","imp-supplier-triad-actual-3-msp-kw","imp-supplier-triad-actual-3-status","imp-supplier-triad-actual-3-laf","imp-supplier-triad-actual-3-gsp-kw","imp-supplier-triad-actual-gsp-kw","imp-supplier-triad-actual-rate","imp-supplier-triad-actual-gbp","imp-supplier-triad-estimate-1-date","imp-supplier-triad-estimate-1-msp-kw","imp-supplier-triad-estimate-1-status","imp-supplier-triad-estimate-1-laf","imp-supplier-triad-estimate-1-gsp-kw","imp-supplier-triad-estimate-2-date","imp-supplier-triad-estimate-2-msp-kw","imp-supplier-triad-estimate-2-status","imp-supplier-triad-estimate-2-laf","imp-supplier-triad-estimate-2-gsp-kw","imp-supplier-triad-estimate-3-date","imp-supplier-triad-estimate-3-msp-kw","imp-supplier-triad-estimate-3-status","imp-supplier-triad-estimate-3-laf","imp-supplier-triad-estimate-3-gsp-kw","imp-supplier-triad-estimate-gsp-kw","imp-supplier-triad-estimate-rate","imp-supplier-triad-estimate-months","imp-supplier-triad-estimate-gbp","imp-supplier-triad-all-estimates-months","imp-supplier-triad-all-estimates-gbp","imp-supplier-problem"' />
				<regex
					pattern='"20 6354 2983 571","","CI004","Lower Treave","141 5532","2009-03-01 00:00","2009-03-31 23:30","","0","","","0","","","2274.51858148","1.0085469","","0.00456","","5.89","2300","","","2165.0","0","","","","","","86.9732","0.102628376","","","14.91","88","86.9732","93.49619","0.585809728064","0","0","0.0","0","0","0.0","0","0","0.0","0","0","0.0","0","0","0.0","94.2952925863","0.00031967","0.0301433761811","2009-01-06 17:00","0","E","1.095","0.0","2008-12-01 17:00","0","E","1.095","0.0","2008-12-15 17:00","0","E","1.095","0.0","0.0","22.19481","0.0","2007-12-17 17:00","0","E","1.095","0.0","2008-01-03 17:00","0","E","1.079","0.0","2007-11-26 17:00","0","E","1.095","0.0","0.0","22.19481","1","0.0","12","-0.0",""' />
			</request>

			<!-- Check it works when the DNO rate script contains a double LLFC 453,470 -->
			<request
				path="/chellow/reports/291/output/?supply_id=12&amp;start_year=2009&amp;start_month=6&amp;start_day=01&amp;start_hour=00&amp;start_minute=0&amp;finish_year=2009&amp;finish_month=06&amp;finish_day=30&amp;finish_hour=23&amp;finish_minute=30">
				<regex
					pattern='"20 6354 2983 571","","CI004","Lower Treave","141 5532","2009-06-01 00:00","2009-06-30 23:30",' />
				<response-code value="200" />
			</request>

			<!-- supply 12, era 16, channel 42 -->
			<request path="/chellow/reports/309/output/?hh_datum_id=6773"
				method="post">
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Delete a supply.">
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="12" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Test importing of sse.edi bills">
			<!-- Create new supplier contract -->
			<request path="/chellow/reports/315/output/" method="post">
				<control name="participant_id" value="6" />
				<control name="name" value="Non half-hourlies 2010" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="charge_script">
				<![CDATA[				
def virtual_bill_titles():
    return ['net-gbp', 'sum-msp-kwh', 'problem']

def virtual_bill(supply_source):
    sum_msp_kwh = sum(h['msp-kwh'] for h in supply_source.hh_data)
    bill = supply_source.supplier_bill
    for rate_name, rate_set in supply_source.supplier_rate_sets.iteritems():
        if len(rate_set) == 1:
            bill[rate_name] = rate_set.pop()
    bill['net-gbp'] = sum_msp_kwh * 0.1
    bill['sum-msp-kwh'] = sum_msp_kwh]]>
				</control>
				<control name="properties" value="{}" />
				<regex pattern="/reports/77/output/\?supplier_contract_id=63" />
				<response-code value="303" />
			</request>

			<!-- Add new era -->
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="10" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="01" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="Insert" />

				<regex pattern="/reports/7/output/\?supply_id=10" />
				<response-code value="303" />
			</request>

			<!-- Change to new supplier contract. Supply 10 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="17" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 1065 3921 534" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="dc-22 1065 3921 534" />
				<control name="msn" value="I02D89150" />
				<control name="pc_id" value="3" />
				<control name="mtc_code" value="801" />
				<control name="cop_id" value="6" />
				<control name="ssc_code" value="0393" />
				<control name="imp_llfc_code" value="110" />
				<control name="imp_mpan_core" value="22 1065 3921 534" />
				<control name="imp_sc" value="30" />
				<control name="imp_supplier_contract_id" value="63" />
				<control name="imp_supplier_account" value="SA342376000" />

				<response-code value="303" />
			</request>

			<!-- Create a new batch -->
			<request path="/chellow/reports/287/output/" method="post">
				<control name="supplier_contract_id" value="63" />
				<control name="reference" value="07-008" />
				<control name="description" value="SSE batch" />
				<response-code value="303" />
			</request>

			<!-- Supplier contract 63. -->
			<request path="/chellow/reports/321/output/" method="post">
				<control name="supplier_batch_id" value="5" />
				<control type="file" name="import_file" value="bills.sse.edi" />
				<response-code value="303" />
				<regex pattern="/reports/323/output/\?importer_id=3" />
			</request>

			<!-- Supplier contract 60. -->
			<request path="/chellow/reports/323/output/?importer_id=3">
				<refresh />
				<regex
					pattern='&lt;th&gt;Reference&lt;/th&gt;\s*&lt;th&gt;Account&lt;/th&gt;\s*&lt;th&gt;Bill Type&lt;/th&gt;\s*&lt;th&gt;MPANs&lt;/th&gt;\s*&lt;th&gt;Issue Date&lt;/th&gt;\s*&lt;th&gt;Start Date&lt;/th&gt;\s*&lt;th&gt;Finish Date&lt;/th&gt;\s*&lt;th&gt;kWh&lt;/th&gt;\s*&lt;th&gt;Net&lt;/th&gt;\s*&lt;th&gt;VAT&lt;/th&gt;\s*&lt;th&gt;Gross&lt;/th&gt;\s*&lt;th&gt;R1 MPAN&lt;/th&gt;\s*&lt;th&gt;R1 Meter Serial Number&lt;/th&gt;\s*&lt;th&gt;R1 Coefficient&lt;/th&gt;\s*&lt;th&gt;R1 Units&lt;/th&gt;\s*&lt;th&gt;R1 TPR&lt;/th&gt;\s*&lt;th&gt;R1 Previous Read Date&lt;/th&gt;\s*&lt;th&gt;R1 Previous Read Value&lt;/th&gt;\s*&lt;th&gt;R1 Previous Read Type&lt;/th&gt;\s*&lt;th&gt;R1 Present Read Date&lt;/th&gt;\s*&lt;th&gt;R1 Present Read Value&lt;/th&gt;\s*&lt;th&gt;R1 Present Read Type&lt;/th&gt;\s*&lt;th&gt;Breakdown&lt;/th&gt;' />
				<regex
					pattern='&lt;td&gt;3423760005&lt;/td&gt;\s*&lt;td&gt;SA342376000&lt;/td&gt;\s*&lt;td&gt;N&lt;/td&gt;\s*&lt;td&gt;\[u?&amp;#39;03 801 110 22 10653921534&amp;#39;\]&lt;/td&gt;\s*&lt;td&gt;2010-05-12 00:00&lt;/td&gt;\s*&lt;td&gt;2010-01-19 00:00&lt;/td&gt;\s*&lt;td&gt;2010-04-20 23:30&lt;/td&gt;\s*&lt;td&gt;253&lt;/td&gt;\s*&lt;td&gt;36.16&lt;/td&gt;\s*&lt;td&gt;1.8&lt;/td&gt;\s*&lt;td&gt;0&lt;/td&gt;\s*&lt;td&gt;03 801 110 22 1065 3921 534&lt;/td&gt;\s*&lt;td&gt;K87D74429&lt;/td&gt;\s*&lt;td&gt;1&lt;/td&gt;\s*&lt;td&gt;kWh&lt;/td&gt;\s*&lt;td&gt;00001&lt;/td&gt;\s*&lt;td&gt;2010-01-18 23:30&lt;/td&gt;\s*&lt;td&gt;16963&lt;/td&gt;\s*&lt;td&gt;E&lt;/td&gt;\s*&lt;td&gt;2010-04-20 23:30&lt;/td&gt;\s*&lt;td&gt;17216&lt;/td&gt;\s*&lt;td&gt;E&lt;/td&gt;' />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>


			<!-- Test the supplier batch checking -->
			<request path="/chellow/reports/111/output/?batch_id=5">
				<refresh />
				<regex
					pattern='batch,bill-reference,bill-type,bill-kwh,bill-net-gbp,bill-vat-gbp, bill-start-date,bill-finish-date,bill-mpan-core,site-code,site-name,covered-from,covered-to,covered-bills,covered-net-gbp,virtual-net-gbp,difference-net-gbp' />
				<regex
					pattern='"07-008","3423760005","N","253","36.16","1.8","2010-01-19 00:00","2010-04-20 23:30","22 1065 3921 534","CI017","Roselands","2010-01-19 00:00","2010-04-20 23:30","10","36.16","25.3","10.86","253.0","253.0","",""' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Test reports for a supply-less site">
			<!-- Create a new site -->
			<request path="/chellow/reports/297/output/" method="post">
				<control name="code" value="B00LG" />
				<control name="name" value="Bieling" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/13/output/?site_id=8&amp;finish_year=2008&amp;finish_month=07">
				<response-code value="200" />
			</request>
		</test>
		<test name="Check can import channel snag ignores okay.">
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="channel-snag-ignores.csv" />
				<response-code value="303" />
				<regex pattern="/chellow/reports/295/output/\?process_id=13" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=13">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check can import site snag ignores okay.">
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="site-snag-ignores.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=14" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=14">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Create a supply, and then delete it.">
			<!-- Test that generator is set to None if source is 'net'. -->
			<request path="/chellow/reports/311/output/" method="post">
				<control name="site_id" value="7" />
				<control name="source_id" value="1" />
				<control name="generator_type_id" value="1" />
				<control name="name" value="Supply H8" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="05" />
				<control name="start_day" value="26" />
				<control name="start_hour" value="05" />
				<control name="start_minute" value="26" />
				<control name="msn" value="" />
				<control name="gsp_group_id" value="3" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 9879 0084 358" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="dc-22 9879 0084 358" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="imp_mpan_core" value="22 9879 0084 358" />
				<control name="imp_llfc_code" value="540" />
				<control name="imp_sc" value="700" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="d" />
				<control name="insert" value="Insert" />

				<regex pattern="/reports/7/output/\?supply_id=13" />
				<response-code value="303" />
			</request>

			<!-- Check that the generator type 'chp' has been ignored. -->
			<request path="/chellow/reports/5/output/?site_id=7">

				<regex pattern="&lt;td&gt;net&lt;/td&gt;\s*&lt;td&gt;\s*&lt;/td&gt;" />
				<response-code value="200" />
			</request>

			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="13" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="GDF CSV Bills">
			<!-- Create a new batch. -->
			<request path="/chellow/reports/287/output/" method="post">
				<control name="supplier_contract_id" value="55" />
				<control name="reference" value="008" />
				<control name="description" value="GDF CSV batch" />
				<response-code value="303" />
			</request>

			<!-- Supplier contract 53 -->
			<request path="/chellow/reports/321/output/" method="post">
				<control name="supplier_batch_id" value="6" />

				<!-- File has a character outside 8 bits to check unicode handling -->
				<control type="file" name="import_file" value="bills.gdf.csv" />

				<response-code value="303" />
				<regex pattern="/reports/323/output/\?importer_id=4" />
			</request>

			<!-- Supplier contract 54, batch 6 -->
			<request path="/chellow/reports/323/output/?importer_id=4">
				<refresh />
				<regex
					pattern='&lt;th&gt;Reference&lt;/th&gt;\s*&lt;th&gt;Account&lt;/th&gt;\s*&lt;th&gt;Bill Type&lt;/th&gt;\s*&lt;th&gt;MPANs&lt;/th&gt;\s*&lt;th&gt;Issue Date&lt;/th&gt;\s*&lt;th&gt;Start Date&lt;/th&gt;\s*&lt;th&gt;Finish Date&lt;/th&gt;\s*&lt;th&gt;kWh&lt;/th&gt;\s*&lt;th&gt;Net&lt;/th&gt;\s*&lt;th&gt;VAT&lt;/th&gt;\s*&lt;th&gt;Gross&lt;/th&gt;\s*&lt;th&gt;Breakdown&lt;/th&gt;' />
				<regex
					pattern='&lt;td&gt;KUH773&lt;/td&gt;\s*&lt;td&gt;02&lt;/td&gt;\s*&lt;td&gt;N&lt;/td&gt;\s*&lt;td&gt;\[\]&lt;/td&gt;\s*&lt;td&gt;2010-06-09 00:00&lt;/td&gt;\s*&lt;td&gt;2010-05-01 00:00&lt;/td&gt;\s*&lt;td&gt;2010-05-31 23:30&lt;/td&gt;\s*&lt;td&gt;32124.5&lt;/td&gt;\s*&lt;td&gt;2219.41&lt;/td&gt;\s*&lt;td&gt;388.4&lt;/td&gt;\s*&lt;td&gt;2607.81&lt;/td&gt;' />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>

			<request path="/chellow/reports/323/output/?importer_id=4">
				<refresh />
				<regex
					pattern='&lt;th&gt;Reference&lt;/th&gt;\s*&lt;th&gt;Account&lt;/th&gt;\s*&lt;th&gt;Bill Type&lt;/th&gt;\s*&lt;th&gt;MPANs&lt;/th&gt;\s*&lt;th&gt;Issue Date&lt;/th&gt;\s*&lt;th&gt;Start Date&lt;/th&gt;\s*&lt;th&gt;Finish Date&lt;/th&gt;\s*&lt;th&gt;kWh&lt;/th&gt;\s*&lt;th&gt;Net&lt;/th&gt;\s*&lt;th&gt;VAT&lt;/th&gt;\s*&lt;th&gt;Gross&lt;/th&gt;\s*&lt;th&gt;Breakdown&lt;/th&gt;' />
				<regex
					pattern='&lt;td&gt;KUH773&lt;/td&gt;\s*&lt;td&gt;02&lt;/td&gt;\s*&lt;td&gt;N&lt;/td&gt;\s*&lt;td&gt;\[\]&lt;/td&gt;\s*&lt;td&gt;2010-06-09 00:00&lt;/td&gt;\s*&lt;td&gt;2010-05-01 00:00&lt;/td&gt;\s*&lt;td&gt;2010-05-31 23:30&lt;/td&gt;\s*&lt;td&gt;32124.5&lt;/td&gt;\s*&lt;td&gt;2219.41&lt;/td&gt;\s*&lt;td&gt;388.4&lt;/td&gt;\s*&lt;td&gt;2607.81&lt;/td&gt;' />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>

			<!-- Check the bill appears correctly in batch view -->
			<request path="/chellow/reports/91/output/?supplier_batch_id=6">
				<regex
					pattern='&lt;td&gt;2010-06-09 00:00&lt;/td&gt;\s*&lt;td&gt;2010-05-01 00:00&lt;/td&gt;\s*&lt;td&gt;2010-05-31 23:30&lt;/td&gt;\s*&lt;td&gt;32124.5&lt;/td&gt;\s*&lt;td&gt;2219.41&lt;/td&gt;\s*&lt;td&gt;388.4&lt;/td&gt;\s*&lt;td&gt;2607.81&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Test displaced virtual bill.">
			<request
				path="/chellow/reports/389/output/?site_id=1&amp;months=1&amp;finish_year=2010&amp;finish_month=06">
				<refresh />
				<regex
					pattern='Site Code,Site Name,Associated Site Ids,From,To,Gen Types,CHP kWh,LM kWh,Turbine kWh,net-gbp,bsuos-kwh,bsuos-rate,bsuos-gbp,ccl-kwh,ccl-rate,ccl-gbp,ssp-rate,tlm,duos-green-kwh,duos-green-rate,duos-green-gbp,duos-reactive-gbp,duos-reactive-working,duos-standing-gbp,night-gbp,night-gsp-kwh,night-msp-kwh,other-gbp,other-gsp-kwh,other-msp-kwh,summer-pk-gbp,summer-pk-gsp-kwh,summer-pk-msp-kwh,triad-gbp,triad-working,winter-low-pk-gbp,winter-low-pk-gsp-kwh,winter-low-pk-msp-kwh,winter-off-pk-gbp,winter-off-pk-gsp-kwh,winter-off-pk-msp-kwh,winter-pk-gbp,winter-pk-gsp-kwh,winter-pk-msp-kwh,triad-actual-1-date,triad-actual-1-msp-kw,triad-actual-1-status,triad-actual-1-laf,triad-actual-1-gsp-kw,triad-actual-2-date,triad-actual-2-msp-kw,triad-actual-2-status,triad-actual-2-laf,triad-actual-2-gsp-kw,triad-actual-3-date,triad-actual-3-msp-kw,triad-actual-3-status,triad-actual-3-laf,triad-actual-3-gsp-kw,triad-actual-gsp-kw,triad-actual-rate,triad-actual-gbp,triad-estimate-1-date,triad-estimate-1-msp-kw,triad-estimate-1-status,triad-estimate-1-laf,triad-estimate-1-gsp-kw,triad-estimate-2-date,triad-estimate-2-msp-kw,triad-estimate-2-status,triad-estimate-2-laf,triad-estimate-2-gsp-kw,triad-estimate-3-date,triad-estimate-3-msp-kw,triad-estimate-3-status,triad-estimate-3-laf,triad-estimate-3-gsp-kw,triad-estimate-gsp-kw,triad-estimate-rate,triad-estimate-months,triad-estimate-gbp,triad-all-estimates-months,triad-all-estimates-gbp,problem' />
				<regex
					pattern='"CI004","Lower Treave","","2010-06-01 00:00","2010-06-30 23:30","chp","","","","0.0","0.0","0.00152641","0.0","","0.0047","","0.02303696","1.008955","0","0.0013","0.0","","","","","0","0","0.0","0.0","0","","0","0","","","","0","0","","0","0","","0","0","","","","","","","","","","","","","","","","","","","2010-01-07 17:00","0","E","1.078","0.0","2010-01-25 17:00","0","E","1.078","0.0","2009-12-15 17:00","0","E","1.078","0.0","0.0","26.057832","1","0.0","","",""' />
				<response-code value="200" />
			</request>

			<!-- Try a 12 month run -->
			<request
				path="/chellow/reports/389/output/?site_id=1&amp;months=12&amp;finish_year=2011&amp;finish_month=06">
				<response-code value="200" />
			</request>
		</test>
		<test name="Test bulk ignore.">
			<request path="/chellow/reports/279/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control name="ignore_year" value="2008" />
				<control name="ignore_month" value="09" />
				<control name="ignore_day" value="01" />
				<control name="ignore_hour" value="00" />
				<control name="ignore_minute" value="00" />
				<control name="ignore_snags" value="Ignore Snags" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Check that a era can be deleted. Supply 1">
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="14" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test
			name="Check a contract virtual bill that crosses a era boundary comes out correctly.">
			<request
				path="/chellow/reports/291/output/?supply_id=11&amp;start_year=2010&amp;start_month=04&amp;start_day=01&amp;start_hour=00&amp;start_minute=00&amp;finish_year=2010&amp;finish_month=04&amp;finish_day=30&amp;finish_hour=23&amp;finish_minute=30">
				<response-code value="200" />
				<regex
					pattern='"Imp MPAN Core","Exp MPAN Core","Site Code","Site Name","Account","From","To","","mop-net-gbp","mop-problem","","dc-net-gbp","dc-problem","","imp-supplier-net-gbp","imp-supplier-vat-gbp","imp-supplier-gross-gbp","imp-supplier-sum-msp-kwh","imp-supplier-problem"' />
				<regex
					pattern='"22 9974 3438 105","","CI005","Wheal Rodney","SA341665","2010-04-01 00:00","2010-04-13 23:30","","0","","","0","","","0.0","0.0","0.0","0",""' />
			</request>
		</test>
		<test name="NHH CSV import">
			<request path="/chellow/reports/287/output/" method="post">
				<control name="supplier_contract_id" value="63" />
				<control name="reference" value="07-002" />
				<control name="description" value="nhh csv batch" />
				<response-code value="303" />
			</request>

			<!-- Supplier contract 63 -->
			<request path="/chellow/reports/321/output/" method="post">
				<control name="supplier_batch_id" value="7" />
				<control type="file" name="import_file" value="bills-nhh.csv" />

				<response-code value="303" />
				<regex pattern="/reports/323/output/\?importer_id=5" />
			</request>

			<!-- Supplier contract 60, batch 7 -->
			<request path="/chellow/reports/323/output/?importer_id=5">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>

			<!-- Supplier contract 60, batch 7, bill 10 -->
			<request path="/chellow/reports/31/output/?supplier_read_id=7">
				<regex
					pattern='31&lt;/option&gt;\s*&lt;/select&gt;\s*&lt;select name="present_hour"&gt;\s*&lt;option value="0"&gt;00&lt;/option&gt;\s*&lt;option value="1"&gt;01&lt;/option&gt;\s*&lt;option value="2"&gt;02&lt;/option&gt;\s*&lt;option value="3"&gt;03&lt;/option&gt;\s*&lt;option value="4"&gt;04&lt;/option&gt;\s*&lt;option value="5"&gt;05&lt;/option&gt;\s*&lt;option value="6"&gt;06&lt;/option&gt;\s*&lt;option value="7"&gt;07&lt;/option&gt;\s*&lt;option value="8"&gt;08&lt;/option&gt;\s*&lt;option value="9"&gt;09&lt;/option&gt;\s*&lt;option value="10"&gt;10&lt;/option&gt;\s*&lt;option value="11"&gt;11&lt;/option&gt;\s*&lt;option value="12"&gt;12&lt;/option&gt;\s*&lt;option value="13"&gt;13&lt;/option&gt;\s*&lt;option value="14"&gt;14&lt;/option&gt;\s*&lt;option value="15"&gt;15&lt;/option&gt;\s*&lt;option value="16"&gt;16&lt;/option&gt;\s*&lt;option value="17"&gt;17&lt;/option&gt;\s*&lt;option value="18"&gt;18&lt;/option&gt;\s*&lt;option value="19"&gt;19&lt;/option&gt;\s*&lt;option value="20"&gt;20&lt;/option&gt;\s*&lt;option value="21"&gt;21&lt;/option&gt;\s*&lt;option value="22"&gt;22&lt;/option&gt;\s*&lt;option value="23" selected&gt;23&lt;/option&gt;\s*&lt;/select&gt;:&lt;select name="present_minute"&gt;\s*&lt;option value="0"&gt;00&lt;/option&gt;\s*&lt;option value="30" selected&gt;30&lt;/option&gt;\s*&lt;/select&gt;' />
				<regex
					pattern='&lt;input type="hidden" name="supplier_read_id" value="7"&gt;' />
			</request>
		</test>
		<test name="Test viewers' search">
			<request path="/chellow/reports/99/output/?search_pattern=">
				<regex
					pattern='&lt;td&gt;\s*&lt;a href="/chellow/reports/7/output/\?supply_id=9"&gt;supply&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;P96C93722&lt;/td&gt;' />
				<regex
					pattern='&lt;td&gt;\s*&lt;/td&gt;\s*&lt;td&gt;\s*&lt;/td&gt;\s*&lt;td&gt;\s*&lt;/td&gt;\s*&lt;td&gt;\s*00 845 581\s*22 0470 7514 535\s*&lt;/td&gt;' />
				<response-code value="200" />
			</request>

			<!-- Check that searching for an account with a space works -->
			<request path="/chellow/reports/99/output/?search_pattern=141%205532">
				<regex pattern='/chellow/reports/7/output/\?supply_id=6' />
				<response-code value="307" />
			</request>

			<!-- Check that searching on an MSN works -->
			<request path="/chellow/reports/99/output/?search_pattern=P96C93722">
				<regex pattern='/chellow/reports/7/output/\?supply_id=9' />
				<response-code value="307" />
			</request>
		</test>

		<test name="Check can view a supply.">
			<request path="/chellow/reports/7/output/?supply_id=2">
				<!-- Check there's a link to raw HH data -->
				<regex pattern="/reports/17/output/\?" />

				<!-- Check we can see the site -->
				<regex
					pattern='&lt;a href="/chellow/reports/5/output/\?site_id=1" title="Lower Treave"&gt;CI004&lt;/a&gt;' />

				<!-- Check a link to supplier bill is correct -->
				<regex
					pattern='&lt;a href="/chellow/reports/105/output/\?supplier_bill_id=11"&gt;View&lt;/a&gt;' />

				<!-- Check link to supply duration is correct -->
				<regex
					pattern='&lt;form action="/chellow/reports/149/output/"&gt;\s*&lt;fieldset&gt;\s*&lt;input type="hidden" name="supply_id"' />

				<regex
					pattern='&lt;td rowspan="4"&gt;\s*&lt;a href="/chellow/reports/55/output/\?pc_id=9" title="Half-hourly"&gt;00&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td rowspan="4"&gt;&lt;/td&gt;\s*&lt;td rowspan="4"&gt;\s*&lt;a href="/chellow/reports/63/output/\?mtc_id=529" title="HH COP5 And Above With Comms"&gt;845&lt;/a&gt;\s*&lt;/td&gt;' />

				<response-code value="200" />

			</request>
		</test>
		<test
			name="Check that if the end date of a era is altered, it can tell if there's a succeeding era.">
			<!-- Supply 10 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="10" />
				<control name="start_year" value="2005" />
				<control name="start_month" value="09" />
				<control name="start_day" value="06" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="true" />
				<control name="finish_year" value="2010" />
				<control name="finish_month" value="01" />
				<control name="finish_day" value="03" />
				<control name="finish_hour" value="23" />
				<control name="finish_minute" value="30" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 1065 3921 534" />
				<control name="hhdc_contract_id" value="54" />
				<control name="hhdc_account" value="dc-22 1065 3921 534" />
				<control name="msn" value="I02D89150" />
				<control name="pc_id" value="3" />
				<control name="mtc_code" value="801" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="0393" />
				<control name="imp_llfc_code" value="110" />
				<control name="imp_mpan_core" value="22 1065 3921 534" />
				<control name="imp_sc" value="30" />
				<control name="imp_supplier_contract_id" value="59" />
				<control name="imp_supplier_account" value="SA342376" />

				<response-code value="303" />
			</request>
		</test>
		<test
			name="Check that it works if a supply era is inserted by CSV before the beginning of a supply ">
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="era-insert.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=15" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=15">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>

			<!-- Supply 9 -->
			<request path="/chellow/reports/307/output/?era_id=20">
				<!-- Check the import supplier account is there -->
				<regex pattern="341664" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check that the general import of register reads works.">
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="bills-general.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=16" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=16">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/105/output/?supplier_bill_id=14">
				<refresh />

				<!-- Check it's loaded ok -->
				<regex
					pattern='&lt;td&gt;\s*&lt;a href="/chellow/reports/111/output/\?bill_id=14"&gt;Check&lt;/a&gt;\s*&lt;/td&gt;' />
				<regex
					pattern='&lt;td&gt;38992&lt;/td&gt;\s*&lt;td&gt;\s*&lt;a title="Estimated"\s*href="/chellow/reports/143/output/\?type-id=4"&gt;E&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;2007-01-17 00:00&lt;/td&gt;\s*&lt;td&gt;39000\s*&lt;/td&gt;\s*&lt;td&gt;\s*&lt;a title="Estimated"\s*href="/chellow/reports/143/output/\?type-id=4"&gt;E&lt;/a&gt;\s*&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check the 'update bill' page.">
			<request path="/chellow/reports/165/output/?supplier_bill_id=10">
				<response-code value="200" />
				<regex pattern="type_id" />
				<regex pattern='&lt;option value="2" selected&gt;N Normal&lt;/option&gt;' />
				<regex pattern='name="account" value="SA342376000"' />
			</request>
		</test>
		<test name="Check the batch page.">
			<request path="/chellow/reports/91/output/?supplier_batch_id=5">
				<response-code value="200" />
				<regex
					pattern="&lt;td&gt;2010-01-19 00:00&lt;/td&gt;\s*&lt;td&gt;2010-04-20 23:30&lt;/td&gt;" />
			</request>
		</test>
		<test name="Test supply era update for a supply with 2 mpans.">
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="era-update-2-mpans.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=17" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=17">
				<refresh />
				<!-- Check it's loaded ok -->
				<regex pattern="The file has been imported successfully" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Add batch to HHDC contract">
			<!-- Insert a new batch -->
			<request path="/chellow/reports/281/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control name="reference" value="001-7t" />
				<control name="description" value="hhdc batch" />
				<response-code value="303" />
				<regex pattern="/reports/203/output/\?hhdc_batch_id=8" />
			</request>

			<!-- Check that it's there to edit. HHDC contract 53 -->
			<request path="/chellow/reports/283/output/?hhdc_batch_id=8">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try adding bills to the HHDC batch">
			<!-- Contract 52 -->
			<request path="/chellow/reports/327/output/?hhdc_batch_id=8"
				method="post">
				<control name="hhdc_batch_id" value="8" />
				<control type="file" name="import_file" value="hhdc-bill.csv" />
				<response-code value="303" />
				<regex pattern="/reports/329/output/\?importer_id=6" />
			</request>

			<!-- Contract 52 batch 8 -->
			<request path="/chellow/reports/329/output/?importer_id=6">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>
		<test name="Add batch to MOP contract">
			<!-- Insert a new batch. -->
			<request path="/chellow/reports/353/output/" method="post">
				<control name="mop_contract_id" value="57" />
				<control name="reference" value="99/992" />
				<control name="description" value="mop batch" />
				<response-code value="303" />
				<regex pattern="/reports/193/output/\?mop_batch_id=9" />
			</request>

			<!-- Check that it's there in edit mode. Contract 57 -->
			<request path="/chellow/reports/355/output/?mop_batch_id=9">
				<response-code value="200" />

				<regex pattern='&lt;input type="hidden" name="mop_batch_id" value="9"&gt;' />
			</request>

			<!-- Check confirm-delete page. Contract 57 -->
			<request
				path="/chellow/reports/355/output/?mop_batch_id=9&amp;confirm_delete=Delete">
				<response-code value="200" />

				<regex pattern='&lt;input type="hidden" name="mop_batch_id" value="9"&gt;' />
			</request>


			<!-- Check we can see it in 'view' mode. Contract 55 -->
			<request path="/chellow/reports/193/output/?mop_batch_id=9">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try adding bills to the MOP batch">
			<!-- Mop contract 54 -->
			<request path="/chellow/reports/331/output/" method="post">
				<control name="mop_batch_id" value="9" />
				<control type="file" name="import_file" value="mop-bill.csv" />
				<response-code value="303" />
				<regex pattern="/reports/333/output/\?importer_id=7" />
			</request>

			<!-- Mop contract 54, batch 9 -->
			<request path="/chellow/reports/333/output/?importer_id=7">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>
		<test
			name="If a new supply has a blank LLFC field, check it gives a good error message.">
			<request path="/chellow/reports/311/output/" method="post">
				<control name="site_id" value="7" />
				<control name="source_id" value="1" />
				<control name="name" value="Supply 54" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="05" />
				<control name="start_day" value="26" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="msn" value="" />
				<control name="gsp_group_id" value="3" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 9879 0084 358" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="dc-22 9879 0084 358" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="imp_mpan_core" value="22 9879 0084 358" />
				<control name="imp_llfc_code" value="" />
				<control name="imp_sc" value="700" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="d" />

				<control name="insert" value="Insert" />

				<regex
					pattern="There is no LLFC with the code &amp;#39;&amp;#39; associated with the DNO 22\." />
				<response-code value="400" />
			</request>
		</test>
		<test
			name="If a new supply has a blank import sc field, check it gives a good error message.">
			<request path="/chellow/reports/311/output/" method="post">
				<control name="site_id" value="7" />
				<control name="source_id" value="1" />
				<control name="name" value="Supply 54" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="05" />
				<control name="start_day" value="26" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="msn" value="" />
				<control name="gsp_group_id" value="3" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 9879 0084 358" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="dc-22 9879 0084 358" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="imp_mpan_core" value="22 9879 0084 358" />
				<control name="imp_llfc_code" value="570" />
				<control name="imp_sc" value="" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="d" />

				<control name="insert" value="Insert" />

				<regex
					pattern="Problem parsing the field imp_sc as an integer: invalid literal for int\(\) with base 10: " />
				<response-code value="400" />
			</request>
		</test>
		<test
			name="If a new supply has a blank MTC code field, check it gives a good error message.">
			<request path="/chellow/reports/311/output/" method="post">
				<control name="site_id" value="7" />
				<control name="source_id" value="1" />
				<control name="name" value="Supply 54" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="05" />
				<control name="start_day" value="26" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="msn" value="" />
				<control name="gsp_group_id" value="3" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 9879 0084 358" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="dc-22 9879 0084 358" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="imp_mpan_core" value="22 9879 0084 358" />
				<control name="imp_llfc_code" value="570" />
				<control name="imp_sc" value="700" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="d" />

				<control name="insert" value="Insert" />

				<regex pattern="The MTC code must be a whole number\." />
				<response-code value="400" />
			</request>
		</test>
		<test name="Try view page of meter payment types.">
			<request path="/chellow/reports/133/output/">
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Try a monthly sites duration for a site with a 3rd party supply.">
			<request path="/chellow/reports/311/output/" method="post">
				<control name="site_id" value="4" />
				<control name="source_id" value="5" />
				<control name="name" value="3" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="05" />
				<control name="start_day" value="26" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="msn" value="" />
				<control name="gsp_group_id" value="3" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 9789 0534 938" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="dc-22 9789 0534 938" />
				<control name="pc_id" value="3" />
				<control name="mtc_code" value="801" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="393" />
				<control name="imp_mpan_core" value="22 9789 0534 938" />
				<control name="imp_llfc_code" value="110" />
				<control name="imp_sc" value="0" />
				<control name="imp_supplier_contract_id" value="63" />
				<control name="imp_supplier_account" value="taa2" />
				<control name="insert" value="Insert" />

				<regex pattern="/chellow/reports/7/output/\?supply_id=16" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/161/output/?site_id=4&amp;months=1&amp;finish_year=2010&amp;finish_month=07">
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/251/output/">
				<refresh max="20" />
				<regex pattern="FINISHED_site_monthly_duration_for_CI017_1_to_2010_7.csv" />
				<response-code value="200" />
			</request>
			<request
				path="/chellow/reports/253/output/?name=FINISHED_site_monthly_duration_for_CI017_1_to_2010_7.csv">
				<regex
					pattern='"CI017","Roselands","","3rd-party,net","","2010-07-31 23:30","0","0","0","0","0","0","0","0","1593.3414","0","0","1593.3414","0.0","0","0","hh",""' />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Try creating and deleting a rate script for a non-core contract (templater).">
			<request path="/chellow/reports/275/output/" method="post">
				<control name="non_core_contract_id" value="31" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="04" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert" value="Insert" />

				<regex pattern="/chellow/reports/271/output/\?rate_script_id=318" />
				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/273/output/?rate_script_id=318&amp;delete=Delete">
				<regex pattern="Are you sure you want to delete this rate script\?" />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/273/output/" method="post">
				<control name="rate_script_id" value="318" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/271/output/?rate_script_id=318">
				<response-code value="404" />
			</request>
		</test>
		<test name="Try adding a rate script before other rate scripts.">
			<request path="/chellow/reports/275/output/" method="post">
				<control name="non_core_contract_id" value="31" /> <!-- Templater -->
				<control name="start_year" value="1999" />
				<control name="start_month" value="04" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert" value="Insert" />

				<regex pattern="/chellow/reports/271/output/\?rate_script_id=319" />
				<response-code value="303" />
			</request>

			<request path="/chellow/reports/273/output/?rate_script_id=319">
				<regex
					pattern='&lt;input name="finish_year" maxlength="4" size="4" value="2010"&gt;' />

				<!-- Check that the start hour of a non-core rate script is correct." -->
				<regex
					pattern='&lt;select name="start_hour"&gt;\s*&lt;option value="0" selected&gt;00&lt;/option&gt;' />
				<response-code value="200" />
			</request>

			<request path="/chellow/reports/273/output/" method="post">
				<control name="rate_script_id" value="319" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Adding a bill manually.">
			<!-- Supplier contract 54 -->
			<request path="/chellow/reports/313/output/" method="post">
				<control name="supplier_batch_id" value="6" />
				<control name="mpan_core" value="22 9813 2107 763" />
				<control name="reference" value="KUH774" />
				<control name="issue_year" value="2010" />
				<control name="issue_month" value="12" />
				<control name="issue_day" value="06" />
				<control name="issue_hour" value="00" />
				<control name="issue_minute" value="00" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="12" />
				<control name="start_day" value="06" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="finish_year" value="2010" />
				<control name="finish_month" value="12" />
				<control name="finish_day" value="06" />
				<control name="finish_hour" value="00" />
				<control name="finish_minute" value="00" />
				<control name="kwh" value="0" />
				<control name="net" value="0" />
				<control name="vat" value="0" />
				<control name="gross" value="0" />
				<control name="account" value="02" />
				<control name="bill_type_id" value="1" />
				<control name="breakdown" value="{}" />

				<regex pattern="/chellow/reports/105/output/\?supplier_bill_id=18" />
				<response-code value="303" />
			</request>

			<!-- Supplier contract 52, batch 6 -->
			<request path="/chellow/reports/165/output/?supplier_bill_id=18">
				<regex
					pattern='&lt;select name="start_day"&gt;\s*&lt;option value="1"&gt;01&lt;/option&gt;\s*&lt;option value="2"&gt;02&lt;/option&gt;\s*&lt;option value="3"&gt;03&lt;/option&gt;\s*&lt;option value="4"&gt;04&lt;/option&gt;\s*&lt;option value="5"&gt;05&lt;/option&gt;\s*&lt;option value="6" selected&gt;06&lt;/option&gt;\s*&lt;option value="7"&gt;07&lt;/option&gt;\s*&lt;option value="8"&gt;08&lt;/option&gt;\s*&lt;option value="9"&gt;09&lt;/option&gt;\s*&lt;option value="10"&gt;10&lt;/option&gt;\s*&lt;option value="11"&gt;11&lt;/option&gt;\s*&lt;option value="12"&gt;12&lt;/option&gt;\s*&lt;option value="13"&gt;13&lt;/option&gt;\s*&lt;option value="14"&gt;14&lt;/option&gt;\s*&lt;option value="15"&gt;15&lt;/option&gt;\s*&lt;option value="16"&gt;16&lt;/option&gt;\s*&lt;option value="17"&gt;17&lt;/option&gt;\s*&lt;option value="18"&gt;18&lt;/option&gt;\s*&lt;option value="19"&gt;19&lt;/option&gt;\s*&lt;option value="20"&gt;20&lt;/option&gt;\s*&lt;option value="21"&gt;21&lt;/option&gt;\s*&lt;option value="22"&gt;22&lt;/option&gt;\s*&lt;option value="23"&gt;23&lt;/option&gt;\s*&lt;option value="24"&gt;24&lt;/option&gt;\s*&lt;option value="25"&gt;25&lt;/option&gt;\s*&lt;option value="26"&gt;26&lt;/option&gt;\s*&lt;option value="27"&gt;27&lt;/option&gt;\s*&lt;option value="28"&gt;28&lt;/option&gt;\s*&lt;option value="29"&gt;29&lt;/option&gt;\s*&lt;option value="30"&gt;30&lt;/option&gt;\s*&lt;option value="31"&gt;31&lt;/option&gt;\s*&lt;/select&gt;\s*&lt;select name="start_hour"&gt;\s*&lt;option value="0" selected&gt;00&lt;/option&gt;\s*&lt;option value="1"&gt;01&lt;/option&gt;\s*&lt;option value="2"&gt;02&lt;/option&gt;\s*&lt;option value="3"&gt;03&lt;/option&gt;\s*&lt;option value="4"&gt;04&lt;/option&gt;\s*&lt;option value="5"&gt;05&lt;/option&gt;\s*&lt;option value="6"&gt;06&lt;/option&gt;\s*&lt;option value="7"&gt;07&lt;/option&gt;\s*&lt;option value="8"&gt;08&lt;/option&gt;\s*&lt;option value="9"&gt;09&lt;/option&gt;\s*&lt;option value="10"&gt;10&lt;/option&gt;\s*&lt;option value="11"&gt;11&lt;/option&gt;\s*&lt;option value="12"&gt;12&lt;/option&gt;\s*&lt;option value="13"&gt;13&lt;/option&gt;\s*&lt;option value="14"&gt;14&lt;/option&gt;\s*&lt;option value="15"&gt;15&lt;/option&gt;\s*&lt;option value="16"&gt;16&lt;/option&gt;\s*&lt;option value="17"&gt;17&lt;/option&gt;\s*&lt;option value="18"&gt;18&lt;/option&gt;\s*&lt;option value="19"&gt;19&lt;/option&gt;\s*&lt;option value="20"&gt;20&lt;/option&gt;\s*&lt;option value="21"&gt;21&lt;/option&gt;\s*&lt;option value="22"&gt;22&lt;/option&gt;\s*&lt;option value="23"&gt;23&lt;/option&gt;\s*&lt;/select&gt;:&lt;select name="start_minute"&gt;\s*&lt;option value="0" selected&gt;00&lt;/option&gt;\s*&lt;option value="30"&gt;30&lt;/option&gt;\s*&lt;/select&gt;' />
				<regex
					pattern='&lt;select name="finish_day"&gt;\s*&lt;option value="1"&gt;01&lt;/option&gt;\s*&lt;option value="2"&gt;02&lt;/option&gt;\s*&lt;option value="3"&gt;03&lt;/option&gt;\s*&lt;option value="4"&gt;04&lt;/option&gt;\s*&lt;option value="5"&gt;05&lt;/option&gt;\s*&lt;option value="6" selected&gt;06&lt;/option&gt;\s*&lt;option value="7"&gt;07&lt;/option&gt;\s*&lt;option value="8"&gt;08&lt;/option&gt;\s*&lt;option value="9"&gt;09&lt;/option&gt;\s*&lt;option value="10"&gt;10&lt;/option&gt;\s*&lt;option value="11"&gt;11&lt;/option&gt;\s*&lt;option value="12"&gt;12&lt;/option&gt;\s*&lt;option value="13"&gt;13&lt;/option&gt;\s*&lt;option value="14"&gt;14&lt;/option&gt;\s*&lt;option value="15"&gt;15&lt;/option&gt;\s*&lt;option value="16"&gt;16&lt;/option&gt;\s*&lt;option value="17"&gt;17&lt;/option&gt;\s*&lt;option value="18"&gt;18&lt;/option&gt;\s*&lt;option value="19"&gt;19&lt;/option&gt;\s*&lt;option value="20"&gt;20&lt;/option&gt;\s*&lt;option value="21"&gt;21&lt;/option&gt;\s*&lt;option value="22"&gt;22&lt;/option&gt;\s*&lt;option value="23"&gt;23&lt;/option&gt;\s*&lt;option value="24"&gt;24&lt;/option&gt;\s*&lt;option value="25"&gt;25&lt;/option&gt;\s*&lt;option value="26"&gt;26&lt;/option&gt;\s*&lt;option value="27"&gt;27&lt;/option&gt;\s*&lt;option value="28"&gt;28&lt;/option&gt;\s*&lt;option value="29"&gt;29&lt;/option&gt;\s*&lt;option value="30"&gt;30&lt;/option&gt;\s*&lt;option value="31"&gt;31&lt;/option&gt;\s*&lt;/select&gt;\s*&lt;select name="finish_hour"&gt;\s*&lt;option value="0" selected&gt;00&lt;/option&gt;\s*&lt;option value="1"&gt;01&lt;/option&gt;\s*&lt;option value="2"&gt;02&lt;/option&gt;\s*&lt;option value="3"&gt;03&lt;/option&gt;\s*&lt;option value="4"&gt;04&lt;/option&gt;\s*&lt;option value="5"&gt;05&lt;/option&gt;\s*&lt;option value="6"&gt;06&lt;/option&gt;\s*&lt;option value="7"&gt;07&lt;/option&gt;\s*&lt;option value="8"&gt;08&lt;/option&gt;\s*&lt;option value="9"&gt;09&lt;/option&gt;\s*&lt;option value="10"&gt;10&lt;/option&gt;\s*&lt;option value="11"&gt;11&lt;/option&gt;\s*&lt;option value="12"&gt;12&lt;/option&gt;\s*&lt;option value="13"&gt;13&lt;/option&gt;\s*&lt;option value="14"&gt;14&lt;/option&gt;\s*&lt;option value="15"&gt;15&lt;/option&gt;\s*&lt;option value="16"&gt;16&lt;/option&gt;\s*&lt;option value="17"&gt;17&lt;/option&gt;\s*&lt;option value="18"&gt;18&lt;/option&gt;\s*&lt;option value="19"&gt;19&lt;/option&gt;\s*&lt;option value="20"&gt;20&lt;/option&gt;\s*&lt;option value="21"&gt;21&lt;/option&gt;\s*&lt;option value="22"&gt;22&lt;/option&gt;\s*&lt;option value="23"&gt;23&lt;/option&gt;\s*&lt;/select&gt;:&lt;select name="finish_minute"&gt;\s*&lt;option value="0" selected&gt;00&lt;/option&gt;\s*&lt;option value="30"&gt;30&lt;/option&gt;\s*&lt;/select&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Check that bill with two sets of register reads gets displayed correctly.">
			<request path="/chellow/reports/7/output/?supply_id=10">

				<regex
					pattern='&lt;td rowspan="2"&gt;\s*&lt;a href="/chellow/reports/201/output/\?bill_type_id=2" title="Normal"&gt;N&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td style="border-right: none;"&gt;\s*&lt;a title="2011-02-04 23:30 I02D89150"&gt;34285&lt;/a&gt;\s*&lt;/td&gt;' />

				<regex
					pattern='25927&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td style="border-left: none; text-align: right;"&gt;\s*E\s*&lt;/td&gt;\s*&lt;td&gt;\s*&lt;/td&gt;\s*&lt;td style="border-right: none;"&gt;\s*&lt;/td&gt;\s*&lt;td style="border-left: none; text-align: right;"&gt;\s*&lt;/td&gt;\s*&lt;td style="border-right: none;"&gt;\s*&lt;/td&gt;\s*&lt;td style="border-left: none; text-align: right;"&gt;\s*&lt;/td&gt;\s*&lt;/tr&gt;' />

				<!-- Check form action for virtual bills is correct -->
				<regex pattern='&lt;form action="/chellow/reports/291/output/"&gt;' />

				<!-- Check link to TPR from outer read -->
				<regex
					pattern='&lt;td&gt;\s*&lt;a href="/chellow/reports/97/output/\?tpr_id=2"&gt;00003&lt;/a&gt;\s*&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Deleting a batch with bills with register reads.">
			<!-- Supplier contract 61 -->
			<request path="/chellow/reports/289/output/" method="post">
				<control name="supplier_batch_id" value="5" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Check 'insert supplier batch' page.">
			<request path="/chellow/reports/287/output/?supplier_contract_id=63">
				<regex pattern='="description"' />
			</request>
		</test>
		<test name="Viewing the insert batch page of a DC contract.">
			<request path="/chellow/reports/281/output/?hhdc_contract_id=53">
				<regex pattern='="description"' />
			</request>
		</test>
		<test name="Viewing a batch in view mode, when it has a custom report.">
			<request path="/chellow/reports/269/output/" method="post">
				<control name="non_core_contract_id" value="13"/>
				<control name="name" value="configuration"/>
				<control name="charge_script" value=""/>
				<control name="properties"><![CDATA[
{
    'ips': {'127.0.0.1': 'implicit-user@localhost'},
    'site_links': [
		    {'name': 'Google Maps', 'href': 'https://maps.google.com/maps?q='}],
		'batch_reports': [2]}]]></control>

				<response-code value="303" />
			</request>

			<!-- Check that we can see batch okay. Contract 56 -->
			<request path="/chellow/reports/193/output/?mop_batch_id=9">
				<regex pattern='/reports/2/output/' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check 'no channel' error when importing hh data.">
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh-no-channel.simple.csv" />
				<response-code value="303" />
				<regex pattern="/reports/65/output/\?hhdc_contract_id=53&amp;process_id=13" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=13">
				<refresh />
				<regex
					pattern="There is no channel for the datum: \{&amp;#39;channel_type&amp;#39;: &amp;#39;REACTIVE_EXP&amp;#39;, &amp;#39;mpan_core&amp;#39;: &amp;#39;22 4862 4512 332&amp;#39;, &amp;#39;start_date&amp;#39;: datetime.datetime\(2010, 2, 4, 20, 0, tzinfo=&amp;lt;UTC&amp;gt;\), &amp;#39;status&amp;#39;: &amp;#39;A&amp;#39;, &amp;#39;value&amp;#39;: Decimal\(&amp;#3\d;30.4339&amp;#3\d;\)\}\." />

				<response-code value="200" />
			</request>
		</test>
		<test name="Check the bill import page.">
			<request path="/chellow/reports/211/output/?hhdc_contract_id=53">
				<response-code value="200" />
				<regex pattern="/reports/115/output/\?hhdc_contract_id=53" />
			</request>
		</test>
		<test
			name="Check good error message if new era has same start date as existing era.">
			<!-- Can we add a new era ok? -->
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="10" />
				<control name="start_year" value="2005" />
				<control name="start_month" value="09" />
				<control name="start_day" value="06" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="Insert" />

				<regex pattern="There&amp;#39;s already an era with that start date\." />
				<response-code value="400" />
			</request>
		</test>
		<test name="Check MOP and DC bills are displaying correctly">
			<request path="/chellow/reports/7/output/?supply_id=5">
				<regex
					pattern='&lt;td&gt;\s*&lt;a href="/chellow/reports/203/output/\?hhdc_batch_id=8"&gt;001-7t&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;00031&lt;/td&gt;\s*&lt;td&gt;22 0883 6932 301&lt;/td&gt;\s*&lt;td&gt;2007-09-01 00:00&lt;/td&gt;' />
				<regex
					pattern='&lt;td&gt;\s*&lt;a href="/chellow/reports/193/output/\?mop_batch_id=9"&gt;99/992&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;06&lt;/td&gt;\s*&lt;td&gt;22 0883 6932 301&lt;/td&gt;' />

				<!-- Check that MOP bill before supply start is displayed -->
				<regex
					pattern='&lt;td&gt;\s*&lt;a href="/chellow/reports/193/output/\?mop_batch_id=9"&gt;99/992&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;08&lt;/td&gt;\s*&lt;td&gt;22 0883 6932 301&lt;/td&gt;' />

				<!-- Check that channel type is displayed -->
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/301/output/\?channel_id=16"&gt;ACTIVE&lt;/a&gt;\s*&lt;a href="/chellow/reports/301/output/\?channel_id=17"&gt;REACTIVE_IMP&lt;/a&gt;\s*&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="View the note editing page.">
			<request path="/chellow/reports/239/output/?supply_id=2">
				<response-code value="200" />
			</request>
		</test>
		<test name="Try editing a note.">
			<request path="/chellow/reports/239/output/" method="post">
				<control name="supply_id" value="2" />
				<control name="is_important" value="True" />
				<control name="category" value="general" />
				<control name="body"><![CDATA[Some people, when confronted with a problem, think I know,
				I'll use regular expressions. Now they have two problems.]]></control>
				<response-code value="303" />
			</request>
		</test>
		<test name="Try importing HH data from FTP server.">
			<!-- Update Contract -->
			<request path="/chellow/reports/279/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control name="party_id" value="104" /> <!-- DASL -->
				<control name="name" value="HH contract" />
				<control name="charge_script"><![CDATA[
def virtual_bill_titles():
    return ['net-gbp', 'problem']

def virtual_bill(supply_source):
    supply_source.dc_bill['net-gbp'] = 0]]></control>
				<control name="properties"><![CDATA[
{'has_importer': True,
'file_type': '.df2',
'hostname': 'localhost',
'username': 'chellow',
'password': 'HixaNfUBOf*u',
'directories': ['.']}]]></control>
				<response-code value="303" />
			</request>

			<!-- Do an 'import now' -->
			<request path="/chellow/reports/213/output/" method="post">
				<control name="hhdc_contract_id" value="53" />

				<response-code value="303" />
			</request>

			<request path="/chellow/reports/213/output/?hhdc_contract_id=53">
				<refresh />
				<regex pattern="File downloaded successfully\." />
				
			</request>

			<request path="/chellow/reports/115/output/?hhdc_contract_id=53">
				<regex pattern="hh_data\.df2" />
			</request>


		</test>
		<test name="Try startup and shutdown.">
			<request path="/chellow/reports/171/output/" method="post">
				<refresh />
				<control name="run_shutdown" value="Shutdown" />
				<regex pattern="Shut down successfully." />
			</request>
			<request path="/chellow/reports/171/output/" method="post">
				<control name="run_startup" value="Run" />
			</request>
		</test>
		<test name="Check that later bills are at the top.">
			<request path="/chellow/reports/7/output/?supply_id=1">
				<regex pattern="supplier_bill_id=7.*supplier_bill_id=1" />
				<regex pattern="2007-02-28 23:30"/>
				<response-code value="200" />
			</request>
		</test>

		<test name="Check that CRC report works for an AMR with no data.">
			<!-- Change generation to NHH. Supply 7 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="7" />
				<control name="msn" value="" />
				<control name="start_year" value="2003" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="pc_id" value="4" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="393" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 6354 2983 570" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="01" />
				<control name="imp_llfc_code" value="210" />
				<control name="imp_mpan_core" value="22 4862 4512 332" />
				<control name="imp_sc" value="230" />
				<control name="imp_supplier_contract_id" value="59" />
				<control name="imp_supplier_account" value="141 5532" />

				<response-code value="303" />
			</request>
			<!-- Run CRC report for month without data -->
			<request path="/chellow/reports/207/output/?supply_id=7&amp;year=2012">
				<regex pattern='"7","22 4862 4512 332"' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Test monthly supplies duration for an unmetered supply.">
			<!-- Supply 9 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="20" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="10" />
				<control name="start_day" value="11" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 0195 4836 192" />
				<control name="hhdc_contract_id" value="54" />
				<control name="hhdc_account" value="dc-22 0195 4836 192" />
				<control name="msn" value="P96C93722" />
				<control name="pc_id" value="8" />
				<control name="mtc_code" value="857" />
				<control name="cop_id" value="8" />
				<control name="ssc_code" value="0428" />
				<control name="imp_llfc_code" value="980" />
				<control name="imp_mpan_core" value="22 0195 4836 192" />
				<control name="imp_sc" value="304" />
				<control name="imp_supplier_contract_id" value="59" />
				<control name="imp_supplier_account" value="SA342376" />

				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/291/output/?supply_id=9&amp;start_year=2011&amp;start_month=05&amp;start_day=01&amp;start_hour=00&amp;start_minute=0&amp;finish_year=2011&amp;finish_month=05&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<regex
					pattern='"Imp MPAN Core","Exp MPAN Core","Site Code","Site Name","Account","From","To","","mop-net-gbp","mop-problem","","dc-net-gbp","dc-problem","","imp-supplier-net-gbp","imp-supplier-vat-gbp","imp-supplier-gross-gbp","imp-supplier-sum-msp-kwh","imp-supplier-problem"' />
				<regex
					pattern='"22 0195 4836 192","","CI004","Lower Treave","SA342376","2011-05-01 00:00","2011-05-31 23:30","","0","","","0","","","0.0","0.0","0.0","25.8191780822",""' />
				<response-code value="200" />
			</request>
		</test>
		<test>
			<request path="/chellow/reports/45/output/">
				<regex
					pattern='&lt;a href="/chellow/reports/73/output/\?participant_id=331"&gt;SWEB&lt;/a&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check rounding in bills is correct.">
			<request path="/chellow/reports/7/output/?supply_id=5">

				<!-- Check bill net and vat are shown correctly -->
				<regex pattern='&lt;td&gt;195.60&lt;/td&gt;\s*&lt;td&gt;36.03&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Test the right number of rows returned for a search on '22'.">
			<request
				path="/chellow/reports/99/output/?search_pattern=22&amp;max_results=12">
				<regex pattern='&lt;tbody&gt;\s*(&lt;tr&gt;.*?){11}\s*&lt;/tbody&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try monthly supply duration with a non-half-hourly with bills.">
			<request
				path="/chellow/reports/177/output/?supply_id=10&amp;months=1&amp;end_year=2011&amp;end_month=01">
				<regex
					pattern="supply-id,supply-name,source-code,generator-type,month,pc-code,msn,site-code,site-name,metering-type,import-mpan-core,metered-import-kwh,metered-import-net-gbp,metered-import-estimated-kwh,billed-import-kwh,billed-import-net-gbp,export-mpan-core,metered-export-kwh,metered-export-estimated-kwh,billed-export-kwh,billed-export-net-gbp,problem,timestamp" />
				<regex
					pattern='10,"2","net","","2011-01-31 23:30","03","I02D89150","CI017","Roselands","nhh","22 1065 3921 534","0","0.0","0","150.0","98.17","None","0","0","0","0",""' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try monthly supply duration with a half-hourly.">
			<request
				path="/chellow/reports/177/output/?supply_id=4&amp;months=1&amp;end_year=2010&amp;end_month=05">
				<regex
					pattern="supply-id,supply-name,source-code,generator-type,month,pc-code,msn,site-code,site-name,metering-type,import-mpan-core,metered-import-kwh,metered-import-net-gbp,metered-import-estimated-kwh,billed-import-kwh,billed-import-net-gbp,export-mpan-core,metered-export-kwh,metered-export-estimated-kwh,billed-export-kwh,billed-export-net-gbp,problem,timestamp" />
				<regex
					pattern='4,"1","net","","2010-05-31 23:30","00","","CI005","Wheal Rodney","hh","22 6158 2968 220","0","179.2268","0","0","0","22 3479 7618 470","0","0","0","0",""' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check supplies monthly duration page.">
			<request path="/chellow/reports/155/output/">
				<regex pattern="end_month" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check CSV Sites Duration">
			<request path="/chellow/reports/57/output/">
				<!-- Should have link to CSS -->
				<regex pattern="/reports/19/output/" />
				<response-code value="200" />
			</request>
			<request path="/chellow/reports/59/output/?start_year=2013&amp;start_month=04&amp;start_day=01&amp;start_hour=00&amp;start_minute=00&amp;finish_year=2013&amp;finish_month=04&amp;finish_day=1&amp;finish_hour=23&amp;finish_minute=30">
				<regex pattern='"CH017","Parbola","","sub","","2013-04-01 00:00","2013-04-01 23:30","0","0","0","0","0","0","hh"' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check CSV Sites HH Data Selector.">
			<request path="/chellow/reports/145/output/">
				<!-- Should have link to CSS -->
				<regex pattern="/reports/19/output/" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Check CSV Supplies HH Data.">
			<request
				path="/chellow/reports/169/output/?supply_id=1&amp;imp_related=true&amp;channel_type=ACTIVE&amp;start_year=2008&amp;start_month=7&amp;start_day=1&amp;start_hour=0&amp;start_minute=0&amp;finish_year=2008&amp;finish_month=07&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<!-- Check the HH data is there -->
				<regex pattern="NA,2008-07-06,0\.262" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Test duos-fixed">
			<!-- Add a new era with this contract -->
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="5" />
				<control name="start_year" value="2013" />
				<control name="start_month" value="01" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="Insert" />

				<regex pattern="/reports/7/output/\?supply_id=5" />
				<response-code value="303" />
			</request>

			<!-- Supply 5 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="23" />
				<control name="start_year" value="2013" />
				<control name="start_month" value="01" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="gsp_group_id" value="11" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="22 0883 6932 301" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="22 0883 6932 301" />
				<control name="msn" value="" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="imp_llfc_code" value="570" />
				<control name="imp_mpan_core" value="22 0883 6932 301" />
				<control name="imp_sc" value="350" />
				<control name="imp_supplier_contract_id" value="58" />
				<control name="imp_supplier_account" value="4341" />

				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/291/output/?supply_id=5&amp;start_year=2013&amp;start_month=04&amp;start_day=01&amp;start_hour=00&amp;start_minute=00&amp;finish_year=2013&amp;finish_month=04&amp;finish_day=30&amp;finish_hour=23&amp;finish_minute=30">
				<response-code value="200" />
				<regex
					pattern='"Imp MPAN Core","Exp MPAN Core","Site Code","Site Name","Account","From","To","","mop-net-gbp","mop-problem","","dc-net-gbp","dc-problem","","imp-supplier-net-gbp","imp-supplier-tlm","imp-supplier-ccl-kwh","imp-supplier-ccl-rate","imp-supplier-ccl-gbp","imp-supplier-data-collection-gbp","imp-supplier-duos-availability-kva","imp-supplier-duos-availability-days","imp-supplier-duos-availability-rate","imp-supplier-duos-availability-gbp","imp-supplier-duos-excess-availability-kva","imp-supplier-duos-excess-availability-days","imp-supplier-duos-excess-availability-rate","imp-supplier-duos-excess-availability-gbp","imp-supplier-duos-green-kwh","imp-supplier-duos-green-rate","imp-supplier-duos-green-gbp","imp-supplier-duos-green-kwh","imp-supplier-duos-green-rate","imp-supplier-duos-amber-gbp","imp-supplier-duos-amber-kwh","imp-supplier-duos-red-rate","imp-supplier-duos-red-gbp","imp-supplier-duos-reactive-rate","imp-supplier-duos-reactive-gbp","imp-supplier-duos-fixed-days","imp-supplier-duos-fixed-rate","imp-supplier-duos-fixed-gbp","imp-supplier-settlement-gbp","imp-supplier-night-msp-kwh","imp-supplier-night-gsp-kwh","imp-supplier-night-gbp","imp-supplier-other-msp-kwh","imp-supplier-other-gsp-kwh","imp-supplier-other-gbp","imp-supplier-summer-pk-msp-kwh","imp-supplier-summer-pk-gsp-kwh","imp-supplier-summer-pk-gbp","imp-supplier-winter-low-pk-msp-kwh","imp-supplier-winter-low-pk-gsp-kwh","imp-supplier-winter-low-pk-gbp","imp-supplier-winter-off-pk-msp-kwh","imp-supplier-winter-off-pk-gsp-kwh","imp-supplier-winter-off-pk-gbp","imp-supplier-winter-pk-msp-kwh","imp-supplier-winter-pk-gsp-kwh","imp-supplier-winter-pk-gbp","imp-supplier-bsuos-kwh","imp-supplier-bsuos-rate","imp-supplier-bsuos-gbp","imp-supplier-triad-actual-1-date","imp-supplier-triad-actual-1-msp-kw","imp-supplier-triad-actual-1-status","imp-supplier-triad-actual-1-laf","imp-supplier-triad-actual-1-gsp-kw","imp-supplier-triad-actual-2-date","imp-supplier-triad-actual-2-msp-kw","imp-supplier-triad-actual-2-status","imp-supplier-triad-actual-2-laf","imp-supplier-triad-actual-2-gsp-kw","imp-supplier-triad-actual-3-date","imp-supplier-triad-actual-3-msp-kw","imp-supplier-triad-actual-3-status","imp-supplier-triad-actual-3-laf","imp-supplier-triad-actual-3-gsp-kw","imp-supplier-triad-actual-gsp-kw","imp-supplier-triad-actual-rate","imp-supplier-triad-actual-gbp","imp-supplier-triad-estimate-1-date","imp-supplier-triad-estimate-1-msp-kw","imp-supplier-triad-estimate-1-status","imp-supplier-triad-estimate-1-laf","imp-supplier-triad-estimate-1-gsp-kw","imp-supplier-triad-estimate-2-date","imp-supplier-triad-estimate-2-msp-kw","imp-supplier-triad-estimate-2-status","imp-supplier-triad-estimate-2-laf","imp-supplier-triad-estimate-2-gsp-kw","imp-supplier-triad-estimate-3-date","imp-supplier-triad-estimate-3-msp-kw","imp-supplier-triad-estimate-3-status","imp-supplier-triad-estimate-3-laf","imp-supplier-triad-estimate-3-gsp-kw","imp-supplier-triad-estimate-gsp-kw","imp-supplier-triad-estimate-rate","imp-supplier-triad-estimate-months","imp-supplier-triad-estimate-gbp","imp-supplier-triad-all-estimates-months","imp-supplier-triad-all-estimates-gbp","imp-supplier-problem"' />
				<regex
					pattern='"22 0883 6932 301","","CI005","Wheal Rodney","4341","2013-04-01 00:00","2013-04-30 23:30","","0","","","0","","","369.605","1.011286","","0.00525288","","5.89","350","30","0.026","273.0","0","31","0.026","0.0","0","0.00161","0.0","","","","","","","0.00382","0.0","30","0.0905","2.715","88","","","","0","0.0","0.0","","","","","","","","","","","","","0.0","0.00275744","0.0","","","","","","","","","","","","","","","","","","","2012-11-29 17:00","0","E","1.087","0.0","2012-12-12 17:00","0","E","1.087","0.0","2013-01-16 17:00","0","E","1.087","0.0","0.0","33.551731","1","0.0","","",""' />
			</request>
			<request path="/chellow/reports/159/output/">
				<regex pattern="finish_year" />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try site search">
			<request path="/chellow/reports/3/output/?pattern=">
				<regex
					pattern='&lt;a href="/chellow/reports/5/output/\?site_id=8"&gt;B00LG Bieling&lt;/a&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Try TRIAD report when supply starts after first triad">
			<request path="/chellow/reports/41/output/?supply_id=6&amp;year=2007">
				<response-code value="200" />
				<regex
					pattern='CI017,"Roselands","1",net,"","22 6354 2983 570","2007-01-23 17:00","0","E","1.074","0.0","2006-12-20 17:00","0","before start of supply","before start of supply","0","2007-02-08 17:30","0","E","1.074","0.0","0.0","5.94264","0.0","","","","","","","","","","","","","","","","","","",""$' />
			</request>
		</test>
		<test name="Try a pre 2010-04-01 DNO 14 bill.">
			<!-- Insert a 14 supply -->
			<request path="/chellow/reports/311/output/" method="post">
				<control name="site_id" value="5" />
				<control name="source_id" value="1" />
				<control name="name" value="Bernard" />
				<control name="start_year" value="2003" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="msn" value="88jiuf ff" />
				<control name="gsp_group_id" value="5" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-14 7206 6139 971" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="dc-14 7206 6139 971" />
				<control name="imp_llfc_code" value="365" />
				<control name="imp_mpan_core" value="14 7206 6139 971" />
				<control name="imp_sc" value="2300" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="sup-14 7206 6139 971" />
				<control name="insert" value="insert" />

				<regex pattern="/chellow/reports/7/output/\?supply_id=17" />
				<response-code value="303" />
			</request>
			<!-- Try a pre 2010-04-01 DNO 14 bill. -->
			<request
				path="/chellow/reports/291/output/?supply_id=17&amp;start_year=2009&amp;start_month=06&amp;start_day=01&amp;start_hour=00&amp;start_minute=00&amp;finish_year=2009&amp;finish_month=06&amp;finish_day=30&amp;finish_hour=23&amp;finish_minute=30">
				<response-code value="200" />
				<regex
					pattern='"Imp MPAN Core","Exp MPAN Core","Site Code","Site Name","Account","From","To","","mop-net-gbp","mop-problem","","dc-net-gbp","dc-problem","","imp-supplier-net-gbp","imp-supplier-tlm","imp-supplier-ccl-kwh","imp-supplier-ccl-rate","imp-supplier-ccl-gbp","imp-supplier-data-collection-gbp","imp-supplier-duos-availability-kva","imp-supplier-duos-availability-days","imp-supplier-duos-availability-rate","imp-supplier-duos-availability-gbp","imp-supplier-duos-excess-availability-kva","imp-supplier-duos-excess-availability-days","imp-supplier-duos-excess-availability-rate","imp-supplier-duos-excess-availability-gbp","imp-supplier-duos-day-kwh","imp-supplier-duos-day-gbp","imp-supplier-duos-night-kwh","imp-supplier-duos-night-gbp","imp-supplier-duos-reactive-rate","imp-supplier-duos-reactive-gbp","imp-supplier-duos-standing-gbp","imp-supplier-settlement-gbp","imp-supplier-night-msp-kwh","imp-supplier-night-gsp-kwh","imp-supplier-night-gbp","imp-supplier-other-msp-kwh","imp-supplier-other-gsp-kwh","imp-supplier-other-gbp","imp-supplier-summer-pk-msp-kwh","imp-supplier-summer-pk-gsp-kwh","imp-supplier-summer-pk-gbp","imp-supplier-winter-low-pk-msp-kwh","imp-supplier-winter-low-pk-gsp-kwh","imp-supplier-winter-low-pk-gbp","imp-supplier-winter-off-pk-msp-kwh","imp-supplier-winter-off-pk-gsp-kwh","imp-supplier-winter-off-pk-gbp","imp-supplier-winter-pk-msp-kwh","imp-supplier-winter-pk-gsp-kwh","imp-supplier-winter-pk-gbp","imp-supplier-bsuos-kwh","imp-supplier-bsuos-rate","imp-supplier-bsuos-gbp","imp-supplier-triad-actual-1-date","imp-supplier-triad-actual-1-msp-kw","imp-supplier-triad-actual-1-status","imp-supplier-triad-actual-1-laf","imp-supplier-triad-actual-1-gsp-kw","imp-supplier-triad-actual-2-date","imp-supplier-triad-actual-2-msp-kw","imp-supplier-triad-actual-2-status","imp-supplier-triad-actual-2-laf","imp-supplier-triad-actual-2-gsp-kw","imp-supplier-triad-actual-3-date","imp-supplier-triad-actual-3-msp-kw","imp-supplier-triad-actual-3-status","imp-supplier-triad-actual-3-laf","imp-supplier-triad-actual-3-gsp-kw","imp-supplier-triad-actual-gsp-kw","imp-supplier-triad-actual-rate","imp-supplier-triad-actual-gbp","imp-supplier-triad-estimate-1-date","imp-supplier-triad-estimate-1-msp-kw","imp-supplier-triad-estimate-1-status","imp-supplier-triad-estimate-1-laf","imp-supplier-triad-estimate-1-gsp-kw","imp-supplier-triad-estimate-2-date","imp-supplier-triad-estimate-2-msp-kw","imp-supplier-triad-estimate-2-status","imp-supplier-triad-estimate-2-laf","imp-supplier-triad-estimate-2-gsp-kw","imp-supplier-triad-estimate-3-date","imp-supplier-triad-estimate-3-msp-kw","imp-supplier-triad-estimate-3-status","imp-supplier-triad-estimate-3-laf","imp-supplier-triad-estimate-3-gsp-kw","imp-supplier-triad-estimate-gsp-kw","imp-supplier-triad-estimate-rate","imp-supplier-triad-estimate-months","imp-supplier-triad-estimate-gbp","imp-supplier-triad-all-estimates-months","imp-supplier-triad-all-estimates-gbp","imp-supplier-problem"' />
				<regex
					pattern='"14 7206 6139 971","","CH023","Treglisson","sup-14 7206 6139 971","2009-06-01 00:00","2009-06-30 23:30","","0","","","0","","","334.3","1.0086111","","0.0047","","5.89","","","0.0457","105.11","","","","","","","0","0.0","0.0012","0.0","135.3","88","0","0","0.0","0","0.0","0.0","0","0","0.0","0","0","0.0","0","0","0.0","0","0","0.0","0.0","0.00046516","0.0","","","","","","","","","","","","","","","","","","","2009-01-06 17:00","0","E","1.037","0.0","2008-12-01 17:00","0","E","1.037","0.0","2008-12-15 17:00","0","E","1.037","0.0","0.0","20.526611","1","0.0","","","","duos-availability-agreed-kva","2300","duos-availability-billed-kva","2300"' />
			</request>
		</test>
		<test name="Report of HHDC snags">
			<request
				path="/chellow/reports/233/output/?hhdc_contract_id=53&amp;days_hidden=1">
				<response-code value="200" />
				<regex
					pattern='"83","22 0883 6932 301","None","CI005","Wheal Rodney","Missing","True","ACTIVE","2002-01-01 00:00","2003-08-02 23:30",' />
			</request>
		</test>
		<test name="Site use graph">
			<request
				path="/chellow/reports/9/output/?site_id=5&amp;months=1&amp;finish_year=2013&amp;finish_month=6">

				<response-code value="200" />
				<regex pattern='&lt;option value="06" selected&gt;06&lt;/option&gt;' />
			</request>
		</test>
		<test name="Site generation graph">
			<request
				path="/chellow/reports/11/output/?site_id=7&amp;months=1&amp;finish_year=2013&amp;finish_month=7">
				<regex pattern='&lt;input type="hidden" name="site_id" value="7"&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="CSV Sites HH Data">
			<!-- Can we make a supply have source sub and view site level hh data 
				okay? -->
			<request method="post" path="/chellow/reports/305/output/">
				<!-- Can we update a supply name? -->
				<!-- Can we update a supply source? -->
				<control name="supply_id" value="1" />
				<control name="name" value="Hello" />
				<control name="source_id" value="2" />
				<control name="generator_type_id" value="1" />
				<control name="gsp_group_id" value="11" />

				<regex pattern='/reports/7/output/\?supply_id=1' />
				<response-code value="303" />
			</request>

			<request
				path="/chellow/reports/29/output/?site_id=7&amp;type=used&amp;months=1&amp;finish_year=2008&amp;finish_month=07">

				<response-code value="200" />
				<regex pattern="CH017,used,2008-07-01," />
			</request>
			<request
				path="/chellow/reports/29/output/?site_id=7&amp;type=displaced&amp;months=1&amp;finish_year=2008&amp;finish_month=07">
				<response-code value="200" />
				<regex pattern="CH017,displaced,2008-07-01," />
			</request>
		</test>
		<test name="Look at list of supplier contracts.">
			<request path="/chellow/reports/75/output/">

				<!-- Are the contracts in alphabetical order? -->
				<regex
					pattern='&lt;tbody&gt;\s*&lt;tr&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/77/output/\?supplier_contract_id=55"&gt;Half-hourlies 2007&lt;/a&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Daily supplier virtual bills page.">
			<request
				path="/chellow/reports/241/output/?supply_id=6&amp;is_import=true&amp;start_year=2013&amp;start_month=10&amp;start_day=1&amp;finish_year=2013&amp;finish_month=10&amp;finish_day=31">
				<response-code value="200" />
				<regex pattern="MPAN Core,Site Code,Site Name" />
				<regex pattern='"22 6354 2983 570",' />
			</request>
		</test>
		<test name="Test register read report.">
			<!-- See if selector is working -->
			<request path="/chellow/reports/217/output/">
				<response-code value="200" />
				<regex pattern="end_year" />
			</request>
		</test>
		<test name="Test register read report for a supply.">
			<request
				path="/chellow/reports/219/output/?supply_id=10&amp;months=1&amp;end_year=2011&amp;end_month=1">
				<response-code value="200" />
				<regex
					pattern="Duration Start,Duration Finish,Supply Id,Import MPAN Core,Export MPAN Core,Batch Reference,Bill Id,Bill Reference,Bill Issue Date,Bill Type,Register Read Id,TPR,Coefficient,Previous Read Date,Previous Read Value,Previous Read Type,Present Read Date,Present Read Value,Present Read Type" />
				<regex
					pattern='"2011-01-01 00:00","2011-01-31 23:30","10","22 1065 3921 534","","07-002","13","3423760005","2011-02-02 00:00","N","8","00001","1","2011-01-04 23:30","24286","E","2011-01-06 23:30","25927","E"' />
			</request>

			<!-- Try for a period where there's a read with no TPR (an MD read) -->
			<request
				path="/chellow/reports/219/output/?supply_id=10&amp;months=1&amp;end_year=2007&amp;end_month=1">
				<response-code value="200" />
				<regex
					pattern='"2007-01-01 00:00","2007-01-31 23:30","10","22 1065 3921 534","","06-002","14","SA342376","2007-01-01 00:00","N","12","md","1","2007-01-04 00:00","45","E","2007-01-17 00:00","76","E"' />
			</request>
		</test>
		<test name="View a MOP rate script. Contract 57.">
			<request path="/chellow/reports/205/output/?mop_rate_script_id=309">
				<response-code value="200" />
			</request>
		</test>
		<test name="View supplies duration selector.">
			<request path="/chellow/reports/147/output/">
				<response-code value="200" />
				<regex pattern="start_year" />
			</request>
		</test>
		<test name="Look at a TPR.">
			<request path="/chellow/reports/97/output/?tpr_id=1">
				<response-code value="200" />
				<regex
					pattern="&lt;tbody&gt;\s*&lt;tr&gt;\s*&lt;td&gt;1&lt;/td&gt;\s*&lt;td&gt;1&lt;/td&gt;" />
			</request>
		</test>
		<test name="CSV Bills.">
			<request path="/chellow/reports/153/output/">
				<response-code value="200" />
				<regex pattern="end_year" />
			</request>
		</test>
		<test name="CSV Supplies Duration with register reads">
			<request
				path="/chellow/reports/149/output/?start_year=2010&amp;start_month=01&amp;start_day=1&amp;start_hour=0&amp;start_minute=0&amp;finish_year=2010&amp;finish_month=01&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<regex pattern='"10","2",' />
			</request>
		</test>
		<test name="Try the site level monthly data HTML report.">
			<request
				path="/chellow/reports/13/output/?site_id=3&amp;finish_year=2005&amp;finish_month=11">
				<regex pattern="For 12 months finishing at the end of" />
				<regex pattern="&lt;th&gt;2005-09-15 00:00&lt;/th&gt;" />

				<response-code value="200" />
			</request>
		</test>
		<test name="Change the name of a site.">
			<request path="/chellow/reports/311/output/" method="post">
				<control name="site_id" value="8" />
				<control name="name" value="Ishmael" />
				<control name="code" value="MOBY" />
				<control name="update" value="Update" />
				<response-code value="303" />
			</request>
		</test>
		<test
			name="Try inserting an era where the existing era is attached to more than one site.">

			<!-- Insert era -->
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="2" />
				<control name="start_year" value="2005" />
				<control name="start_month" value="05" />
				<control name="start_day" value="04" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="insert_era" />

				<response-code value="303" />
			</request>
		</test>
		<test name="Check user roles page.">
			<request path="/chellow/reports/261/output/">
				<response-code value="200" />
				<regex pattern="party-viewer" />
			</request>
		</test>
		<test name="Scenario runner">
			<request path="/chellow/reports/245/output/">
				<response-code value="200" />
			</request>
		</test>
		<test name="Bill type">
			<request path="/chellow/reports/201/output/?bill_type_id=1">
				<response-code value="200" />
			</request>
		</test>
		<test name="Test sse edi bill with MD line">
			<!-- Supplier contract 60. -->
			<request path="/chellow/reports/321/output/" method="post">
				<control name="supplier_batch_id" value="3" />
				<control type="file" name="import_file" value="bills2.sse.edi" />
				<response-code value="303" />
				<regex pattern="/reports/323/output/\?importer_id=0" />
			</request>

			<!-- Supplier contract 60. -->
			<request path="/chellow/reports/323/output/?importer_id=0">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
		</test>
		<test name="Look at an HHDC batch">
			<request path="/chellow/reports/203/output/?hhdc_batch_id=8">
				<response-code value="200" />
				<regex pattern="&lt;tbody&gt;\s*&lt;tr&gt;" />
			</request>
		</test>
		<test name="Edit register read with a TPR that's not 00001">
			<!-- Supplier contract 60, batch 7, bill 10 -->
			<request path="/chellow/reports/31/output/?supplier_read_id=1">
				<regex pattern='&lt;option value="37" selected&gt;00040&lt;/option&gt;' />
			</request>
		</test>
		<test name="Add and delete an HHDC contract">
			<!-- Insert a new batch -->
			<request path="/chellow/reports/281/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control name="reference" value="to_delete" />
				<control name="description" value="" />
				<response-code value="303" />
				<regex pattern="/reports/203/output/\?hhdc_batch_id=10" />
			</request>

			<!-- Delete it. HHDC contract 52 -->
			<request path="/chellow/reports/283/output/" method="post">
				<control name="hhdc_batch_id" value="10" />
				<control name="delete" value="Delete" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Try CRC Special Events">
			<request path="/chellow/reports/215/output/?year=2012">
				<response-code value="200" />
				<regex pattern='"22 0883 6932 301"' />
			</request>
		</test>
		<test name="A supply level virtual bill that crosses an era boundary">
			<request
				path="/chellow/reports/291/output/?supply_id=10&amp;start_year=2010&amp;start_month=01&amp;start_day=01&amp;start_hour=00&amp;start_minute=0&amp;finish_year=2010&amp;finish_month=01&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<response-code value="200" />
				<regex
					pattern='"Imp MPAN Core","Exp MPAN Core","Site Code","Site Name","Account","From","To","","mop-net-gbp","mop-problem","","dc-net-gbp","dc-problem","","imp-supplier-net-gbp","imp-supplier-vat-gbp","imp-supplier-gross-gbp","imp-supplier-sum-msp-kwh","imp-supplier-problem"' />
				<regex
					pattern='"22 1065 3921 534","","CI017","Roselands","SA342376","2010-01-01 00:00","2010-01-03 23:30","","0","","","0","","","0.0","0.0","0.0","0",""' />
			</request>
		</test>
		<test name="A bill check with multiple covered bills">
			<request path="/chellow/reports/111/output/?bill_id=8">
				<response-code value="200" />
				<regex
					pattern='"06-004","00101","N","244","3810.08","355.03","2011-05-01 00:00","2011-06-30 00:00","22 6354 2983 570","CI017","Roselands","2011-05-01 00:00","2011-06-30 00:00","9;8","4701.16","3010.226","1690.934","","1.0077268","","","11.4","0.00485","","","","","5.89","","","2300","","60","","0.0211","","2911.8","","","0","","31","","0.0211","","0.0","","","","","","","","","","","","","0.00353","","0.0","","","","","","88","","","0","","0","","0.0","","","0","","0.0","","0.0","","","0","","0","","0.0","","","0","","0","","0.0","","","0","","0","","0.0","","","0","","0","","0.0","","","0.0","","0.00102894","","0.0","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","2010-12-07 17:00","","0","","E","","1.087","","0.0","","2010-12-20 17:00","","0","","E","","1.087","","0.0","","2011-01-06 17:00","","0","","E","","1.087","","0.0","","0.0","","28.408897","","1","","0.0","","","","","","","","","virtual-duos-fixed-days","60","","","virtual-duos-fixed-gbp","4.536","","","virtual-duos-fixed-rate","0.0756","","","virtual-duos-green-gbp","0.0","","","virtual-duos-green-kwh","0","","","virtual-duos-green-rate","0.00138","",""' />
			</request>
		</test>
		<test name="Contract virtual bills">
			<request
				path="/chellow/reports/87/output/?supplier_contract_id=55&amp;start_year=2013&amp;start_month=12&amp;start_day=01&amp;start_hour=00&amp;start_minute=00&amp;finish_year=2013&amp;finish_month=12&amp;finish_day=01&amp;finish_hour=23&amp;finish_minute=30">
				<response-code value="200" />
				<regex
					pattern='"22 0470 7514 535","CH017","Parbola","010","2013-12-01 00:00","2013-12-01 23:30","93.89","1.0123821","","","","5.89","150","1","0","0","","","","","","","","","0.00147","0.0","","88","0","0","0.0","0","0.0","0.0","0","0","0.0","0","0","0.0","0","0","0.0","0","0","0.0","0.0","0.00114808","0.0","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","duos-fixed-days","1","duos-fixed-gbp","0","duos-fixed-rate","0","duos-green-gbp","0.0","duos-green-kwh","0","duos-green-rate","-0.00649"' />
			</request>
		</test>
		<test name="Contract displaced virtual bills">
			<request
				path="/chellow/reports/109/output/?supplier_contract_id=55&amp;months=1&amp;finish_year=2013&amp;finish_month=01">
				<response-code value="200" />
				<regex pattern='"CI004",' />
			</request>
		</test>

		<test
			name="Check that covering hh data by a different era doesn't result in missing data being reported.">
			<!-- Move finish date of era -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="1" />
				<control name="start_year" value="2003" />
				<control name="start_month" value="08" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="true" />
				<control name="finish_year" value="2004" />
				<control name="finish_month" value="07" />
				<control name="finish_day" value="06" />
				<control name="finish_hour" value="23" />
				<control name="finish_minute" value="30" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 9205 6799 106" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="01" />
				<control name="msn" value="" />
				<control name="pc_id" value="9" />
				<control name="mtc_code" value="845" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="" />
				<control name="imp_llfc_code" value="550" />
				<control name="imp_mpan_core" value="22 9205 6799 106" />
				<control name="imp_sc" value="450" />
				<control name="imp_supplier_contract_id" value="55" />
				<control name="imp_supplier_account" value="11640077" />
				<control name="exp_llfc_code" value="581" />
				<control name="exp_mpan_core" value="22 0470 7514 535" />
				<control name="exp_sc" value="150" />
				<control name="exp_supplier_contract_id" value="55" />
				<control name="exp_supplier_account" value="" />

				<response-code value="303" />
			</request>

			<request
				path="/chellow/reports/37/output/?hhdc-contract-id=53&amp;hidden_days=5">
				<response-code value="200" />
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;\s*&lt;ul&gt;\s*&lt;li&gt;\s*&lt;a href="/chellow/reports/117/output/\?snag_id=100"&gt;view&lt;/a&gt;  \[&lt;a href="/chellow/reports/365/output/\?snag_id=100"&gt;edit&lt;/a&gt;\]\s*&lt;/li&gt;\s*&lt;/ul&gt;\s*&lt;/td&gt;\s*&lt;td&gt;\s*&lt;/td&gt;\s*&lt;td&gt;\s*22 0470 7514 535\s*&lt;/td&gt;\s*&lt;td&gt;\s*&lt;ul&gt;\s*&lt;li&gt;CH017 Parbola&lt;/li&gt;\s*&lt;/ul&gt;\s*&lt;/td&gt;\s*&lt;td&gt;Missing&lt;/td&gt;\s*&lt;td&gt;\s*&lt;ul&gt;\s*&lt;li&gt;\s*Export\s*ACTIVE\s*&lt;/li&gt;\s*&lt;/ul&gt;\s*&lt;/td&gt;\s*&lt;td&gt;\s*2004-07-07 00:00 to\s*2005-09-14 23:30\s*&lt;/td&gt;\s*&lt;/tr&gt;' />
			</request>
		</test>

		<test
			name="Inserting an era that covers an ongoing era that has data from start.">

			<!-- Insert era -->
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="7" />
				<control name="start_year" value="2008" />
				<control name="start_month" value="11" />
				<control name="start_day" value="02" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="insert_era" />

				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/233/output/?hhdc_contract_id=53&amp;days_hidden=0">
				<regex
					pattern='"0","107","22 4862 4512 332","None","CH023","Treglisson","Missing","True","ACTIVE","2010-02-04 20:30",""' />
				<regex
					pattern='"0","3","22 9205 6799 106","22 0470 7514 535","CH017","Parbola","Missing","False","ACTIVE","2003-08-03 00:00","2004-07-06 23:30","[^"]*","[^"]*","True"\s*"0","100","None","22 0470 7514 535","CH017","Parbola","Missing","False","ACTIVE","2004-07-07 00:00","2005-09-14 23:30","[^"]*","[^"]*","False"\s*"0","102","None","22 0470 7514 535","CH017","Parbola","Missing","False","ACTIVE","2005-09-15 00:30","2005-12-15 06:30","[^"]*","[^"]*","False"\s*"0","101","None","22 0470 7514 535","CH017","Parbola","Missing","False","ACTIVE","2005-12-15 10:00","2008-07-06 23:30","[^"]*","[^"]*","False"\s*"0","56","None","22 0470 7514 535","CH017","Parbola","Missing","False","ACTIVE","2008-07-07 00:00","2008-08-06 23:30","[^"]*","[^"]*","True"\s*"0","79","None","22 0470 7514 535","CH017","Parbola","Missing","False","ACTIVE","2008-08-07 00:00","2008-09-05 23:30","[^"]*","[^"]*","False"\s*"0","68","None","22 0470 7514 535","CH017","Parbola","Missing","False","ACTIVE","2008-09-06 00:00","","[^"]*","[^"]*","False"\s*' />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="Check that an era with imp_sc of 0 is displayed properly in edit mode. Supply 17">
			<request path="/chellow/reports/307/output/?era_id=22">
				<regex
					pattern='&lt;input name="imp_sc" value="0" size="9" maxlength="9"&gt;' />

				<response-code value="200" />
			</request>
		</test>
		<test
			name="Try out the supplies snapshot report including a last normal read type.">

			<request
				path="/chellow/reports/33/output/?supply_id=9&amp;year=2007&amp;month=09&amp;day=01&amp;hour=00&amp;minute=00">
				<response-code value="200" />
				<regex
					pattern='"2007-09-30 23:30","CI004","Lower Treave","","","9","net","","22","HV","nhh","no","05","535","5","0127","3","MOP Contract","mc-22 0195 4836 192","Dynamat data","dc-22 0195 4836 192","P96C93722","2005-08-06 00:00","2007-08-01 00:00","N","","","false","false","false","false","false","false","22 0195 4836 192","30","510","PC 5-8 &amp; HH HV","Non half-hourlies 2007","341664","","2007-08-01 00:00","","","","","","","",""' />
			</request>

			<!-- Try a supplies snapshot where previous era isn't AMR -->
			<request
				path="/chellow/reports/33/output/?supply_id=9&amp;year=2011&amp;month=05&amp;day=01&amp;hour=00&amp;minute=00">
				<response-code value="200" />
				<regex
					pattern='"2011-05-31 23:30","CI004","Lower Treave","","","9","net","","22","LV","unmetered","no","08","857","6c","0428","2","MOP Contract","mc-22 0195 4836 192","Dynamat data","dc-22 0195 4836 192","P96C93722","2005-08-06 00:00","unmetered","","","","false","false","false","false","false","false","22 0195 4836 192","304","980","NHH UMS Cat B : Dusk to Dawn","Non half-hourlies 2007","SA342376","","2007-08-01 00:00","","","","","","","",""\Z' />
			</request>

			<!-- Try a supplies snapshot to check that latest import supplier bill 
				is correct -->
			<request
				path="/chellow/reports/33/output/?supply_id=6&amp;year=2012&amp;month=05&amp;day=01&amp;hour=00&amp;minute=00">
				<response-code value="200" />
				<regex
					pattern='"2012-05-31 23:30","CI017","Roselands","","","6","net","","22","LV","hh","no","00","845","5","","","MOP Contract","mc-22 6354 2983 570","HH contract","01","","2007-01-01 00:00","hh","","","","true","true","false","false","false","true","22 6354 2983 570","2300","570","PC 5-8 &amp; HH LV","Half-hourlies 2007","141 5532","","2011-06-30 00:00","","","","","","","",""\Z' />
			</request>
		</test>
		<test name="Run supply virtual bill over 2 months">
			<request
				path="/chellow/reports/291/output/?supply_id=7&amp;start_year=2013&amp;start_month=09&amp;start_day=29&amp;start_hour=00&amp;start_minute=00&amp;finish_year=2013&amp;finish_month=11&amp;finish_day=28&amp;finish_hour=23&amp;finish_minute=30">
				<regex
					pattern='"22 4862 4512 332","","CH023","Treglisson","141 5532","2013-10-01 00:00","2013-10-31 23:30","","0","","","0","","","0.0","0.0","0.0","0",""' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Un-ignore a site snag">
			<request path="/chellow/reports/373/output/" method="post">
				<control name="site_snag_id" value="36" />
				<control name="ignore" value="false" />
				<response-code value="303" />
			</request>
		</test>
		<test name="Insert a batch with general import">
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="gi_batch.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=0" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=0">
				<refresh />
				<response-code value="200" />
				<regex pattern="The file has been imported successfully\." />
			</request>
		</test>
		<test name="Check df2 clock change">
			<!-- Import some hh Stark DF2 data -->
			<request path="/chellow/reports/211/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control type="file" name="import_file" value="hh_clock_change.df2" />
				<response-code value="303" />
				<regex pattern="/reports/65/output/\?hhdc_contract_id=53&amp;process_id=0" />
			</request>
			<request
				path="/chellow/reports/65/output/?hhdc_contract_id=53&amp;process_id=0">
				<refresh />
				<regex pattern="The import has completed.*successfully." />

				<response-code value="200" />
			</request>
			<request
				path="/chellow/reports/17/output/?supply_id=5&amp;months=1&amp;finish_year=2014&amp;finish_month=03">
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;\s*2014-03-30 00:30\s*&lt;/td&gt;\s*&lt;td&gt;0&lt;/td&gt;\s*&lt;td&gt;A&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test name="NHH bill outside supply period.">
			<!-- Supplier contract 56 -->

			<!-- Create a new batch -->
			<request path="/chellow/reports/287/output/" method="post">
				<control name="supplier_contract_id" value="59" />
				<control name="reference" value="06-078" />
				<control name="description" value="Way out batch" />
				<response-code value="303" />
				<regex pattern="/reports/91/output/\?supplier_batch_id=12" />
			</request>

			<request path="/chellow/reports/321/output/" method="post">
				<control name="supplier_batch_id" value="12" />
				<control type="file" name="import_file" value="nhh_bills2007.csv" />

				<response-code value="303" />
				<regex pattern="/reports/323/output/\?importer_id=1" />
			</request>

			<!-- Supplier contract 59, batch 12 -->
			<request path="/chellow/reports/323/output/?importer_id=1">
				<refresh />
				<response-code value="200" />
				<regex
					pattern="All the bills have been successfully loaded and attached to the batch\." />
			</request>
			<request
				path="/chellow/reports/219/output/?supply_id=7&amp;months=1&amp;end_year=2002&amp;end_month=1">
				<response-code value="200" />
				<regex
					pattern='"2002-01-01 00:00","2002-01-31 23:30","7","22 4862 4512 332","","06-078","20","jg87593jfj","2002-02-02 00:00","N","15","00001","1","2002-01-04 23:30","2286","E","2002-01-06 23:30","2927","E"' />
			</request>
		</test>
		<test name="Check the 'also supplies' field of a site.">
			<!-- Attach another site to an era. Supply 2 -->
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="8" />
				<control name="site_code" value="CI005" />
				<control name="attach" value="Attach" />
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/5/output/?site_id=1">
				<regex
					pattern='3475 1614 211\s*&lt;/td&gt;\s*&lt;td&gt;\s*this site\s*&lt;/td&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/5/output/\?site_id=3" title="Wheal Rodney"&gt;CI005&lt;/a&gt;\s*&lt;/td&gt;' />
				<response-code value="200" />
			</request>
		</test>
		<test
			name="In supplies snapshot, test the last billed date of MOP and DC bills">
			<request
				path="/chellow/reports/33/output/?supply_id=5&amp;year=2014&amp;month=05&amp;day=31&amp;hour=23&amp;minute=30">
				<response-code value="200" />
				<regex
					pattern='"2014-05-31 23:30","CI005","Wheal Rodney","","","5","gen","chp","22","LV","hh","no","00","845","5","","","MOP Contract","22 0883 6932 301","HH contract","22 0883 6932 301","","2002-01-01 00:00","hh","","2007-10-31 23:30","2007-10-31 23:30","true","true","false","false","false","true","22 0883 6932 301","350","570","PC 5-8 &amp; HH LV","Half-hourlies 2013","4341","0","","","","","","","","",""' />
			</request>
		</test>
		<test name="Site summary page that has data quality errors.">
			<request
				path="/chellow/reports/13/output/?site_id=1&amp;finish_year=2005&amp;finish_month=11">
				<regex
					pattern='See &lt;a href="/chellow/reports/11/output/\?site_id=1&amp;amp;months=1&amp;amp;finish_year=2005&amp;amp;finish_month=10"&gt;generation graph&lt;/a&gt;' />
			</request>
		</test>
		<test name="HTML virtual bill">
			<request
				path="/chellow/reports/101/output/?supply_id=10&amp;start_year=2014&amp;start_month=05&amp;start_day=1&amp;start_hour=0&amp;start_minute=0&amp;finish_year=2014&amp;finish_month=05&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<response-code value="200" />
			</request>
		</test>
		<test name="Make sure rate scripts remain contiguous.">
			<request path="/chellow/reports/273/output/" method="post">
				<control name="rate_script_id" value="240" /> <!-- First rate script of non-core contract triad -->
				<control name="start_year" value="2005" />
				<control name="start_month" value="04" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="has_finished" value="true" />
				<control name="finish_year" value="2006" />
				<control name="finish_month" value="03" />
				<control name="finish_day" value="30" />
				<control name="finish_hour" value="23" />
				<control name="finish_minute" value="30" />
				<control name="script"><![CDATA[from datetime import datetime
from pytz import utc

def triad_dates():
    return [datetime(2005, 11, 28, 17, 0, tzinfo=utc), datetime(2006, 1, 5, 17, 0, tzinfo=utc), datetime(2006, 2, 3, 17, 30, tzinfo=utc)]]]>
				</control>
				<response-code value="303" />
			</request>

			<request path="/chellow/reports/271/output/?rate_script_id=241">
				<regex pattern="2006-03-31 00:00" />
				<response-code value="200" />
			</request>

			<!-- Put it back to how it was -->
			<request path="/chellow/reports/273/output/" method="post">
				<control name="rate_script_id" value="240" />
				<control name="start_year" value="2005" />
				<control name="start_month" value="04" />
				<control name="start_day" value="01" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="has_finished" value="true" />
				<control name="finish_year" value="2006" />
				<control name="finish_month" value="03" />
				<control name="finish_day" value="31" />
				<control name="finish_hour" value="23" />
				<control name="finish_minute" value="30" />
				<control name="script"><![CDATA[from datetime import datetime
from pytz import utc

def triad_dates():
    return [datetime(2005, 11, 28, 17, 0, tzinfo=utc), datetime(2006, 1, 5, 17, 0, tzinfo=utc), datetime(2006, 2, 3, 17, 30, tzinfo=utc)]]]>
				</control>
				<response-code value="303" />
			</request>
		</test>
		<test name="Try sites monthly duration with displaced bill">
			<request
				path="/chellow/reports/161/output/?site_id=1&amp;months=1&amp;finish_year=2010&amp;finish_month=07">
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/251/output/">
				<refresh max="40" />
				<response-code value="200" />
				<regex pattern='FINISHED_site_monthly_duration_for_CI004_1_to_2010_7\.csv' />
			</request>
			<request
				path="/chellow/reports/253/output/?name=FINISHED_site_monthly_duration_for_CI004_1_to_2010_7.csv">

				<response-code value="200" />
				<regex pattern='"CI004",' />
			</request>
		</test>
		<test name="Try sites monthly duration covering bills">
			<request
				path="/chellow/reports/161/output/?site_id=4&amp;months=1&amp;finish_year=2011&amp;finish_month=05">
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/251/output/">
				<refresh max="40" />
				<response-code value="200" />
				<regex pattern='FINISHED_site_monthly_duration_for_CI017_1_to_2011_5\.csv' />
			</request>
			<request
				path="/chellow/reports/253/output/?name=FINISHED_site_monthly_duration_for_CI017_1_to_2011_5.csv">
				<response-code value="200" />
				<regex pattern='"CI017",' />
			</request>
		</test>
		<test name="Try sites monthly duration with a clocked bill">
			<request path="/chellow/reports/321/output/" method="post">
				<control name="supplier_batch_id" value="7" />
				<control type="file" name="import_file" value="bills-nhh-clocked.csv" />

				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/161/output/?site_id=4&amp;months=1&amp;finish_year=2012&amp;finish_month=02">
				<response-code value="303" />
			</request>
			<request path="/chellow/reports/251/output/">
				<refresh max="40" />
				<response-code value="200" />
				<regex pattern='FINISHED_site_monthly_duration_for_CI017_1_to_2012_2\.csv' />
			</request>
			<request
				path="/chellow/reports/253/output/?name=FINISHED_site_monthly_duration_for_CI017_1_to_2012_2.csv">
				<response-code value="200" />
				<regex pattern='"CI017",' />
			</request>

			<!-- Bill check on a clocked bill -->
			<request path="/chellow/reports/111/output/?bill_id=21">
				<response-code value="200" />
				<regex
					pattern='"07-002","3423760010","N","10","9.07","0.21","2012-01-05 00:00","2012-01-10 23:30","22 1065 3921 534","CI017","Roselands","2012-01-05 00:00","2012-01-10 23:30","21","9.07","1.0","8.07","10.0","10.0","",' />
			</request>
		</test>
		<test name="Monthly supplies duration with export hh data">
			<request
				path="/chellow/reports/177/output/?supply_id=1&amp;months=1&amp;end_year=2008&amp;end_month=07">
				<regex
					pattern="supply-id,supply-name,source-code,generator-type,month,pc-code,msn,site-code,site-name,metering-type,import-mpan-core,metered-import-kwh,metered-import-net-gbp,metered-import-estimated-kwh,billed-import-kwh,billed-import-net-gbp,export-mpan-core,metered-export-kwh,metered-export-estimated-kwh,billed-export-kwh,billed-export-net-gbp,problem,timestamp" />
				<regex
					pattern='1,"Hello","sub","","2008-07-31 23:30","00","","CH017","Parbola","hh","None","18.281","0","0","0","0","22 0470 7514 535","0","0","0","0",""' />
				<response-code value="200" />
			</request>
		</test>
		<test name="Supply level hh data CSV, hh per row">
			<request
				path="/chellow/reports/187/output/?supply_id=7&amp;start_year=2008&amp;start_month=01&amp;start_day=01&amp;start_hour=0&amp;start_minute=0&amp;finish_year=2008&amp;finish_month=01&amp;finish_day=31&amp;finish_hour=23&amp;finish_minute=30">
				<regex
					pattern='"CH023","22 4862 4512 332","","2008-01-01 00:00","3.77","A","","","","","","","","","",""' />
				<response-code value="200" />
			</request>
		</test>
		<test name="General import of bill with start date after finish date">
			<request path="/chellow/reports/293/output/" method="post">
				<control type="file" name="import_file" value="general-bills-error.csv" />
				<response-code value="303" />
				<regex pattern="/reports/295/output/\?process_id=1" />
			</request>
			<request path="/chellow/reports/295/output/?process_id=1">
				<refresh />

				<!-- Check good error message -->
				<regex
					pattern="The bill start date 2007-01-05 00:00 can&amp;#39;t be after the finish date 2007-01-01 00:00." />
				<response-code value="200" />
			</request>
		</test>
		<test name="Manually insert a bill with errors">
			<request path="/chellow/reports/313/output/" method="post">
				<control name="supplier_batch_id" value="4" />
				<control name="mpan_core" value="" />
				<control name="reference" value="" />
				<control name="issue_year" value="2014" />
				<control name="issue_month" value="7" />
				<control name="issue_day" value="30" />
				<control name="issue_hour" value="15" />
				<control name="issue_minute" value="30" />
				<control name="start_year" value="2014" />
				<control name="start_month" value="07" />
				<control name="start_day" value="30" />
				<control name="start_hour" value="15" />
				<control name="start_minute" value="30" />
				<control name="finish_year" value="2014" />
				<control name="finish_month" value="07" />
				<control name="finish_day" value="30" />
				<control name="finish_hour" value="15" />
				<control name="finish_minute" value="30" />
				<control name="kwh" value="0" />
				<control name="net" value="0" />
				<control name="vat" value="0" />
				<control name="gross" value="0" />
				<control name="account" value="0" />
				<control name="bill_type_id" value="1" />
				<control name="breakdown" value="{}" />

				<response-code value="400" />

				<!-- Check good error message -->
				<regex
					pattern="The MPAN core &amp;#39;&amp;#39; must contain exactly 13 digits\." />

			</request>
		</test>
		<test name="HH by HH virtual bill">
			<!-- Must straddle two eras -->
			<request
				path="/chellow/reports/387/output/?supply_id=5&amp;start_year=2012&amp;start_month=12&amp;start_day=31&amp;start_hour=23&amp;start_minute=30&amp;finish_year=2013&amp;finish_month=1&amp;finish_day=1&amp;finish_hour=23&amp;finish_minute=30">
				<response-code value="200" />

				<regex pattern='"22 0883 6932 301",' />
			</request>
		</test>
		<test name="Look at monthly report with an MD in kVA">
			<!-- Add in reactive HH -->
			<request path="/chellow/reports/303/output/" method="post">
				<control name="channel_id" value="55" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="02" />
				<control name="start_day" value="04" />
				<control name="start_hour" value="20" />
				<control name="start_minute" value="00" />
				<control name="insert" value="Insert" />
				<control name="value" value="45.7" />
				<control name="status" value="A" />

				<response-code value="303" />
			</request>
			<request
				path="/chellow/reports/15/output/?is_import=true&amp;supply_id=7&amp;years=1&amp;year=2010">

				<response-code value="200" />
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;2010-02-01 00:00&lt;/td&gt;\s*&lt;td&gt;22 4862 4512 332&lt;/td&gt;\s*&lt;td&gt;\s*2010-02-04 20:00\s*&lt;/td&gt;\s*&lt;td&gt;60.9&lt;/td&gt;\s*&lt;td&gt;91.4&lt;/td&gt;\s*&lt;td&gt;0.55&lt;/td&gt;\s*&lt;td&gt;109.8&lt;/td&gt;\s*&lt;td&gt;230&lt;/td&gt;\s*&lt;td&gt;\s*30\s*&lt;/td&gt;\s*&lt;/tr&gt;' />
			</request>
		</test>
		<test name="Order of HHDC batches">
			<!-- Add in second batch -->
			<request path="/chellow/reports/281/output/" method="post">
				<control name="hhdc_contract_id" value="53" />
				<control name="reference" value="7" />
				<control name="description" value="" />

				<response-code value="303" />
			</request>
			<request path="/chellow/reports/93/output/?hhdc_contract_id=53">

				<response-code value="200" />
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/203/output/\?hhdc_batch_id=13"&gt;\s*7\s*&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;&lt;/td&gt;\s*&lt;/tr&gt;\s*&lt;tr&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/203/output/\?hhdc_batch_id=8"&gt;\s*001-7t\s*&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;hhdc batch&lt;/td&gt;\s*&lt;/tr&gt;' />
			</request>
		</test>
		<test name="Order of MOP batches">
			<!-- Add in second batch -->
			<request path="/chellow/reports/353/output/" method="post">
				<control name="mop_contract_id" value="57" />
				<control name="reference" value="7a" />
				<control name="description" value="" />

				<response-code value="303" />
			</request>
			<request path="/chellow/reports/191/output/?mop_contract_id=57">

				<response-code value="200" />
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/193/output/\?mop_batch_id=9"&gt;\s*99/992\s*&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;mop batch&lt;/td&gt;\s*&lt;/tr&gt;\s*&lt;tr&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/193/output/\?mop_batch_id=14"&gt;\s*7a\s*&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;&lt;/td&gt;\s*&lt;/tr&gt;' />
			</request>
		</test>
		<test name="MTCs">
			<request path="/chellow/reports/61/output/">
				<response-code value="200" />
				<regex
					pattern='&lt;tr&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/63/output/\?mtc_id=573"&gt;\s*001\s*&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/67/output/\?dno_contract_id=37"&gt;\s*10\s*&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;Budget Warmth&lt;/td&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/131/output/\?meter_type_id=16"&gt;\s*UM\s*&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;td&gt;0&lt;/td&gt;\s*&lt;/tr&gt;' />
			</request>

			<request path="/chellow/reports/63/output/?mtc_id=573">
				<response-code value="200" />
				<regex
					pattern='&lt;tr&gt;\s*&lt;th&gt;Code&lt;/th&gt;\s*&lt;td&gt;001&lt;/td&gt;\s*&lt;/tr&gt;\s*&lt;tr&gt;\s*&lt;th&gt;DNO&lt;/th&gt;\s*&lt;td&gt;\s*&lt;a href="/chellow/reports/67/output/\?dno_contract_id=37"&gt;\s*10\s*&lt;/a&gt;\s*&lt;/td&gt;\s*&lt;/tr&gt;' />
			</request>

			<!-- Try an MTC common to all DNOs -->
			<request path="/chellow/reports/63/output/?mtc_id=233">
				<response-code value="200" />
				<regex
					pattern='&lt;tr&gt;\s*&lt;th&gt;Code&lt;/th&gt;\s*&lt;td&gt;500&lt;/td&gt;\s*&lt;/tr&gt;\s*&lt;tr&gt;\s*&lt;th&gt;DNO&lt;/th&gt;\s*&lt;td&gt;\s*All\s*&lt;/td&gt;\s*&lt;/tr&gt;' />
			</request>
		</test>

		<test name="Move forward era with channels, when era with no channels precedes it">
			<request path="/chellow/reports/299/output/" method="post">
				<control name="era_id" value="17" />
				<control name="imp_related" value="true" />
				<control name="channel_type" value="ACTIVE" />
				<response-code value="303" />
			</request>

			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="17" />
				<control name="msn" value="I02D89150" />
				<control name="start_year" value="2010" />
				<control name="start_month" value="01" />
				<control name="start_day" value="06" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="false" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 1065 3921 534" />
				<control name="hhdc_contract_id" value="53" />
				<control name="hhdc_account" value="dc-22 1065 3921 534" />
				<control name="pc_id" value="3" />
				<control name="mtc_code" value="801" />
				<control name="cop_id" value="6" />
				<control name="ssc_code" value="366" />
				<control name="imp_llfc_code" value="110" />
				<control name="imp_mpan_core" value="22 1065 3921 534" />
				<control name="imp_sc" value="30" />
				<control name="imp_supplier_contract_id" value="63" />
				<control name="imp_supplier_account" value="SA342376000" />

				<response-code value="303" />
			</request>
		</test>
		<test name="NHH dumb bill that straddles dumb and AMR eras">
		
			<!-- Add new era, so that bill straddles join -->
			<request path="/chellow/reports/305/output/" method="post">
				<control name="supply_id" value="11" />
				<control name="start_year" value="2007" />
				<control name="start_month" value="07" />
				<control name="start_day" value="10" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="insert_era" value="Insert" />

				<regex pattern="/chellow/reports/7/output/\?supply_id=11" />
				<response-code value="303" />
			</request>
		
			<!-- Add a channel to the new era -->
			<request path="/chellow/reports/299/output/" method="post">
				<control name="era_id" value="27" />
				<control name="imp_related" value="true" />
				<control name="channel_type" value="ACTIVE" />
				<response-code value="303" />
			</request>

			<request path="/chellow/reports/111/output/?bill_id=6">
				<response-code value="200" />
				<regex
					pattern='"06-002","23618619","N","0","49119","8596","2007-06-30 00:00","2007-07-31 00:00","22 9974 3438 105","CI005","Wheal Rodney","2007-06-30 00:00","2007-07-31 00:00","6","49119.0","0.0","49119.0","8596.0","0.0","8596.0","","0.0","","0.0","4.765","",""' />
			</request>
			
		</test>
		<test name="NHH dumb bill with prev and pres dates in different eras">
			<request path="/chellow/reports/307/output/" method="post">
				<control name="era_id" value="10" />
				<control name="start_year" value="2005" />
				<control name="start_month" value="09" />
				<control name="start_day" value="06" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="is_ended" value="true" />
				<control name="finish_year" value="2011" />
				<control name="finish_month" value="01" />
				<control name="finish_day" value="19" />
				<control name="finish_hour" value="23" />
				<control name="finish_minute" value="30" />
				<control name="mop_contract_id" value="57" />
				<control name="mop_account" value="mc-22 1065 3921 534" />
				<control name="hhdc_contract_id" value="54" />
				<control name="hhdc_account" value="dc-22 1065 3921 534" />
				<control name="msn" value="I02D89150" />
				<control name="pc_id" value="3" />
				<control name="mtc_code" value="801" />
				<control name="cop_id" value="5" />
				<control name="ssc_code" value="0393" />
				<control name="imp_llfc_code" value="110" />
				<control name="imp_mpan_core" value="22 1065 3921 534" />
				<control name="imp_sc" value="30" />
				<control name="imp_supplier_contract_id" value="63" />
				<control name="imp_supplier_account" value="SA342376" />
				<response-code value="303" />
			</request>

			<!-- Check the bill -->	
			<request path="/chellow/reports/111/output/?bill_id=13">
				<response-code value="200" />
				<regex
					pattern='"07-002","3423760005","N","150","98.17","15.01","2011-01-05 00:00","2011-01-10 23:30","22 1065 3921 534","CI017","Roselands","2011-01-05 00:00","2011-01-10 23:30","13","98.17","164.1","-65.93","150.0","1641.0","",""' />
			</request>
		</test>
		<test name="Check bill with teleswitch TPR">
			<!-- Update register read to make the TPR a teleswitch one -->
			<request path="/chellow/reports/31/output/" method="post">
				<control name="supplier_read_id" value="16" />
				<control name="mpan" value="22 1065 3921 534" />
				<control name="coefficient" value="1" />
				<control name="msn" value="I02D89150" />
				<control name="units" value="kWh" />
				<control name="tpr_id" value="643" />
				<control name="previous_year" value="2012" />
				<control name="previous_month" value="01" />
				<control name="previous_day" value="04" />
				<control name="previous_hour" value="23" />
				<control name="previous_minute" value="30" />
				<control name="previous_value" value="473" />
				<control name="previous_type_id" value="1" />
				<control name="present_year" value="2012" />
				<control name="present_month" value="01" />
				<control name="present_day" value="06" />
				<control name="present_hour" value="23" />
				<control name="present_minute" value="30" />
				<control name="present_value" value="725" />
				<control name="present_type_id" value="1" />
				<control name="update" value="Update" />

				<response-code value="303" />
			</request>

			<!-- Delete the channel to make it a dumb NHH -->	
			<request path="/chellow/reports/303/output/" method="post">
				<control name="channel_id" value="56" />
				<control name="delete" value="delete" />

				<response-code value="303" />

			</request>

			<!-- Check the bill -->	
			<request path="/chellow/reports/111/output/?bill_id=21">
				<response-code value="200" />
				<regex
					pattern='"07-002","3423760010","N","10","9.07","0.21","2012-01-05 00:00","2012-01-10 23:30","22 1065 3921 534","CI017","Roselands","2012-01-05 00:00","2012-01-10 23:30","21","9.07","0.0","9.07","10.0","0","",""' />
			</request>
		</test>
		<test name="CRC with read pair straddling eras">
			<!-- Update register read to make the TPR a teleswitch one -->
			<request path="/chellow/reports/31/output/" method="post">
				<control name="supplier_read_id" value="7" />
				<control name="mpan" value="22 1065 3921 534" />
				<control name="coefficient" value="1" />
				<control name="msn" value="I02D89150" />
				<control name="units" value="kWh" />
				<control name="tpr_id" value="1" />
				<control name="previous_year" value="2009" />
				<control name="previous_month" value="04" />
				<control name="previous_day" value="04" />
				<control name="previous_hour" value="23" />
				<control name="previous_minute" value="30" />
				<control name="previous_value" value="14281" />
				<control name="previous_type_id" value="1" />
				<control name="present_year" value="2010" />
				<control name="present_month" value="01" />
				<control name="present_day" value="06" />
				<control name="present_hour" value="23" />
				<control name="present_minute" value="30" />
				<control name="present_value" value="15924" />
				<control name="present_type_id" value="1" />
				<control name="update" value="Update" />

				<response-code value="303" />
			</request>
			<request path="/chellow/reports/207/output/?supply_id=10&amp;year=2009">
				<response-code value="200" />
				<regex
					pattern='"10","22 1065 3921 534","CI017","Roselands","2009-04-01 00:00","2010-03-31 23:30",".*?","0","0","277.0","0","0","0","365.0","0","277.0","365.0","Actual","0","0","1666.72563177","0","1666.72563177"' />
			</request>
		</test>
		<test name="Run a scenario">
			<!-- Add a scenario -->
			<request path="/chellow/reports/315/output/" method="post">
				<control name="participant_id" value="42" /> <!-- CGEN -->
				<control name="name" value="scenario_bau" />
				<control name="start_year" value="2000" />
				<control name="start_month" value="01" />
				<control name="start_day" value="03" />
				<control name="start_hour" value="00" />
				<control name="start_minute" value="00" />
				<control name="charge_script"><![CDATA[]]></control>
				<control name="properties"><![CDATA[
{
    'bsuos' : {
		    'base_date': None,  # Date or None for latest rate script
        'multiplier': 1.5,
        'constant': 0,
    },

    'ccl': {
        'base_date': datetime(2014, 10, 1),
        'multiplier': 1,
        'constant': 0,
    },

    'aahedc': {
        'base_date': None,
        'multiplier': 0,
        'constant': 0.00091361,
    },

    'scenario_start': None,  # Date or None for this month
    'scenario_duration': 1,  # Number of months
															    
    'kw_changes':

    # MPAN Core, Date, kW
    '''
    ''',
}]]></control>
				<regex pattern="/reports/77/output/\?supplier_contract_id=64" />
				<response-code value="303" />
			</request>

			<!-- Run scenario for a site where there are no site groups -->
			<request path="/chellow/reports/247/output/?site_id=1&amp;scenario=scenario_bau">

				<response-code value="200" />
				<regex pattern='exp-supplier-problem\Z' />
			</request>

			<!-- Run scenario for a site where there are site groups -->
			<request path="/chellow/reports/247/output/?site_id=3&amp;scenario=scenario_bau">

				<response-code value="200" />
				<regex pattern='CI005' />
			</request>
		</test>

		<test name="Check BSUoS automatic import page">
			<request path="/chellow/reports/227/output/">
				<response-code value="200" />
				<regex pattern="Is Locked\?" />
			</request>
		</test>

		<test name="Check RCRC automatic import page">
			<request path="/chellow/reports/225/output/">
				<response-code value="200" />
				<regex pattern="Is Locked\?" />
			</request>
		</test>

	</test-group>
</imprimatur>
