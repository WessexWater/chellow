{% extends "base.html" %}

{% block title %}
	&raquo; Supplies &raquo; {{era.supply.id}} &raquo;
 	Era {{era.start_date|hh_format}} Edit
{% endblock %}

{% block nav %}
	<a href="/e/supplies">Supplies</a> &raquo; 
	<a href="/e/supplies/{{era.supply.id}}">{{era.supply.id}}</a> &raquo;
 	Era {{era.start_date|hh_format}} Edit
{% endblock %}

{% block content %}
	
	<table>
		<caption>Sites</caption>	
		<thead>
			<tr>
				<th>Code</th>
				<th>Name</th>
				{% if site_eras|length > 1 %}
					<th></th>
					<th></th>
					<th></th>
				{% endif %}
			</tr>
		</thead>
		<tbody>
			{% for site_era in site_eras %}
				<tr>
					<td>{{site_era.site.code}}</td>
					<td>{{site_era.site.name}}</td>
					{% if site_eras|length > 1 %}
						<td>
							{% if site_era.is_physical %}
								Located here
							{% else %}
								<form method="post" action="/e/eras/{{era.id}}/edit">
									<fieldset>
										<input type="hidden" name="site_id" value="{{site_era.site.id}}">
										<input type="submit" name="locate" value="Locate Here">
									</fieldset>
								</form>
							{% endif %}
						</td>
						<td>
							<form action="/e/eras/{{era.id}}/edit" method="post">
								<fieldset>
									<label>Detach from site</label>
									<input type="hidden" name="site_id" value="{{site_era.site.id}}">
									<input type="submit" name="detach" value="Detach">
								</fieldset>
							</form>
						</td>
					{% endif %}
				</tr>
			{% endfor %}
		</tbody>
	</table>

	<form action="/e/eras/{{era.id}}/edit" method="post">
		<fieldset>
			<legend>Attach to another site</legend>
			<label>Site Code</label> {{input_text("site_code", '')}}
			<input type="submit" name="attach" value="Attach">
		</fieldset>
	</form>
	
	<form action="/e/eras/{{era.id}}/edit" method="post">	
		<fieldset hx-get="/e/eras/{{era.id}}/edit/form" hx-params="*"
			 hx-trigger="load, change"
			 hx-include="[name='source_id'],[name='start_year'],[name='start_month'],[name='start_day'],[name='start_hour'],[name='start_minute'],[name='pc_id'],[name='name'],[name='imp_mpan_core'],[name='exp_mpan_core'],[name='mop_account'],[name='dc_account'],[name='dc_contract_id'],[name='mop_contract_id'],[name='imp_supplier_account'],[name='exp_supplier_account'],[name='imp_llfc_id'],[name='exp_llfc_id'],[name='mtc_participant_id'],[name='has_imp_mpan'],[name='has_exp_mpan'],[name='dno_id'],[name='gsp_group_id'],[name='ssc_id'],[name='cop_id'],[name='comm_id'],[name='energisation_status_id'],[name='is_ended']">
			<input type="hidden" name="source_id" value="{{request.values.source_id}}">
			<input type="hidden" name="cop_id" value="{{request.values.cop_id}}">
			<input type="hidden" name="comm_id" value="{{request.values.comm_id}}">
			<input type="hidden" name="energisation_status_id"
					value="{{era.energisation_status.id}}">
			<input type="hidden" name="pc_id" value="{{era.pc_id}}">
			<input type="hidden" name="dno_id" value="{{era.supply.dno.id}}">
			<input type="hidden" name="gsp_group_id" value="{{era.supply.gsp_group.id}}">
			<input type="hidden" name="mtc_participant_id"
		 			value="{{request.values.mtc_participant_id}}">
			<input type="hidden" name="name" value="{{request.values.name}}">
			<input type="hidden" name="mop_contract_id"
		 			value="{{request.values.mop_contract_id}}">
			<input type="hidden" name="mop_account" value="{{request.values.mop_account}}">
			<input type="hidden" name="dc_contract_id"
		 			value="{{request.values.dc_contract_id}}">
			<input type="hidden" name="dc_account" value="{{request.values.dc_account}}">
			<input type="hidden" name="has_imp_mpan" value="
				{%- if 'has_imp_mpan' in request.values -%}
					{{request.values.has_imp_mpan}}
				{%- elif era.imp_mpan_core == None -%}
					false
				{%- else -%}
					true
				{%- endif -%}">
			<input type="hidden" name="imp_mpan_core"
		 			value="{{request.values.imp_mpan_core}}">
			<input type="hidden" name="imp_supplier_account"
					value="{{request.values.imp_supplier_account}}">
			<input type="hidden" name="imp_llfc_id"
					value="{{request.values.imp_llfc_id}}">
			<input type="hidden" name="has_exp_mpan" value="{{request.values.has_exp_mpan}}">
			<input type="hidden" name="exp_mpan_core"
		 			value="{{request.values.exp_mpan_core}}">
			<input type="hidden" name="exp_supplier_account"
					value="{{request.values.exp_supplier_account}}">
			<input type="hidden" name="exp_llfc_id"
					value="{{request.values.exp_llfc_id}}">
			<input type="hidden" name="ssc_id" value="{{request.values.ssc_id}}">
			<input type="hidden" name="is_ended" value="
				{%- if era.finish_date == None -%}
					false		
				{%- else -%}
				  true
				{%- endif -%}">
		</fieldset>
	</form>
		
	{% if era.supply.eras|length > 1 %}
		<form hx-delete="/e/eras/{{era.id}}/edit"
				hx-confirm="Are you sure you want to delete this era?">
			<fieldset>
				<legend>Delete this era</legend>	
				<input type="submit" value="Delete">
			</fieldset>
		</form>
	{% endif %}

{% endblock %}
